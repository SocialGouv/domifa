<div class="head-page py-4">
  <div class="container">
    <h1 class="title">Rapports d'activité Domifa</h1>
  </div>
</div>
<div class="content">
  <div class="page-content p-4">
    <div class="container">
      <div class="row">
        <div class="col-2 form-group required">
          <label for="yearSelect">Quelle année ?</label>
          <select
            id="yearSelect"
            class="form-select"
            [(ngModel)]="metabaseParams.year"
            name="year"
          >
            <option *ngFor="let year of years" [value]="year">
              {{ year }}
            </option>
          </select>
        </div>

        <div class="col-2 form-group">
          <label for="region">Pour quelle région ?</label>
          <select
            id="region"
            class="form-select"
            [(ngModel)]="metabaseParams.region"
            (ngModelChange)="updateDepartments(); getStructures()"
            name="region"
          >
            <option [value]="null"></option>
            <option *ngFor="let region of regions" [value]="region">
              {{ REGIONS_LISTE[region] }}
            </option>
          </select>
        </div>
        <div class="col-2 form-group">
          <label for="department">Pour quel département ?</label>

          <select
            id="departement"
            class="form-select"
            [(ngModel)]="metabaseParams.department"
            (ngModelChange)="getStructures()"
            name="departement"
          >
            <option [value]="null"></option>

            <option *ngFor="let department of departments" [value]="department">
              {{ department }} -
              {{ DEPARTEMENTS_MAP[department].departmentName }}
            </option>
          </select>
        </div>
        <div class="col-2 form-group">
          <label for="structureType">Quel type de structure?</label>

          <select
            id="structureType"
            class="form-select"
            [(ngModel)]="metabaseParams.structureType"
            name="structureType"
            (ngModelChange)="getStructures()"
          >
            <option [value]="undefined"></option>

            <option
              *ngFor="let structureType of STRUCTURE_TYPE_MAP"
              [value]="structureType"
            >
              {{ STRUCTURE_TYPE_LABELS[structureType] }}
            </option>
          </select>
        </div>
        <div class="col-2 form-group">
          <label for="structure">Quelle structure ?</label>
          <select
            id="structure"
            class="form-select"
            [(ngModel)]="metabaseParams.structureId"
            name="structure"
          >
            <option [value]="null"></option>
            <option *ngFor="let structure of structures" [value]="structure.id">
              {{ structure.nom }} - {{ structure.ville }} ({{
                structure.codePostal
              }})
            </option>
          </select>
        </div>
        <div class="col-12 text-center py-3">
          <button
            class="me-2 btn btn-primary"
            [disabled]="loading"
            (click)="getMetabaseUrl()"
          >
            Afficher le rapport
          </button>

          <button
            class="me-2 btn btn-primary"
            [disabled]="loading"
            (click)="export()"
            *ngIf="metabaseParams.structureId && iframeUrl"
          >
            Télécharger le rapport de la structure (Excel)
          </button>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="iframeUrl">
    <iframe
      [src]="iframeUrl"
      frameBorder="0"
      width="100%"
      height="4600"
      allowTransparency
    ></iframe>
  </div>
</div>
