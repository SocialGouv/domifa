<div class="fr-background-alt--blue-cumulus pt-4">
  <div class="row">
    <div class="fr-container col-md-12 col-12">
      <h1 class="fr-text-title--blue-france">Gestion des utilisateurs Admin</h1>
    </div>
  </div>
</div>

<div *ngIf="me.role === 'super-admin-domifa'" class="pt-4">
  <div class="row">
    <div class="fr-container col-12 d-flex justify-content-between">
      <h2 class="fr-h5">{{ users.length }} Utilisateurs enregistrés</h2>
      <!-- TODO changer l'icone dès qu'il mettent à jour leurs icones -->
      <div>
        <button
          type="button"
          (click)="openAddUserModal()"
          class="fr-btn fr-icon-checkbox-line fr-btn--md fr-btn--icon-right fr-btn--secondary"
        >
          Ajouter un utilisateur
        </button>
      </div>
    </div>
  </div>
</div>

<div class="fr-container" *ngIf="me">
  <div class="fr-table fr-table--no-outer-border" id="table-0-component">
    <div class="fr-table__wrapper">
      <div class="fr-table__container">
        <div class="fr-table__content">
          <table [attr.aria-rowcount]="users.length">
            <caption class="visually-hidden">
              Liste des utilisateurs enregistrés
            </caption>
            <thead>
              <tr>
                <th scope="col">
                  <app-table-head-sort
                    sortKey="nom"
                    [(sortValue)]="sortValue"
                    [(currentKey)]="currentKey"
                    columnName="Nom prénom"
                  >
                  </app-table-head-sort>
                </th>
                <th scope="col">
                  <app-table-head-sort
                    sortKey="email"
                    [(sortValue)]="sortValue"
                    [(currentKey)]="currentKey"
                    columnName="Email"
                  >
                  </app-table-head-sort>
                </th>
                <th scope="col">
                  <app-table-head-sort
                    sortKey="createdAt"
                    [(sortValue)]="sortValue"
                    [(currentKey)]="currentKey"
                    columnName="Date d'inscription"
                  >
                  </app-table-head-sort>
                </th>
                <th scope="col">
                  <app-table-head-sort
                    sortKey="lastLogin"
                    [(sortValue)]="sortValue"
                    [(currentKey)]="currentKey"
                    columnName="Dernière connexion"
                  >
                  </app-table-head-sort>
                </th>
                <th scope="col">
                  <app-table-head-sort
                    sortKey="role"
                    [(sortValue)]="sortValue"
                    [(currentKey)]="currentKey"
                    columnName="Rôle"
                  >
                  </app-table-head-sort>
                </th>
                <th scope="col">Territoire d'action</th>

                <th scope="col" *ngIf="me.role === 'super-admin-domifa'"></th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="
                  let user of users | sortArray : currentKey : sortValue;
                  let i = index;
                  trackBy: userIdTrackBy
                "
                [attr.aria-rowindex]="i + 1"
              >
                <td class="fw-bold">{{ user | fullName }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.createdAt | date : "d MMMM y" }}</td>

                <td>
                  <ng-container *ngIf="user.lastLogin">
                    <p>
                      {{ user.lastLogin | date : "dd/MM/yyyy" }}
                      <b *ngIf="user.lastLogin < twoMonthsAgo">
                        <br />❌ Inactif depuis plus de 2 mois<br />
                      </b>
                    </p>
                  </ng-container>
                  <p class="fw-bold" *ngIf="!user.lastLogin">
                    ❌ Compte jamais utilisé
                  </p>
                </td>
                <td>
                  {{ USER_SUPERVISOR_ROLES_LABELS[user.role] }}
                </td>
                <td>
                  <ng-container
                    *ngIf="
                      user.role === 'super-admin-domifa' ||
                      user.role === 'national'
                    "
                  >
                    Toute la France</ng-container
                  >
                  <ng-container *ngIf="user.role === 'department'">
                    <span *ngFor="let territory of user.territories">{{
                      DEPARTEMENTS_LISTE[territory]
                    }}</span>
                  </ng-container>
                  <ng-container *ngIf="user.role === 'region'">
                    <span *ngFor="let territory of user.territories">{{
                      REGIONS_LISTE[territory]
                    }}</span>
                  </ng-container>
                </td>
                <td *ngIf="me.role === 'super-admin-domifa'">
                  <div
                    ngbDropdown
                    container="body"
                    [id]="'dropdownActionsMenuDashboard_' + user.id"
                    placement="bottom-right"
                  >
                    <button
                      type="button"
                      class="btn"
                      ngbDropdownToggle
                      [attr.aria-label]="
                        'Administrer l\'utilisateur ' +
                        user.nom +
                        ' ' +
                        user.prenom
                      "
                    >
                      <fa-icon
                        aria-hidden="true"
                        [icon]="['fas', 'bars']"
                      ></fa-icon>
                    </button>
                    <div ngbDropdownMenu>
                      <button
                        [attr.aria-label]="
                          'Modifier ' + user.nom + ' ' + user.prenom
                        "
                        (click)="openUpdateUserModal(user)"
                        class="fr-btn fr-icon-checkbox-line fr-btn--md fr-btn--icon-right fr-btn--secondar w-100"
                        ngbDropdownItem
                        type="button"
                      >
                        Modifier l'utilisateur
                      </button>

                      <button
                        *ngIf="
                          me.role === 'super-admin-domifa' &&
                          me.uuid !== user.uuid
                        "
                        class="fr-btn fr-icon-checkbox-line fr-btn--md fr-btn--icon-right fr-btn--secondar w-100"
                        ngbDropdownItem
                        (click)="openDeleteConfirmation(user)"
                        type="button"
                        [attr.aria-label]="
                          'Supprimer ' + user.nom + ' ' + user.prenom
                        "
                      >
                        Supprimer l'utilisateur
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <ng-template #addUserModal let-modal>
    <app-register-user-supervisor
      [isEditMode]="false"
      (cancel)="closeModal(); getUsers()"
    ></app-register-user-supervisor>
  </ng-template>

  <ng-template #updateUserModal let-modal>
    <app-register-user-supervisor
      [isEditMode]="true"
      (cancel)="closeModal(); getUsers()"
      [userToEdit]="selectedUser"
    ></app-register-user-supervisor>
  </ng-template>

  <ng-template #deleteUserConfirmationModal let-modal
    ><app-delete-user
      [selectedUser]="selectedUser"
      (deleteComplete)="getUsers()"
    ></app-delete-user>
  </ng-template>
</div>
