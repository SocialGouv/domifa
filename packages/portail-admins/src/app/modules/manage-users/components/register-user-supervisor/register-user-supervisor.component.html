<div>
  <p *ngIf="!isEditMode">
    <span class="fw-bold text-danger">*</span> champs obligatoires
  </p>

  <form #form *ngIf="userForm" [formGroup]="userForm" (ngSubmit)="submitUser()">
    <div class="row">
      <div
        [class.fr-input-group--error]="
          (f.nom.dirty || submitted) && f.nom.errors ? true : false
        "
        class="col-md-12 fr-input-group required mb-3"
      >
        <label class="fr-label mb-0" for="nom">Nom</label>
        <input
          type="text"
          class="fr-input"
          id="nom"
          appCleanStr
          formControlName="nom"
          name="nom"
          [ngClass]="{
            'is-invalid': (f.nom.dirty || submitted) && f.nom.errors,
            'is-valid': f.nom.dirty && !f.nom.errors
          }"
          [attr.aria-describedby]="
            (f.nom.dirty || submitted) && f.nom.errors ? 'invalid-name' : null
          "
          [attr.aria-invalid]="
            (f.nom.dirty || submitted) && f.nom.errors ? true : false
          "
          required
        />

        <div
          *ngIf="submitted && f.nom.errors"
          class="fr-messages-group"
          id="invalid-name"
          aria-live="polite"
        >
          <p class="fr-message fr-message--error" id="input-2-message-error">
            Veuillez vérifier le nom
          </p>
        </div>
      </div>

      <div
        [class.fr-input-group--error]="
          (f.prenom.dirty || submitted) && f.prenom.errors ? true : false
        "
        class="col-md-12 fr-input-group mb-3 required"
      >
        <label class="fr-label mb-0" for="prenom">Prénom</label>
        <input
          type="text"
          class="fr-input"
          id="prenom"
          appCleanStr
          formControlName="prenom"
          name="prenom"
          [ngClass]="{
            'is-invalid': (submitted || f.prenom.dirty) && f.prenom.errors,
            'is-valid': f.prenom.dirty && !f.prenom.errors
          }"
          [attr.aria-describedby]="
            (submitted || f.prenom.dirty) && f.prenom.errors
              ? 'invalid-prenom'
              : null
          "
          [attr.aria-invalid]="
            (submitted || f.prenom.dirty) && f.prenom.errors ? true : false
          "
          required
        />
        <div
          *ngIf="submitted && f.prenom.errors"
          class="fr-messages-group"
          id="invalid-prenom"
          aria-live="polite"
        >
          <p class="fr-message fr-message--error" id="input-2-message-error">
            Veuillez vérifier le prénom
          </p>
        </div>
      </div>

      <div
        [class.fr-input-group--error]="
          (f.email.dirty || submitted) && f.email.errors ? true : false
        "
        class="col-md-12 mb-3 fr-input-group required"
      >
        <label class="fr-label mb-0" for="email">Adresse email</label>
        <input
          type="email"
          class="fr-input"
          id="email"
          formControlName="email"
          name="email"
          [attr.aria-invalid]="
            (f.email.dirty || submitted) && f.email.errors ? true : false
          "
          [ngClass]="{
            'is-invalid':
              !isEditMode && (f.email.dirty || submitted) && f.email.errors,
            'is-valid': f.email.dirty && !f.email.errors
          }"
          [attr.aria-describedby]="
            (f.email.dirty || submitted) && f.email.errors
              ? 'email-errors'
              : null
          "
          required
        />
        <div
          *ngIf="(f.email.dirty || submitted) && f.email.errors"
          class="fr-messages-group"
          id="email-errors"
          aria-live="polite"
        >
          <p
            *ngIf="f.email.errors?.invalidSuperAdminEmail"
            class="fr-message fr-message--error"
          >
            Les administrateurs doivent avoir un email "fabrique.social.gouv.fr"
          </p>
          <p
            *ngIf="!f.email.errors?.invalidSuperAdminEmail"
            class="fr-message fr-message--error"
          >
            Veuillez vérifier l'adresse email, format attendu :
            nom&#64;domaine.fr
          </p>
        </div>
      </div>
      <div
        [class.fr-input-group--error]="submitted && f.role.errors"
        class="col-md-12 mb-3 fr-input-group required"
      >
        <label class="fr-label mb-0" for="role">Rôle du superviseur</label>
        <select
          id="role"
          formControlName="role"
          name="role"
          (change)="onRoleChange()"
          [ngClass]="{
            'is-invalid': submitted && f.role.errors
          }"
          [attr.aria-invalid]="submitted && f.role.errors ? true : false"
          [attr.aria-describedby]="
            submitted && f.role.errors ? 'invalid-role' : null
          "
          class="fr-select"
          required
        >
          <option [ngValue]="null"></option>
          <option
            *ngFor="let item of USER_SUPERVISOR_ROLES_LABELS | keyvalue"
            [value]="item.key"
          >
            {{ item.value }}
          </option>
        </select>
        <div
          *ngIf="submitted && f.role.errors"
          class="fr-messages-group"
          id="invalid-role"
          aria-live="polite"
        >
          <p class="fr-message fr-message--error">Le rôle est obligatoire</p>
        </div>
      </div>

      <div
        class="col-md-12 mb-3 fr-input-group required"
        *ngIf="showTerritories"
      >
        <label for="territories" class="fr-label mb-0">
          {{
            selectedRole === "department"
              ? "Département d'action"
              : "Région d'action"
          }}
        </label>

        <select
          id="territories"
          formControlName="territories"
          name="territories"
          [ngClass]="{
            'is-invalid': submitted && f.territories.errors
          }"
          [attr.aria-invalid]="submitted && f.territories.errors ? true : false"
          [attr.aria-describedby]="
            submitted && f.territories.errors ? 'invalid-territories' : null
          "
          class="fr-select"
          required
        >
          <option [value]="null"></option>
          <option
            *ngFor="
              let item of territoriesList
                | keyvalue
                | sortArray : 'value' : 'asc'
            "
            [value]="item.key"
          >
            {{
              selectedRole === "department"
                ? item.key + " - " + item.value
                : item.value
            }}
          </option>
        </select>

        <div
          *ngIf="!isEditMode && submitted && f.territories.errors"
          class="fr-messages-group"
          id="invalid-territories"
          aria-live="polite"
        >
          <p class="fr-message fr-message--error">
            Veuillez sélectionner au moins un territoire.
          </p>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="">
  <ul
    class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left"
  >
    <li>
      <button
        class="fr-btn"
        type="button"
        (click)="submitUser()"
        [disabled]="loading"
      >
        <span *ngIf="loading">
          <fa-icon
            [icon]="['fas', 'circle-notch']"
            aria-hidden="true"
            animation="spin"
          ></fa-icon>
          Veuillez patienter...
        </span>
        <span *ngIf="!loading">{{
          isEditMode
            ? "Enregistrer les modifications"
            : "Ajouter cet utilisateur"
        }}</span>
      </button>
    </li>
    <li>
      <button
        type="button"
        class="fr-btn fr-btn--secondary"
        (click)="cancel.emit()"
      >
        Annuler
      </button>
    </li>
  </ul>
</div>
