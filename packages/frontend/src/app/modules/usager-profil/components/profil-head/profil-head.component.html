@if (usager && me) {
<div class="head-page fr-p-3w">
  <div class="fr-container">
    <div
      class="fr-px-0 fr-mx-0 fr-grid-row fr-grid-row--space-between fr-grid-row--middle"
    >
      <div class="fr-px-0 fr-mx-0 fr-grid-row fr-grid-row--middle">
        <a
          [routerLink]="['/manage']"
          ariaCurrentWhenActive="page"
          class="fr-my-1w fr-px-2w fr-py-0 fr-hidden-sm fr-d-print-none"
          aria-label="Revenir à la liste des domiciliés"
          title="Revenir à la liste des domiciliés"
        >
          <span
            class="fr-icon-arrow-left-line fr-icon--lg"
            aria-hidden="true"
          ></span>
        </a>
        <h1 class="title fr-m-0">
          {{ usager | fullName }} -
          {{ usager.customRef ? usager.customRef : usager.ref }}
        </h1>
      </div>
      <div class="fr-hidden-lg fr-d-print-block">{{ me?.structure?.nom }}</div>
      @if (me?.role !== 'facteur' && me?.role !== 'agent') {
      <div class="fr-px-0 fr-mx-0 fr-text-align-right fr-d-print-none">
        @if (usager.decision.statut === 'INSTRUCTION') {
        <a
          [routerLink]="[
            '/usager/' +
              usager.ref +
              '/edit/' +
              ETAPES_DEMANDE_URL[usager.etapeDemande]
          ]"
          class="fr-my-1w fr-my-md-0 fr-btn fr-btn--secondary fr-ms-2w"
        >
          <span class="fr-icon-refresh-line fr-me-1w" aria-hidden="true"></span>
          Compléter la demande
        </a>
        } @if (usager.decision.statut === 'REFUS') {
        <button
          type="button"
          (click)="openRenewModal()"
          class="fr-my-1w fr-btn fr-btn--secondary fr-ms-2w"
        >
          <span class="fr-icon-refresh-line fr-me-1w" aria-hidden="true"></span>
          Créer une nouvelle demande
        </button>
        <button
          type="button"
          class="fr-my-1w fr-btn fr-btn--secondary fr-ms-2w"
          (click)="
            getCerfa(
              usager.decision.statut === 'REFUS'
                ? CerfaDocType.demande
                : CerfaDocType.attestation
            )
          "
        >
          <span
            class="fr-icon-download-line fr-me-1w"
            aria-hidden="true"
          ></span>
          Télécharger le CERFA
        </button>
        } @if (usager.decision.statut === 'RADIE') {
        <button
          type="button"
          class="fr-my-1w fr-my-md-0 fr-btn fr-btn--secondary fr-ms-2w"
          (click)="openRenewModal()"
        >
          <span class="fr-icon-refresh-line fr-me-1w" aria-hidden="true"></span>
          Créer une nouvelle demande
        </button>
        } @if (usager.decision.statut === 'VALIDE') {
        <button
          type="button"
          class="fr-my-1w fr-my-md-0 fr-btn fr-btn--secondary fr-ms-2w"
          (click)="openRenewModal()"
        >
          <span class="fr-icon-refresh-line fr-me-1w" aria-hidden="true"></span>
          Demande de renouvellement
        </button>

        <app-decision-radiation-form
          [usager]="usager"
          context="PROFIL"
          (closeModals)="closeModals()"
        ></app-decision-radiation-form>
        }
      </div>
      }
    </div>
  </div>
</div>

<div class="fr-container">
  <div class="fr-tabs fr-mt-4w fr-d-print-none">
    <ul class="fr-tabs__list" role="tablist" aria-label="Navigation du profil">
      <li role="presentation">
        <a
          [routerLink]="['/profil/general/' + usager.ref]"
          [class.fr-tabs__tab--selected]="section === 'general'"
          class="fr-tabs__tab"
          role="tab"
          [attr.aria-selected]="section === 'general'"
        >
          Vue d'ensemble
        </a>
      </li>
      <li role="presentation">
        <a
          [routerLink]="['/profil/dossier/' + usager.ref]"
          [class.fr-tabs__tab--selected]="section === 'dossier'"
          class="fr-tabs__tab"
          role="tab"
          [attr.aria-selected]="section === 'dossier'"
        >
          Dossier
        </a>
      </li>
      <li role="presentation">
        <a
          [routerLink]="['/profil/courriers/' + usager.ref]"
          [class.fr-tabs__tab--selected]="section === 'courrier'"
          class="fr-tabs__tab"
          role="tab"
          [attr.aria-selected]="section === 'courrier'"
        >
          Procurations et transferts
        </a>
      </li>
      <li role="presentation">
        <a
          [routerLink]="
            me?.role !== 'facteur' ? ['/profil/documents/' + usager.ref] : null
          "
          (click)="goToDocuments()"
          [class.fr-tabs__tab--selected]="section === 'documents'"
          class="fr-tabs__tab"
          role="tab"
          [attr.aria-selected]="section === 'documents'"
        >
          Documents @if (me?.role === 'facteur') {
          <span class="fr-badge fr-badge--sm">, accès restreint</span>
          }
        </a>
      </li>
      <li role="presentation">
        <a
          [routerLink]="['/profil/sms/' + usager.ref]"
          [class.fr-tabs__tab--selected]="section === 'sms'"
          class="fr-tabs__tab"
          role="tab"
          [attr.aria-selected]="section === 'sms'"
        >
          SMS et Mon DomiFa
        </a>
      </li>
      <li role="presentation">
        <a
          [routerLink]="['/profil/historique/' + usager.ref + '/interactions']"
          [class.fr-tabs__tab--selected]="section === 'historique'"
          class="fr-tabs__tab"
          role="tab"
          [attr.aria-selected]="section === 'historique'"
        >
          Historique
        </a>
      </li>
    </ul>
  </div>
</div>
}

<ng-template #renewModal let-modal>
  <div class="modal-header bg-primary">
    <span
      class="text-white"
      id="modal-title"
      *ngIf="
        usager.decision.statut !== 'RADIE' && usager.decision.statut !== 'REFUS'
      "
    >
      Demande de renouvellement
    </span>
    <span
      class="text-white"
      id="modal-title"
      *ngIf="
        usager.decision.statut === 'RADIE' || usager.decision.statut === 'REFUS'
      "
    >
      Nouvelle demande de domiciliation
    </span>
  </div>

  <div class="modal-body py-4 text-center">
    <p
      *ngIf="
        usager.decision.statut !== 'RADIE' && usager.decision.statut !== 'REFUS'
      "
    >
      Si vous commencez un renouvellement,
      <br />
      <strong> ce dossier ne sera plus considéré comme "actif". </strong>
    </p>
    <p *ngIf="usager.decision.statut === 'RADIE'">
      Si vous commencez une nouvelle demande,
      <b> ce dossier ne sera plus comptabilisé parmi les radiés. </b>
    </p>
    <p *ngIf="usager.decision.statut === 'REFUS'">
      Si vous créez une nouvelle demande,
      <br />
      <b> ce dossier ne sera plus comptabilisé parmi les refusés. </b>
    </p>
    <p>
      Afin de le retrouver dans la liste, vous devrez cliquer sur le filtre "À
      compléter"
    </p>
  </div>

  <div class="modal-footer">
    <button
      type="submit"
      class="fr-btn"
      (click)="renouvellement()"
      [disabled]="loading"
      [attr.aria-busy]="loading"
    >
      <ng-container *ngIf="!loading">
        <span
          *ngIf="
            usager.decision.statut !== 'RADIE' &&
            usager.decision.statut !== 'REFUS'
          "
        >
          Demander un renouvellement
        </span>
        <span
          *ngIf="
            usager.decision.statut === 'RADIE' ||
            usager.decision.statut === 'REFUS'
          "
        >
          Créer une nouvelle demande
        </span>
      </ng-container>
      <span *ngIf="loading"
        ><fa-icon
          [icon]="['fas', 'circle-notch']"
          aria-hidden="true"
          animation="spin"
        >
        </fa-icon>
        Veuillez patienter...</span
      >
    </button>
    <button
      class="btn-lg btn-outline-dark"
      type="button"
      (click)="closeModals()"
    >
      Revenir au profil
    </button>
  </div>
</ng-template>
