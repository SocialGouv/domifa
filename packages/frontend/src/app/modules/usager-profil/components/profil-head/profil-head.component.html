<div *ngIf="usager && me" class="head-page">
  <div class="container">
    <div class="row d-flex align-items-center">
      <div class="col-4">
        <span class="title" [class]="usager.statutColor">
          <a [routerLink]="['/manage']"
            ><fa-icon icon="arrow-circle-left"></fa-icon
          ></a>
          <span class="statut-signal"></span>
          {{ usager | usagerNomComplet }} -
          <b *ngIf="usager.customRef">{{ usager.customRef }}</b>
          <b *ngIf="!usager.customRef">{{ usager.ref }}</b>
        </span>
      </div>

      <div class="col-8 text-right">
        <ng-container *ngIf="usager.decision.statut === 'REFUS'">
          <button *ngIf="!isRole('facteur')" class="btn btn-white-primary mr-2">
            <fa-icon icon="redo" class="mr-2"></fa-icon>
            Créer une nouvelle demande
          </button>
          <button class="btn btn-white-primary">
            <fa-icon icon="download"></fa-icon>
            Télécharger le CERFA
          </button>
        </ng-container>

        <ng-container *ngIf="usager.decision.statut === 'RADIE'">
          <button class="btn btn-white-primary mr-2">
            <fa-icon icon="redo" class="mr-2"></fa-icon>
            Créer une nouvelle demande
          </button>
        </ng-container>

        <ng-container *ngIf="usager.decision.statut === 'VALIDE'">
          <button class="btn btn-white-primary mr-2">
            <fa-icon icon="plus" class="mr-2"></fa-icon>
            Nouveau courrier
          </button>
          <button class="btn btn-white-primary mr-2" (click)="openRenewModal()">
            <fa-icon icon="redo" class="mr-2"></fa-icon>
            Demande de renouvellement
          </button>
          <a
            [routerLink]="['/radiation/' + usager.ref]"
            routerLinkActive="router-link-active"
            class="btn btn-white-primary"
          >
            <fa-icon icon="times" class="mr-2"></fa-icon>
            Radier le domicilié
          </a>
        </ng-container>
      </div>
    </div>

    <div id="statut-selector" class="mt-4 row">
      <a
        class="col selected-statut"
        [routerLink]="['/profil/general/' + usager.ref]"
        ><span class="statut-label"> Vue d'ensemble</span></a
      >

      <a
        class="col selected-statut"
        [routerLink]="['/profil/courriers/' + usager.ref]"
        ><span class="statut-label"> Courriers</span></a
      >

      <a
        class="col selected-statut"
        [routerLink]="['/profil/dossier/' + usager.ref]"
        ><span class="statut-label"> Dossier</span></a
      >

      <a
        class="col selected-statut"
        [routerLink]="['/profil/historique/' + usager.ref]"
        ><span class="statut-label"> Historique</span></a
      >
    </div>
  </div>
</div>
<div class="content">
  <div class="container p-0">
    <div class="page-content px-4 pt-3">
      <div class="row">
        <!-- INFOS LIÉS AU STATUT -->
        <div class="col-md-12">
          <div
            class="alert alert-danger"
            *ngIf="usager.decision.statut === 'RADIE'"
          >
            <div class="svg-icon icon-danger"></div>

            <div>
              Cette personne a été radiée le
              {{ usager.decision.dateDecision | date: "dd/MM/yyyy" }}
              : {{ usager.decision.motifString }}
            </div>
          </div>
          <div
            class="alert alert-danger"
            *ngIf="usager.decision.statut === 'REFUS'"
          >
            <div class="svg-icon icon-danger"></div>
            <div class="text-danger">
              Demande refusée le
              {{ usager.decision.dateDecision | date: "dd/MM/yyyy" }}
              : {{ usager.decision.motif }}
            </div>
          </div>

          <div
            class="alert alert-warning"
            *ngIf="
              usager.decision.statut === 'INSTRUCTION' &&
              usager.typeDom === 'RENOUVELLEMENT' &&
              !isRole('facteur')
            "
          >
            <div class="svg-icon icon-calendar"></div>
            <span>
              Demande de renouvellement est actuellement en cours &nbsp;
              <a [routerLink]="['/usager/' + usager.ref + '/edit']">
                Compléter la demande
              </a>
            </span>
          </div>

          <div
            class="alert alert-info"
            *ngIf="
              usager.decision.statut === 'ATTENTE_DECISION' &&
              usager.typeDom === 'RENOUVELLEMENT'
            "
          >
            <div class="svg-icon icon-calendar"></div>
            <div>
              Cette demande de renouvellement est actuellement en attente d'une
              décision
            </div>
            <div>
              <a
                [routerLink]="['/usager/' + usager.ref + '/edit']"
                class="btn btn-light"
              >
                <fa-icon icon="redo" class="mr-2"></fa-icon>
                Voir le récapitulatif
              </a>
            </div>
          </div>
        </div>

        <div class="col-md-12">
          <div
            class="alert"
            [ngClass]="{
              'alert-danger': usager.dayBeforeEnd <= 15,
              'alert-warning': usager.dayBeforeEnd > 15
            }"
            *ngIf="usager.dayBeforeEnd > 0 && usager.dayBeforeEnd < 60"
          >
            <div class="svg-icon icon-distribution"></div>
            <span>
              La domiciliation expire le
              <b>
                {{ usager.dateToDisplay | date: "dd/MM/yyyy" }}
              </b>
            </span>
          </div>
          <div class="alert alert-danger" *ngIf="usager.dayBeforeEnd < 0">
            <div class="svg-icon icon-danger"></div>
            <div>
              Domiciliation expirée depuis le
              <b>
                {{ usager.decision.dateFin | date: "dd/MM/yyyy" }}, il y a
                {{ usager.dayBeforeEnd * -1 }} jours
              </b>
            </div>
          </div>
        </div>

        <!-- COURRIERS -->
        <div class="col-md-12">
          <!-- NPAI -->
          <div *ngIf="usager.options.npai.actif" class="alert alert-danger">
            <fa-icon icon="ban" size="2x" class="text-danger mr-3"></fa-icon>
            <span>
              N'habite plus à l'adresse indiquée, pli non distribuable
            </span>
          </div>

          <!-- TRANSFERT -->
          <div
            *ngIf="
              usager.options.transfert.actif &&
              usager.options.transfert.dateFin <= today
            "
            class="alert alert-danger"
          >
            <div class="svg-icon icon-distribution"></div>
            <span
              ><b>Attention : </b> le transfert de courrier était valable
              jusqu'au
              {{ usager.options.transfert.dateFin | date: "dd/MM/yyyy" }}</span
            >
          </div>

          <div
            *ngIf="usager.options.transfert.dateFin > today"
            class="alert alert-warning"
          >
            <div class="svg-icon icon-distribution"></div>
            <span>
              Le courrier est à transférer à l'adresse suivante :
              {{ usager.options.transfert.nom | titlecase }}
              {{ usager.options.transfert.adresse | titlecase }}
            </span>
          </div>
          <div
            class="alert alert-warning"
            *ngIf="
              usager.options.procuration.actif &&
              usager.options.procuration.dateFin > today
            "
          >
            <div class="svg-icon icon-distribution"></div>

            <span>
              Une procuration au nom de
              <b
                >{{ usager.options.procuration.nom }}
                {{ usager.options.procuration.prenom }}</b
              >
              est active et valable jusqu'au
              {{ usager.options.procuration.dateFin | date: "dd/MM/yyyy" }}
            </span>
          </div>

          <div
            *ngIf="
              usager.options.procuration.actif &&
              usager.options.procuration.dateFin <= today
            "
            class="alert alert-danger"
          >
            <span class="svg-icon icon-calendar"></span>
            <span>
              La procuration au nom de {{ usager.options.procuration.nom
              }}{{ usager.options.procuration.prenom }}
              <b
                >a expiré le
                {{ usager.options.procuration.dateFin | date: "dd/MM/yyyy" }}</b
              >
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #setInteractionInModal let-modal>
  <app-set-interaction-in-form
    [(usager)]="usager"
    (cancelReception)="closeModals()"
  ></app-set-interaction-in-form>
</ng-template>

<ng-template #setInteractionOutModal let-modal>
  <app-set-interaction-out-form
    [(usager)]="usager"
    (cancelReception)="closeModals()"
  ></app-set-interaction-out-form>
</ng-template>

<ng-template #renewModal let-modal>
  <div class="modal-header bg-primary">
    <h4 class="text-white modal-title" id="modal-title">
      Demande de renouvellement
    </h4>
    <button
      type="button"
      class="close"
      aria-describedby="modal-title"
      (click)="closeModals()"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body py-4 text-center">
    <p
      *ngIf="
        usager.decision.statut !== 'RADIE' && usager.decision.statut !== 'REFUS'
      "
    >
      Si vous commencez un renouvellement,
      <br />
      <b> ce dossier ne sera plus considéré comme "actif". </b>
    </p>
    <p *ngIf="usager.decision.statut === 'RADIE'">
      Si vous commencez une nouvelle demande,
      <br />
      <b> ce dossier ne sera plus comptabilisé parmi les radiés. </b>
    </p>
    <p *ngIf="usager.decision.statut === 'REFUS'">
      Si vous créez une nouvelle demande,
      <br />
      <b> ce dossier ne sera plus comptabilisé parmi les refusés. </b>
    </p>
    Afin de le retrouver dans la liste, vous devrez cliquer sur le filtre "À
    compléter"
  </div>

  <div class="modal-footer">
    <button class="btn btn-outline-dark" (click)="closeModals()">
      Revenir au profil
    </button>
    <button class="btn btn-primary" (click)="renouvellement()">
      Demander un renouvellement
    </button>
  </div>
</ng-template>
