<div class="fr-content-container-light">
  @if (me) {
  <app-profil-head
    [usager]="usager"
    [section]="section"
    [me]="me"
  ></app-profil-head>
  } @if (usager) {
  <div class="fr-container">
    <div class="fr-content">
      <app-profil-alerts [usager]="usager" [me]="me"></app-profil-alerts>

      <div class="fr-grid-row fr-pb-5">
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-grid-row">
            <div class="fr-col-12">
              <h2 class="fr-h4">
                <i
                  class="fr-icon-folder-2-line fr-text-title--blue-france"
                  aria-hidden="true"
                ></i>
                Dossier
              </h2>
            </div>

            <div class="fr-col-6 fr-my-1">
              <span class="label">Date de naissance</span>
            </div>

            <div class="fr-col-6 fr-my-1">
              {{ usager.dateNaissance | date : "dd/MM/yyyy" }}
            </div>

            <div class="fr-col-6 fr-my-1">
              <span class="label">Référence dossier</span>
            </div>

            <div class="fr-col-6 fr-my-1">
              {{ usager.customRef }}
            </div>

            <div class="fr-col-6 fr-my-1">
              <span class="label">Statut</span>
            </div>
            <div class="fr-col-6 fr-my-1">
              <div [class]="'label-info ' + usager.statusInfo.color">
                <span>
                  {{ USAGER_DECISION_STATUT_LABELS[usager.decision.statut] }}
                </span>
              </div>
            </div>

            <div class="fr-col-6 fr-my-1">
              <span class="label">Type de domiciliation</span>
            </div>
            <div class="fr-col-6 fr-my-1">
              @if (usager.typeDom === 'RENOUVELLEMENT') {
              <div class="label-info orange-status">
                <span>Renouvellement</span>
              </div>
              } @if (usager.typeDom === 'PREMIERE_DOM') {
              <div class="label-info grey-status">
                <span>Première demande</span>
              </div>
              }
            </div>
            <div class="fr-col-6 fr-my-1">
              <span class="label">Échéance</span>
            </div>
            <div class="fr-col-6 fr-my-1">
              {{ usager?.echeanceInfos?.dateToDisplay | date : "dd MMMM yyyy" }}
            </div>
            <div class="fr-col-6 fr-my-1">
              <span class="label">Dernier passage</span>
            </div>
            <div class="fr-col-6 fr-my-1">
              {{
                usager.lastInteraction.dateInteraction | date : "dd MMMM yyyy"
              }}
            </div>

            <div class="fr-col-6 fr-my-1">
              <span class="label">Première domiciliation</span>
            </div>
            <div class="fr-col-6 fr-my-1">
              {{ usager.datePremiereDom | date : "dd MMMM yyyy" }}
            </div>

            <div class="fr-col-6 fr-my-1">
              <span class="label">Ayants droit</span>
            </div>
            <div class="fr-col-6 fr-my-1">
              <app-display-ayants-droits
                [usager]="usager"
              ></app-display-ayants-droits>
            </div>
            <div class="fr-col-6 fr-my-1">
              <span class="label">Référent du dossier</span>
            </div>
            <div class="fr-col-6 fr-my-1">
              {{ usager.referrerId | referrerName | async }}
            </div>
            <div class="fr-col-12 fr-mt-4">
              <a
                [routerLink]="['/profil/dossier/' + usager.ref]"
                ariaCurrentWhenActive="page"
              >
                Voir le dossier complet
              </a>
            </div>
          </div>
        </div>

        <div class="fr-col-12 fr-col-md-6">
          <h2 class="fr-h4">
            <i
              class="fr-icon-mail-line fr-text-title--blue-france"
              aria-hidden="true"
            ></i>
            Courrier en attente
          </h2>
          <div class="profil-interaction fr-my-3">
            <div class="interaction-icon-box fr-me-3">
              <div class="interaction-icon icon-courrier"></div>
            </div>
            <p>
              <strong>{{ usager.lastInteraction.courrierIn }}</strong> courriers
            </p>
          </div>
          <div class="profil-interaction fr-my-3">
            <div class="interaction-icon-box fr-me-3">
              <div class="interaction-icon icon-colis"></div>
            </div>
            <p>
              <strong>{{ usager.lastInteraction.colisIn }}</strong> colis
            </p>
          </div>
          <div class="profil-interaction fr-my-3">
            <div class="interaction-icon-box fr-me-3">
              <div class="interaction-icon icon-recommande"></div>
            </div>
            <p>
              <strong>{{ usager.lastInteraction.recommandeIn }}</strong> avis de
              passage
            </p>
          </div>

          @if ( usager?.echeanceInfos?.isActif || (usager.decision.statut ===
          'RADIE' && !usager.options.npai.actif) ) { @if
          (usager?.echeanceInfos?.isActif) {
          <div class="fr-d-flex fr-align-items-center">
            <button
              type="button"
              [disabled]="loadingButtons.indexOf('visite') !== -1"
              [attr.aria-disabled]="loadingButtons.indexOf('visite') !== -1"
              class="fr-my-1 fr-me-2 fr-btn"
              (click)="setSingleInteraction(usager.ref, 'visite')"
            >
              <fa-icon
                [icon]="['fas', 'circle-notch']"
                animation="spin"
                class="list-icon-disabled"
                aria-hidden="true"
              ></fa-icon>
              <span class="icon-passage list-icon fr-me-2"></span>Ajouter un
              passage
            </button>

            <button
              type="button"
              [disabled]="loadingButtons.indexOf('appel') !== -1"
              [attr.aria-disabled]="loadingButtons.indexOf('appel') !== -1"
              class="fr-my-1 fr-btn fr-me-2"
              (click)="setSingleInteraction(usager.ref, 'appel')"
            >
              <fa-icon
                class="list-icon-disabled"
                [icon]="['fas', 'circle-notch']"
                aria-hidden="true"
                animation="spin"
              >
              </fa-icon>
              <span class="icon-appel list-icon fr-me-2"></span>Ajouter un appel
              téléphonique
            </button>
          </div>
          }
          <br />

          <button
            type="button"
            class="fr-my-1 fr-btn fr-me-2"
            (click)="openInteractionInModal()"
          >
            <span
              class="icon-reception list-icon fr-me-2"
              aria-hidden="true"
            ></span>
            Ajouter du courrier
          </button>

          @if (usager.lastInteraction.enAttente) {
          <button
            type="button"
            class="fr-my-1 fr-btn fr-me-2"
            (click)="openInteractionOutModal()"
          >
            <span
              class="icon-distribution list-icon fr-me-2"
              aria-hidden="true"
            ></span>
            Distribuer le courrier
          </button>
          } }
          <app-set-npai [usager]="usager"></app-set-npai>
        </div>
      </div>

      <hr />

      <div class="fr-grid-row fr-mt-3">
        <div class="fr-col-12 fr-col-md-6 fr-mb-3">
          <h2 class="fr-h4">
            <img
              src="assets/dsfr-pictograms/document/archive.svg"
              aria-hidden="true"
              alt=""
            />
            Historique des courriers
          </h2>
          <app-profil-general-historique-courriers
            [usager]="usager"
            [me]="me"
            (updateInteractions)="updateInteractions()"
          ></app-profil-general-historique-courriers>
          <br />
          <a
            class="fr-my-4"
            [routerLink]="[
              '/profil/historique/' + usager.ref + '/interactions'
            ]"
            ariaCurrentWhenActive="page"
          >
            Voir tout l'historique
          </a>
        </div>

        <div class="fr-col-12 fr-col-md-6">
          <h2 class="fr-h4">
            <img
              src="assets/dsfr-pictograms/leisure/community.svg"
              aria-hidden="true"
              alt=""
            />
            Notes
          </h2>

          <app-profil-general-notes
            [me]="me"
            [usager]="usager"
          ></app-profil-general-notes>
        </div>
      </div>
    </div>
    @if (displayDeleteButton) {
    <app-delete-usager-menu
      context="PROFIL"
      [usager]="usager"
      [me]="me"
    ></app-delete-usager-menu>
    }
  </div>
  }
</div>

<ng-template #setInteractionInModal let-modal>
  <app-set-interaction-in-form
    [usager]="usager"
    (cancelReception)="closeModals()"
    (updateInteractions)="updateInteractions()"
  ></app-set-interaction-in-form>
</ng-template>

<ng-template #setInteractionOutModal let-modal>
  <app-set-interaction-out-form
    [usager]="usager"
    (cancelReception)="closeModals()"
    (updateInteractions)="updateInteractions()"
  ></app-set-interaction-out-form>
</ng-template>
