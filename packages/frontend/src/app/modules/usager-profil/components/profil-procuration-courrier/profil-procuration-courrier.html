<div class="d-print-none" *ngIf="usager && me">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Procurations {{ usager.decision.statut}}</h4>

    <div *ngIf="usager.decision.statut !== 'REFUS'">
      <button (click)="showForm()" class="btn btn-outline-dark ml-2">
        Modifier les procurations
      </button>
      <button
        title="Annuler les modifications"
        *ngIf="isFormVisible"
        (click)="hideForm()"
        class="btn btn-outline-dark ml-2"
      >
        <fa-icon [icon]="['fas', 'times']" class="mr-2"></fa-icon>
        Annuler les modifications
      </button>
    </div>
  </div>

  <div
    class="row"
    *ngIf="usager.options.procurations.length === 0 && !isFormVisible"
  >
    <p class="col-md-6 reponses">
      <span class="question">Il n'y a aucune procuration actuellement.</span>
    </p>
  </div>

  <ng-container *ngIf="usager.options.procurations.length > 0">
    <ng-container *ngFor="let procuration of usager.options.procurations">
      <div *ngIf=" procuration.actif && !isFormVisible" class="row">
        <div class="col-md-2 reponses">
          <span class="question">Nom</span>
          <span class="valeur"> {{ procuration.nom | uppercase }} </span>
        </div>
        <div class="col-md-2 reponses">
          <span class="question">Prénom</span>
          <span class="valeur"> {{ procuration.prenom }} </span>
        </div>
        <div class="col-md-3 reponses">
          <span class="question">Date de naissance</span>
          <span class="valeur">
            {{ procuration.dateNaissance | date: 'dd/MM/yyyy' }}
          </span>
        </div>

        <div class="col-md-3 reponses">
          <span class="question">Dates de validité</span>
          <span class="valeur" *ngIf="procuration.dateDebut === null">
            {{ procuration.dateFin | date: 'dd/MM/yyyy' }}
          </span>
          <span class="valeur" *ngIf="procuration.dateDebut">
            Du {{ procuration.dateDebut | date: 'dd/MM/yyyy' }} au {{
            procuration.dateFin | date: 'dd/MM/yyyy' }}
          </span>
        </div>
      </div>
    </ng-container>
  </ng-container>

  <form
    *ngIf="isFormVisible"
    [formGroup]="procurationsForm"
    (ngSubmit)="editProcuration()"
    autocomplete="off"
  >
    <div
      formArrayName="procurations"
      *ngFor="let procuration of form.controls; let i = index"
    >
      <div class="row">
        <div class="col-md-3 form-group required">
          <label for="procuration_nom">Nom</label>
          <input
            type="text"
            class="form-control"
            id="procuration_nom"
            formControlName="nom"
            [ngClass]="{ 'is-invalid': submitted && form.controls[i].get('nom').errors }"
            required
          />
          <p
            *ngIf="submitted && form.controls[i].get('nom').errors"
            class="invalid-feedback"
          >
            Le nom est obligatoire
          </p>
        </div>
        <div class="col-md-3 form-group required">
          <label for="procuration_prenom">Prénom</label>
          <input
            type="text"
            class="form-control"
            id="procuration_prenom"
            formControlName="prenom"
            [ngClass]="{ 'is-invalid': submitted && form.controls[i].get('prenom').errors }"
            required
          />
          <p
            *ngIf="submitted && form.controls[i].get('prenom').errors"
            class="invalid-feedback"
          >
            Prénom obligatoire
          </p>
        </div>
        <div class="col-md-2 form-group required">
          <label for="dateNaissance">Date de naissance</label>
          <div class="input-group">
            <input
              class="form-control"
              placeholder="jj/mm/aaaa"
              [minDate]="minDateNaissance"
              [maxDate]="maxDateNaissance"
              placement="bottom"
              formControlName="dateNaissance"
              ngbDatepicker
              dateFr
              value
              id="dateNaissance"
              [ngClass]="{ 'is-invalid':  form.controls[i].get('dateNaissance').dirty &&  form.controls[i].get('dateNaissance').errors  }"
              #d="ngbDatepicker"
              maxlength="10"
              required
            />
            <div class="input-group-append">
              <button
                type="button"
                class="btn btn-outline-primary"
                (click)="d.toggle()"
                aria-label="Choisir une date de naissance"
              >
                <fa-icon [icon]="['fas', 'calendar']"></fa-icon>
              </button>
            </div>

            <p
              *ngIf="form.controls[i].get('dateNaissance').dirty && form.controls[i].get('dateNaissance').invalid"
              class="invalid-feedback"
            >
              La date de naissance est incorrecte (ex: 20/12/1991)
            </p>
          </div>
        </div>
        <div class="col-md-2 form-group required">
          <label for="dateDebut">Date début de validité</label>
          <div class="input-group">
            <input
              class="form-control"
              placeholder="jj/mm/aaaa"
              placement="bottom"
              formControlName="dateDebut"
              ngbDatepicker
              dateFr
              value
              id="dateDebut"
              [ngClass]="{ 'is-invalid': submitted &&  form.controls[i].get('dateDebut').errors }"
              #dateDebutPro="ngbDatepicker"
              maxlength="10"
              required
              aria-required="true"
            />
            <div class="input-group-append">
              <button
                type="button"
                class="btn btn-outline-primary"
                (click)="dateDebutPro.toggle()"
              >
                <fa-icon [icon]="['fas', 'calendar']"></fa-icon>
              </button>
            </div>

            <p
              *ngIf="submitted &&  form.controls[i].get('dateDebut').invalid"
              class="invalid-feedback"
            >
              La date de début est incorrecte (ex: 20/12/1991)
            </p>
          </div>
        </div>
        <div class="col-md-2 form-group required">
          <label for="dateFin">Date de fin de validité</label>
          <div class="input-group">
            <input
              class="form-control"
              placeholder="jj/mm/aaaa"
              placement="bottom"
              formControlName="dateFin"
              ngbDatepicker
              dateFr
              value
              id="dateFin"
              [minDate]="minDateToday"
              [ngClass]="{ 'is-invalid': form.controls[i].get('dateFin').dirty &&  form.controls[i].get('dateFin').errors }"
              #dateFinProcu="ngbDatepicker"
              maxlength="10"
              required
            />
            <div class="input-group-append">
              <button
                type="button"
                class="btn btn-outline-primary"
                (click)="dateFinProcu.toggle()"
              >
                <fa-icon [icon]="['fas', 'calendar']"></fa-icon>
              </button>
            </div>

            <p *ngIf="form.controls[i].get('dateFin').invalid">
              La date de fin est incorrecte
            </p>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!--
    <div class="row">
      <div class="col-3 offset-3 text-center">
        <span
          (click)="deleteProcuration()"
          class="btn btn-block btn-danger mr-2"
        >
          <fa-icon
            title="Supprimer la procuration"
            [icon]="['fas', 'trash']"
          ></fa-icon>
          Supprimer la procuration
        </span>
      </div>
      <div class="col-3 text-center">
        <button
          class="btn btn-block btn-primary"
          type="submit"
          [disabled]="!procurationsForm.valid"
        >
          Enregistrer la procuration
        </button>
      </div>
    </div> -->

  <ng-container *ngIf="usager.options.historique.procuration.length > 0">
    <div class="row">
      <div class="col-md-12">
        <h4>Historique des procurations</h4>

        <table class="table table-hover">
          <caption>
            Historique des procurations
          </caption>
          <thead>
            <tr>
              <th scope="col">Action</th>
              <th scope="col">Nom prénom</th>
              <th scope="col">Date de naissance</th>
              <th scope="col">Période de validité</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let procu of usager.options.historique.procuration">
              <td>
                {{ actions[procu.action] }} le {{ procu.date | date:
                'dd/MM/yyyy' }} par {{ procu.user }}
              </td>
              <td>{{ procu.content?.nom }} {{ procu.content?.prenom }}</td>
              <td>
                {{ procu.content?.dateNaissance | date: 'dd/MM/yyyy' || "" }}
              </td>
              <td>
                <span *ngIf="procu.content?.dateDebut === null">
                  {{ procu.content?.dateFin | date: 'dd/MM/yyyy' }}
                </span>
                <span class="valeur" *ngIf="procu.content?.dateDebut">
                  Du {{ procu.content?.dateDebut | date: 'dd/MM/yyyy' }} au {{
                  procu.content?.dateFin | date: 'dd/MM/yyyy' }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </ng-container>
</div>
