<div id="rapport" class="container text-left">
  <div class="row">
    <div class="col-md-12">
      <br />
      <h1>Rapport d'activité de votre structure</h1>
      <br />
      <div>
        Cet item vous permettra de remplir votre obligation légale et
        réglementaire (Article L 264-8 et Article D 264-8 du code de l'action
        sociale et des familles) de transmission annuelle au préfet de
        département de votre rapport d’activité de domiciliation.
        <br />
        <br />Il vous permettra aussi d’assurer le suivi et le pilotage de votre
        activité.<br /><br />
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-3">
      <div class="form-group required">
        <div class="input-group">
          <label class="control-label">Du </label>
          <input
            class="form-control"
            placeholder="jj/mm/aaaa"
            [minDate]="minDate"
            [maxDate]="maxDate"
            placement="bottom"
            ngbDatepicker
            id="dateDebutValide"
            outsideDays="hidden"
            [(ngModel)]="fromDate"
            #dDebut="ngbDatepicker"
            #ca="ngModel"
            (dateSelect)="changeStart($event)"
            dateFr
            value
            ngModel
            [ngClass]="{
              'is-invalid': ca.status === 'INVALID'
            }"
            maxlength="10"
            required
          />
          <div class="input-group-append">
            <span class="btn btn-outline-primary" (click)="dDebut.toggle()">
              <fa-icon icon="calendar"></fa-icon>
            </span>
          </div>
        </div>
      </div>
      <div class="text-danger" *ngIf="ca.status === 'INVALID'">
        La date de début est incorrecte
      </div>
    </div>
    <div class="col-3">
      <div class="form-group">
        <div class="input-group">
          <label class="control-label" for="dateFinValide"> au </label>
          <input
            class="form-control"
            placeholder="jj/mm/aaaa"
            [minDate]="minDateFin"
            [maxDate]="maxDateFin"
            placement="bottom"
            ngbDatepicker
            [(ngModel)]="toDate"
            #dFin="ngbDatepicker"
            (dateSelect)="changeEnd($event)"
            #cb="ngModel"
            dateFr
            ngModel
            [readonly]="ca.status === 'INVALID'"
            id="dateFinValide"
            value
            [ngClass]="{
              'is-invalid': cb.status === 'INVALID',
              disabled: ca.status === 'INVALID'
            }"
            maxlength="10"
          />
          <div class="input-group-append">
            <span class="btn btn-outline-primary" (click)="dFin.toggle()">
              <fa-icon icon="calendar"></fa-icon>
            </span>
          </div>
        </div>
      </div>

      <div class="text-center text-danger" *ngIf="cb.status === 'INVALID'">
        La date de fin est incorrecte
      </div>
    </div>
    <div class="col-3 form-group">
      <div class="input-group">
        <button
          class="btn btn-primary"
          [disabled]="ca.status === 'INVALID' || cb.status === 'INVALID'"
          (click)="compare()"
        >
          <fa-icon icon="sync-alt" class="btn-icon"></fa-icon>
          Actualiser les statistiques
        </button>
      </div>
    </div>
    <div class="col-3" *ngIf="start !== null">
      <button
        (click)="export()"
        [disabled]="exportLoading"
        class="btn btn-primary"
      >
        <span *ngIf="!exportLoading">
          <fa-icon icon="download" class="btn-icon"></fa-icon>
          Exporter les statistiques</span
        >
        <span *ngIf="exportLoading"
          ><fa-icon icon="circle-notch" [spin]="true"> </fa-icon> Export en
          cours, veuillez patienter...</span
        >
      </button>
    </div>
  </div>

  <div class="col-md-12" *ngIf="start !== null">
    <br />
    <h4>
      1. Domiciliés par statut
      <span *ngIf="end !== null">
        du {{ start | date: "dd/MM/yyyy" }} au
        {{ end | date: "dd/MM/yyyy" }}
      </span>
      <span *ngIf="end === null">
        du 01/01/2020 au
        {{ start | date: "dd/MM/yyyy" }}
      </span>
    </h4>
    Astuce: pour avoir des statistiques sur une date précise, la date de fin
    sera prise en compte
    <div class="rapport-part">
      <table class="table table-hover">
        <tbody>
          <tr>
            <td class="font-weight-bold">
              Total des domiciliés actifs + leurs ayants-droit
            </td>
            <td>
              {{ stats.questions.Q_11.VALIDE_TOTAL }}
            </td>
          </tr>
          <tr>
            <td class="soustable">Nombre de domiciliés</td>
            <td>{{ stats.questions.Q_11.VALIDE }}</td>
          </tr>
          <tr>
            <td class="soustable">Nombre d'ayants-droit</td>
            <td>{{ stats.questions.Q_11.VALIDE_AYANTS_DROIT }}</td>
          </tr>

          <tr>
            <td class="font-weight-bold" colspan="2">
              Nombre de domiciliés actifs par tranche d'âge
            </td>
          </tr>

          <tr>
            <td class="soustable">Majeurs</td>
            <td>{{ stats.questions.Q_18 }}</td>
          </tr>
          <tr>
            <td class="soustable">Mineurs</td>
            <td>{{ stats.questions.Q_17 }}</td>
          </tr>
          <tr></tr>
          <tr>
            <td class="font-weight-bold" colspan="2">
              Nombre de domiciliés actifs par type de ménage
            </td>
          </tr>

          <ng-container *ngFor="let decision of labels.typeMenage | keyvalue">
            <tr *ngIf="decision.key != 'MINEUR'">
              <td class="soustable">{{ decision.value }}</td>
              <td>
                {{ stats.questions.Q_19[decision.key] }}
              </td>
            </tr>
          </ng-container>

          <tr>
            <td class="font-weight-bold" colspan="2">
              Situation résidentielle
            </td>
          </tr>
          <tr *ngFor="let decision of labels.residence | keyvalue">
            <td class="soustable">{{ decision.value }}</td>
            <td>
              {{ stats.questions.Q_22[decision.key] }}
            </td>
          </tr>
          <tr>
            <td class="soustable">Autre situation</td>
            <td>
              {{ stats.questions.Q_22.AUTRE }}
            </td>
          </tr>
          <tr>
            <td class="soustable">Non renseigné</td>
            <td>
              {{ stats.questions.Q_22.NON_RENSEIGNE }}
            </td>
          </tr>

          <tr>
            <td class="font-weight-bold" colspan="2">
              Cause de l'instabilité de logement
            </td>
          </tr>
          <tr *ngFor="let decision of labels.cause | keyvalue">
            <td class="soustable">{{ decision.value }}</td>
            <td>
              {{ stats.questions.Q_21[decision.key] }}
            </td>
          </tr>
          <tr>
            <td class="soustable">Autre cause</td>
            <td>
              {{ stats.questions.Q_21.AUTRE }}
            </td>
          </tr>
          <tr>
            <td class="soustable">Non renseigné</td>
            <td>
              {{ stats.questions.Q_21.NON_RENSEIGNE }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <br />

    <h4>
      2. Activité
      <span *ngIf="end !== null">
        du {{ start | date: "dd/MM/yyyy" }} au
        {{ end | date: "dd/MM/yyyy" }}
      </span>
      <span *ngIf="end === null">
        du 01/01/2020 au
        {{ start | date: "dd/MM/yyyy" }}
      </span>
    </h4>

    <div class="rapport-part">
      <table class="table table-hover">
        <tbody>
          <tr>
            <td class="font-weight-bold">
              Nombre d'attestations d'élection de domicile délivrées
            </td>
            <td>{{ stats.questions.Q_10 }}</td>
          </tr>
          <tr>
            <td class="soustable">
              Dont premières demandes conclues par une attestation d'élection de
              domicile
            </td>
            <td>{{ stats.questions.Q_10_A }}</td>
          </tr>
          <tr>
            <td class="soustable">Dont renouvellements</td>
            <td>{{ stats.questions.Q_10_B }}</td>
          </tr>
          <tr>
            <td class="font-weight-bold">Total radiations</td>
            <td>{{ stats.questions.Q_12.TOTAL }}</td>
          </tr>
          <tr>
            <td colspan="2">Répartition des radiations par motif</td>
          </tr>
          <tr *ngFor="let decision of labels.motifsRadiation | keyvalue">
            <td class="soustable">{{ decision.value }}</td>
            <td>
              {{ stats.questions.Q_12[decision.key] }}
            </td>
          </tr>
          <tr>
            <td class="font-weight-bold">
              Nombre de
              <b>demandes refusées</b>
            </td>
            <td>{{ stats.questions.Q_13.TOTAL }}</td>
          </tr>
          <tr>
            <td colspan="2">Répartition par motif de refus</td>
          </tr>
          <tr *ngFor="let decision of labels.motifsRefus | keyvalue">
            <td class="soustable">{{ decision.value }}</td>
            <td>
              {{ stats.questions.Q_13[decision.key] }}
            </td>
          </tr>
          <tr>
            <td colspan="2">Répartition des orientations</td>
          </tr>
          <tr>
            <td class="soustable">Orientation vers CCAS</td>
            <td>
              {{ stats.questions.Q_14.CCAS }}
            </td>
          </tr>
          <tr>
            <td class="soustable">Orientation vers Organisme agrée</td>
            <td>
              {{ stats.questions.Q_14.ASSO }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <br />

    <br />
    <h4>
      3. Total des interactions
      <span *ngIf="end !== null">
        du {{ start | date: "dd/MM/yyyy" }} au
        {{ end | date: "dd/MM/yyyy" }}
      </span>
      <span *ngIf="end === null">
        du 01/01/2020 au
        {{ start | date: "dd/MM/yyyy" }}
      </span>
    </h4>
    <div class="rapport-part">
      <table class="table table-hover">
        <tbody>
          <tr *ngFor="let interaction of interactionsLabels | keyvalue">
            <td>{{ interaction.value }}</td>
            <td>
              {{ stats.questions.Q_20[interaction.key] }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
