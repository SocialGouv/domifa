<div class="head-page pt-4 d-print-none">
  <div class="container">
    <div class="py-2 px-0 mx-0 row justify-content-between align-items-center">
      <h1 class="title col-12 col-md-2">Domiciliés</h1>
      <div class="col-12 col-md-8">
        <div class="align-middle d-inline-block">
          <div
            ngbDropdown
            id="dropdownSearchString"
            display="dynamic"
            class="d-inline-block"
            #dropdownSearchString="ngbDropdown"
          >
            <button
              type="button"
              ngbDropdownAnchor
              (focus)="dropdownSearchString.open()"
            >
              <span>
                <fa-icon
                  [icon]="['fas', 'list']"
                  aria-hidden="true"
                  class="me-2"
                ></fa-icon>
                {{
                  SEARCH_STRING_FIELD_LABELS[this.filters.searchStringField]
                    .label
                }}
              </span>
            </button>
            <div
              ngbDropdownMenu
              aria-labelledby="dropdownSearchString"
              class="dropdown-menu"
            >
              <button
                type="button"
                (click)="
                  updateFilters({
                    element: 'searchStringField',
                    value: 'DATE_NAISSANCE'
                  })
                "
                ngbDropdownItem
              >
                Date de naissance
              </button>
              <button
                type="button"
                (click)="
                  updateFilters({
                    element: 'searchStringField',
                    value: 'DEFAULT'
                  })
                "
                ngbDropdownItem
              >
                {{ SEARCH_STRING_FIELD_LABELS.DEFAULT.label }}
              </button>
            </div>
          </div>
        </div>
        <div id="search-bar" role="search" class="align-middle d-inline-block">
          <label for="searchInput" class="visually-hidden"
            >Rechercher un domicilié</label
          >
          <span id="searchIcon">
            <fa-icon [icon]="['fas', 'search']" aria-hidden="true"></fa-icon>
          </span>

          <input
            id="searchInput"
            type="text"
            [(ngModel)]="searchString"
            #searchInput
            [placeholder]="
              SEARCH_STRING_FIELD_LABELS[this.filters.searchStringField]
                .placeholder
            "
          />
          <button
            type="button"
            aria-label="Supprimer le texte saisie"
            *ngIf="searchInput.value?.trim() !== ''"
            (click)="resetSearchBar()"
            class="btn"
            id="deleteSearchIcon"
          >
            <fa-icon aria-hidden="true" [icon]="['fas', 'times']"></fa-icon>
          </button>
        </div>
      </div>

      <div
        class="col-12 col-md-2 text-end"
        *ngIf="currentUserSubject$ | async as me"
      >
        <a
          *ngIf="me.role !== 'facteur'"
          routerLink="/usager/nouveau"
          class="btn btn-white-primary"
          (click)="matomo.trackEvent('MANAGE', 'click', 'Liste_Création', 1)"
        >
          <fa-icon
            aria-hidden="true"
            [icon]="['fas', 'plus']"
            class="me-2"
          ></fa-icon>
          Créer une demande
        </a>
      </div>
    </div>
    <div role="tablist" id="statut-selector" class="mt-3 row">
      <button
        type="button"
        class="col"
        [ngClass]="{ 'selected-section': filters.statut === 'TOUS' }"
        [attr.aria-selected]="filters.statut === 'TOUS'"
        (click)="updateFilters({ element: 'statut', value: 'TOUS' })"
      >
        <span class="visually-hidden" *ngIf="filters.statut === 'TOUS'"
          >Page active:
        </span>
        <span class="statut-cpt">{{ usagersTotalCount || 0 }}</span>
        <span class="statut-label"> Tous</span>
      </button>
      <button
        type="button"
        class="col"
        [ngClass]="{ 'selected-section': filters.statut === 'VALIDE' }"
        [attr.aria-selected]="filters.statut === 'VALIDE'"
        (click)="updateFilters({ element: 'statut', value: 'VALIDE' })"
      >
        <span class="visually-hidden" *ngIf="filters.statut === 'VALIDE'"
          >Page active:
        </span>
        <span class="statut-cpt"
          >{{ allUsagersByStatus?.VALIDE.length || 0 }}
        </span>
        <span class="statut-label"> Actifs</span>
      </button>
      <button
        type="button"
        class="col"
        [ngClass]="{ 'selected-section': filters.statut === 'INSTRUCTION' }"
        [attr.aria-selected]="filters.statut === 'INSTRUCTION'"
        (click)="updateFilters({ element: 'statut', value: 'INSTRUCTION' })"
      >
        <span class="visually-hidden" *ngIf="filters.statut === 'INSTRUCTION'"
          >, page active</span
        >
        <span class="statut-cpt"
          >{{ allUsagersByStatus?.INSTRUCTION.length || 0 }}
        </span>
        <span class="statut-label"> À compléter</span>
      </button>
      <button
        type="button"
        class="col"
        [ngClass]="{
          'selected-section': filters.statut === 'ATTENTE_DECISION'
        }"
        [attr.aria-selected]="filters.statut === 'ATTENTE_DECISION'"
        (click)="
          updateFilters({ element: 'statut', value: 'ATTENTE_DECISION' })
        "
      >
        <span class="statut-cpt"
          >{{ allUsagersByStatus?.ATTENTE_DECISION.length || 0 }}
        </span>
        <span class="statut-label">Attente de décision</span>
        <span
          class="visually-hidden"
          *ngIf="filters.statut === 'ATTENTE_DECISION'"
          >Page active:
        </span>
      </button>
      <button
        type="button"
        class="col"
        [ngClass]="{ 'selected-section': filters.statut === 'REFUS' }"
        [attr.aria-selected]="filters.statut === 'REFUS'"
        (click)="updateFilters({ element: 'statut', value: 'REFUS' })"
      >
        <span class="visually-hidden" *ngIf="filters.statut === 'REFUS'"
          >Page active:
        </span>
        <span class="statut-cpt"
          >{{ allUsagersByStatus?.REFUS.length || 0 }}
        </span>
        <span class="statut-label">Refusés</span>
      </button>
      <button
        type="button"
        class="col"
        [ngClass]="{ 'selected-section': filters.statut === 'RADIE' }"
        [attr.aria-selected]="filters.statut === 'RADIE'"
        (click)="updateFilters({ element: 'statut', value: 'RADIE' })"
      >
        <span class="visually-hidden" *ngIf="filters.statut === 'RADIE'"
          >Page active:
        </span>
        <span class="statut-cpt">{{ usagersRadiesTotalCount || 0 }} </span>
        <span class="statut-label"> Radiés</span>
      </button>
    </div>
  </div>
</div>

<div id="filters" class="py-4 d-print-none">
  <div class="container">
    <div class="row d-flex align-items-center">
      <div class="col-md-9">
        <div *ngIf="nbResults" class="filter-part">
          Filtrer les <span class="text-primary"> {{ nbResults }} </span>
          <ng-container
            *ngIf="
              filters.statut === 'RADIE' &&
              usagersRadiesTotalCount !== usagersRadiesLoadedCount
            "
          >
            premiers
          </ng-container>
          résultats
        </div>
        <div *ngIf="!nbResults" class="filter-part">Aucun résultat</div>

        <div
          *ngIf="filters.statut === 'TOUS' || filters.statut === 'VALIDE'"
          class="filter-part"
        >
          <div class="d-inline-block my-1" *ngIf="filters.passage">
            <button
              type="button"
              aria-label="Réinitialiser le filtre"
              class="btn selected-btn"
              (click)="updateFilters({ element: 'passage', value: null })"
            >
              {{ labelsDernierPassage[filters.passage] }}
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'times']"
                class="cross"
              ></fa-icon>
            </button>
          </div>

          <div
            ngbDropdown
            *ngIf="!filters.passage"
            id="dropdownDernierPassage"
            display="dynamic"
            placement="bottom-left"
            #dropdownDernierPassage="ngbDropdown"
            class="d-inline-block my-1"
          >
            <button
              type="button"
              class="btn"
              ngbDropdownAnchor
              (focus)="dropdownDernierPassage.open()"
            >
              <span>Dernier passage</span>
            </button>
            <div
              ngbDropdownMenu
              aria-labelledby="dropdownDernierPassage"
              class="dropdown-menu"
            >
              <button
                type="button"
                (click)="
                  updateFilters({ element: 'passage', value: 'DEUX_MOIS' })
                "
                ngbDropdownItem
              >
                Plus de 2 mois
              </button>
              <button
                type="button"
                (click)="
                  updateFilters({ element: 'passage', value: 'TROIS_MOIS' })
                "
                ngbDropdownItem
              >
                Plus de 3 mois
              </button>
            </div>
          </div>
        </div>

        <div
          *ngIf="filters.statut === 'TOUS' || filters.statut === 'VALIDE'"
          class="filter-part text-start"
        >
          <div class="d-inline-block" *ngIf="filters.echeance">
            <button
              type="button"
              class="btn selected-btn"
              (click)="updateFilters({ element: 'echeance', value: null })"
            >
              {{ labelsEcheance[filters.echeance] }}
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'times']"
                class="cross"
              ></fa-icon>
            </button>
          </div>
          <div
            *ngIf="!filters.echeance"
            ngbDropdown
            id="dropdownEcheance"
            display="dynamic"
            placement="bottom-end"
            class="d-inline-block"
            #dropdownEcheance="ngbDropdown"
          >
            <button
              type="button"
              class="btn"
              ngbDropdownAnchor
              (focus)="dropdownEcheance.open()"
            >
              <span>Échéance de domiciliation</span>
            </button>

            <div
              ngbDropdownMenu
              aria-labelledby="dropdownEcheance"
              class="dropdown-menu dropdown-menu-end"
            >
              <button
                type="button"
                (click)="
                  updateFilters({ element: 'echeance', value: 'DEUX_MOIS' })
                "
                ngbDropdownItem
              >
                Moins de 2 mois
              </button>
              <button
                type="button"
                (click)="
                  updateFilters({ element: 'echeance', value: 'DEUX_SEMAINES' })
                "
                ngbDropdownItem
              >
                Moins de 2 semaines
              </button>
              <button
                type="button"
                (click)="
                  updateFilters({ element: 'echeance', value: 'DEPASSEE' })
                "
                ngbDropdownItem
              >
                Dépassée
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="filters.statut !== 'REFUS'" class="filter-part">
          <div class="d-inline-block" *ngIf="filters.interactionType">
            <button
              type="button"
              title="Réinitialiser le filtre"
              class="btn selected-btn"
              (click)="
                updateFilters({ element: 'interactionType', value: null })
              "
            >
              Courrier à récupérer
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'times']"
                class="cross"
              ></fa-icon>
            </button>
          </div>
          <div
            ngbDropdown
            id="dropDownCourrierAttente"
            display="dynamic"
            placement="bottom-left"
            *ngIf="!filters.interactionType"
            class="d-inline-block"
            #dropDownCourrierAttente="ngbDropdown"
          >
            <button
              type="button"
              class="btn"
              ngbDropdownAnchor
              (focus)="dropDownCourrierAttente.open()"
            >
              <span>Courriers à récupérer</span>
            </button>
            <div
              ngbDropdownMenu
              aria-labelledby="dropDownCourrierAttente"
              class="dropdown-menu"
            >
              <button
                type="button"
                (click)="
                  updateFilters({
                    element: 'interactionType',
                    value: 'courrierIn'
                  })
                "
                ngbDropdownItem
              >
                Courrier à récupérer
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="filters.statut === 'INSTRUCTION'" class="filter-part">
          <div class="d-inline-block" *ngIf="filters.entretien">
            <button
              type="button"
              aria-label="Réinitialiser le filtre"
              class="btn selected-btn"
              (click)="updateFilters({ element: 'entretien', value: null })"
            >
              Entretien {{ labelsEntretien[filters.entretien] }}
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'times']"
                class="cross"
              ></fa-icon>
            </button>
          </div>
          <div
            ngbDropdown
            id="dropDownEntretien"
            display="dynamic"
            placement="bottom-left"
            *ngIf="!filters.entretien"
            class="d-inline-block"
            #dropDownEntretien="ngbDropdown"
          >
            <button
              type="button"
              class="btn"
              ngbDropdownAnchor
              (focus)="dropDownEntretien.open()"
            >
              <span>Entretien</span>
            </button>
            <div
              ngbDropdownMenu
              aria-labelledby="dropDownEntretien"
              class="dropdown-menu"
            >
              <button
                type="button"
                (click)="
                  updateFilters({
                    element: 'entretien',
                    value: 'COMING'
                  })
                "
                ngbDropdownItem
              >
                À venir
              </button>

              <button
                type="button"
                (click)="
                  updateFilters({
                    element: 'entretien',
                    value: 'OVERDUE'
                  })
                "
                ngbDropdownItem
              >
                Date dépassée
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 text-end">
        <div
          ngbDropdown
          id="dropdownSort"
          placement="bottom-end"
          class="d-inline-block"
          #dropdownSort="ngbDropdown"
        >
          <button
            type="button"
            class="btn"
            id="dropdownSortButton"
            ngbDropdownToggle
          >
            <span>
              <ng-container *ngIf="filters.sortKey !== 'PASSAGE'">
                Trier par
                <strong class="text-primary">{{ sortLabel }}</strong>
              </ng-container>

              <ng-container *ngIf="filters.sortKey === 'PASSAGE'">
                Trier par
                <strong class="text-primary">dernier passage</strong>
              </ng-container>
              <fa-icon
                *ngIf="filters.sortValue === 'ascending'"
                [icon]="['fas', 'sort-amount-up']"
                aria-hidden="true"
                class="ms-2"
              ></fa-icon>

              <fa-icon
                *ngIf="filters.sortValue === 'descending'"
                [icon]="['fas', 'sort-amount-down']"
                aria-hidden="true"
                class="ms-2"
              ></fa-icon>
            </span>
          </button>

          <div
            ngbDropdownMenu
            aria-labelledby="dropdownSort"
            class="dropdown-menu dropdown-menu-end"
          >
            <ng-container
              *ngIf="filters.statut === 'TOUS' || filters.statut === 'VALIDE'"
            >
              <button
                type="button"
                (click)="
                  updateFilters({
                    element: 'sortKey',
                    value: 'PASSAGE',
                    sortValue: 'ascending'
                  })
                "
                ngbDropdownItem
              >
                <fa-icon
                  aria-hidden="true"
                  [icon]="['fas', 'sort-amount-up']"
                ></fa-icon>
                <span>Trier par dernier passage</span
                ><span class="visually-hidden"> ordre croissant</span>
              </button>
              <button
                type="button"
                (click)="
                  updateFilters({
                    element: 'sortKey',
                    value: 'PASSAGE',
                    sortValue: 'descending'
                  })
                "
                ngbDropdownItem
              >
                <fa-icon
                  aria-hidden="true"
                  [icon]="['fas', 'sort-amount-down']"
                ></fa-icon>
                <span>Trier par dernier passage</span
                ><span class="visually-hidden">Ordre décroissant</span>
              </button>
            </ng-container>
            <button
              type="button"
              (click)="
                updateFilters({
                  element: 'sortKey',
                  value: 'ECHEANCE',
                  sortValue: 'ascending'
                })
              "
              ngbDropdownItem
            >
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'sort-amount-up']"
              ></fa-icon>
              <span> Trier par {{ getEcheanceLabel() }}</span
              ><span class="visually-hidden"> ordre croissant</span>
            </button>
            <button
              type="button"
              (click)="
                updateFilters({
                  element: 'sortKey',
                  value: 'ECHEANCE',
                  sortValue: 'descending'
                })
              "
              ngbDropdownItem
            >
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'sort-amount-down']"
              ></fa-icon>
              Trier par {{ getEcheanceLabel()
              }}<span class="visually-hidden">Ordre décroissant</span>
            </button>
            <button
              type="button"
              title="Trier par nom ascendant"
              (click)="
                updateFilters({
                  element: 'sortKey',
                  value: 'NAME',
                  sortValue: 'ascending'
                })
              "
              ngbDropdownItem
            >
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'sort-amount-up']"
              ></fa-icon>
              Trier par nom<span class="visually-hidden"> ordre croissant</span>
            </button>
            <button
              type="button"
              (click)="
                updateFilters({
                  element: 'sortKey',
                  value: 'NAME',
                  sortValue: 'descending'
                })
              "
              ngbDropdownItem
            >
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'sort-amount-down']"
              ></fa-icon>
              Trier par nom<span class="visually-hidden"
                >Ordre décroissant</span
              >
            </button>
            <button
              type="button"
              (click)="
                updateFilters({
                  element: 'sortKey',
                  value: 'ID',
                  sortValue: 'ascending'
                })
              "
              ngbDropdownItem
            >
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'sort-amount-up']"
              ></fa-icon>
              Trier par ID <span class="visually-hidden"> ordre croissant</span>
            </button>
            <button
              type="button"
              (click)="
                updateFilters({
                  element: 'sortKey',
                  value: 'ID',
                  sortValue: 'descending'
                })
              "
              ngbDropdownItem
            >
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'sort-amount-down']"
              ></fa-icon>
              Trier par ID<span class="visually-hidden">Ordre décroissant</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="content pt-3 pb-5">
  <div class="container">
    <div
      *ngIf="usagers.length === 0 && !searching && !loading"
      class="my-4 alert alert-warning text-center d-print-none"
    >
      <span class="me-2">
        <strong>Aucun résultat :</strong>
        aucun dossier ne correspond à votre recherche
      </span>

      <button
        type="button"
        (click)="resetFilters()"
        class="btn btn-outline-dark"
      >
        Réinitialiser les filtres
      </button>
    </div>

    <div
      *ngIf="(searching || loading) && filters.page === 0"
      @fadeInOut
      role="alert"
      aria-busy="true"
      aria-label="Chargement des dossiers..."
      class="text-center content-overlay d-print-none"
    >
      <div>
        <fa-icon
          [icon]="['fas', 'spinner']"
          class="spinner"
          [spin]="true"
          aria-hidden="true"
        ></fa-icon>
        <br />
        <span class="loading_message">Chargement des dossiers...</span>
      </div>
    </div>

    <div id="table-container" @fadeInOut>
      <app-manage-manage-usagers-table
        [selectedRefs]="selectedRefs"
        [usagers]="usagers"
        [me]="me"
        [filters]="filters"
        [displayCheckboxes]="displayCheckboxes"
        (updateUsager)="updateUsager($event)"
        (updateFilters)="updateFilters($event)"
        (goToPrint)="goToPrint()"
      ></app-manage-manage-usagers-table>
    </div>
    <div
      class="container py-3 px-2 text-center"
      *ngIf="
        (filters.statut === 'TOUS' || filters.statut === 'RADIE') &&
        usagersRadiesTotalCount !== usagersRadiesLoadedCount &&
        !this.chargerTousRadies$.value
      "
    >
      <div class="my-2">
        <button
          type="button"
          class="btn btn-primary"
          (click)="chargerTousRadies()"
        >
          Afficher tous les radiés
        </button>
      </div>
    </div>
  </div>
</div>
