<section
  class="d-flex align-items-center my-2 flex-wrap justify-content-md-start justify-content-center"
  *ngIf="selectedRefs.length > 0 && displayCheckboxes"
>
  <div class="me-2">{{ selectedRefs.length }} selectionnés</div>
  <div class="btn-group btn-group-toggle" data-toggle="buttons">
    <app-decision-radiation-form
      [selectedRefs]="selectedRefs"
      context="MANAGE"
      *ngIf="filters.statut === 'VALIDE'"
    ></app-decision-radiation-form>
    <button
      *ngIf="me?.role !== 'simple'"
      type="button"
      (click)="openDeleteUsagersModal()"
      class="btn btn-sm btn-outline-dark"
    >
      Supprimer {{ selectedRefs.length === 1 ? "le domicilié" : "les domiciliés"
      }}
    </button>
  </div>
</section>
<table
  class="table"
  *ngIf="usagers.length !== 0 && !loading"
  id="table-usagers"
>
  <caption class="visually-hidden text-dark">
    Tableau des domiciliés
  </caption>
  <thead>
    <th scope="col" *ngIf="displayCheckboxes">
      <span class="visually-hidden"
        >Colonne de sélection des dossiers pour les supprimer ou les
        radier</span
      >
    </th>
    <th scope="col" *ngIf="filters.statut ==='TOUS'">STATUT</th>

    <th scope="col">
      <button
        type="button"
        (click)="updateFilters.emit({  element: 'sortKey',  value: 'ID'})"
      >
        <span class="visually-hidden">Trier par</span>
        ID
      </button>
    </th>
    <th scope="col"><span class="visually-hidden">Notes épinglées</span></th>
    <th scope="col">
      <button
        type="button"
        (click)="updateFilters.emit({ element: 'sortKey',  value: 'NAME' })"
      >
        <span class="visually-hidden">Trier par</span>
        Nom prénom
      </button>
    </th>
    <th scope="col">Téléphone</th>
    <th scope="col">INFORMATIONS</th>

    <th
      scope="col"
      *ngIf="filters.statut === 'ATTENTE_DECISION' || filters.statut === 'INSTRUCTION'"
    >
      Type de demande
    </th>
    <th
      class="clickable"
      scope="col"
      *ngIf="filters.statut === 'VALIDE' || filters.statut === 'TOUS' "
    >
      <button
        type="button"
        (click)="updateFilters.emit({element: 'sortKey', value: 'PASSAGE'})"
      >
        <span class="visually-hidden">Trier par</span>
        PASSAGE
      </button>
    </th>
    <th scope="col" *ngIf="filters.statut === 'INSTRUCTION'">Rendez-vous le</th>
    <th class="clickable" scope="col">
      <button
        type="button"
        (click)="updateFilters.emit({element: 'sortKey', value: 'ECHEANCE'})"
      >
        <span class="visually-hidden">Trier par</span>
        <ng-container
          *ngIf="filters.statut !== 'REFUS' && filters.statut !== 'RADIE'"
          >ÉCHÉANCE</ng-container
        >
        <ng-container *ngIf="filters.statut === 'REFUS' "
          >REFUSÉ LE</ng-container
        >
        <ng-container *ngIf="filters.statut === 'RADIE' "
          >RADIÉ LE</ng-container
        >
      </button>
    </th>
    <th scope="col" class="text-start d-print-none">Intéraction</th>
    <th scope="col" class="text-start d-print-none">Courrier</th>
    <th scope="col" class="d-print-none">
      <button
        type="button"
        class="btn-sm btn-primary btn"
        (click)="goToPrint.emit()"
      >
        <span class="visually-hidden">Imprimer la liste</span>
        <fa-icon
          aria-hidden="true"
          [icon]="['fas', 'print']"
          *ngIf="!loading"
        ></fa-icon>

        <fa-icon
          aria-hidden="true"
          [icon]="['fas', 'circle-notch']"
          [spin]="true"
          *ngIf="loading"
        >
        </fa-icon>
      </button>
    </th>
  </thead>
  <tbody>
    <tr *ngFor="let usager of usagers; let i = index">
      <td class="text-start p-0 m-0" *ngIf="displayCheckboxes">
        <label
          for="select-{{usager.ref}}"
          (change)="toggleSelection(usager.ref)"
        >
          <span class="d-none">
            Sélectionner {{ usager | usagerNomComplet }}</span
          >
          <input
            [id]="'select-'+usager.ref"
            type="checkbox"
            [checked]="selectedRefs.indexOf(usager.ref) !==-1"
          />
        </label>
      </td>
      <td *ngIf="filters.statut ==='TOUS'" class="clickable text-start">
        <span [class]="'label-info ' + usager.statusInfos.color">
          {{ usager.statusInfos.text }}</span
        >
      </td>
      <td
        class="text-primary manage-usager-ref"
        (click)="goToProfil(usager)"
        tabindex="0"
      >
        <span> {{ usager.customRef ? usager.customRef : usager.ref }}</span>
      </td>

      <td>
        <img
          *ngIf="usager.pinnedNote"
          [ngbTooltip]="pinnedNote"
          triggers="hover focus"
          #tooltipNote="ngbTooltip"
          src="/assets/icones/pinned-note.svg"
          alt="Note épinglée"
          aria-hidden="true"
        />
        <ng-template #pinnedNote>
          <b>Note épinglée : </b>{{ usager.pinnedNote.message}}
        </ng-template>
        <span class="visually-hidden" *ngIf="!usager.pinnedNote"
          >Aucune note épinglée</span
        >
      </td>

      <td class="clickable table-name td-name">
        <a
          [routerLink]="usager.usagerProfilUrl"
          ariaCurrentWhenActive="page"
          routerLinkActive="router-link-active"
        >
          <span> {{ usager.nom | uppercase }} {{ usager.prenom }} </span>
          <span *ngIf="usager.surnom && usager.surnom !== null">
            ({{ usager.surnom }})
          </span>
          <span class="visually-hidden"
            >Cliquer ici pour aller sur la fiche de {{ usager.nom | uppercase }}
            {{ usager.prenom }}</span
          >
        </a>
      </td>

      <td
        class="clickable table-name"
        tabindex="0"
        (click)="goToProfil(usager)"
      >
        <span *ngIf="usager.telephone?.numero">
          {{ usager.telephone | formatInternationalPhoneNumber }}</span
        >
      </td>
      <td class="clickable" tabindex="0" (click)="goToProfil(usager)">
        <app-display-ayants-droits
          class="d-inline-block"
          [usager]="usager"
        ></app-display-ayants-droits>
        <div
          class="label-info label-procuration"
          *ngIf="usager.options.procurations.length > 0"
          [ngbTooltip]="procurationActif"
          triggers="hover focus"
          #tooltipProcuration="ngbTooltip"
        >
          <ng-template #procurationActif>
            <p
              class="text-start"
              *ngFor="let procuration of usager.options.procurations; let i = index"
            >
              <span *ngIf="procuration.dateFin > today">
                <fa-icon
                  aria-hidden="true"
                  [icon]="['fas', 'share']"
                  class="text-primary me-1"
                ></fa-icon>
                Active: {{ procuration.nom }} {{ procuration.prenom }}
              </span>
              <span *ngIf="procuration.dateFin <= today">
                <fa-icon
                  aria-hidden="true"
                  [icon]="['fas', 'times']"
                  class="text-danger me-1"
                ></fa-icon>
                Expirée le {{procuration.dateFin | date: "dd/MM/yy" }}: {{
                procuration.nom }} {{ procuration.prenom }}
              </span>
            </p>
          </ng-template>
          <p class="m-0">
            {{ usager.options.procurations.length > 1 ? 'Procurations':
            'Procuration'}}
          </p>
        </div>
        <div
          class="label-info label-transfert"
          *ngIf="usager.options.transfert.actif"
          [ngbTooltip]="transfertActif"
          tabindex="0"
          triggers="hover focus"
          #tooltipTransfert="ngbTooltip"
        >
          <ng-template #transfertActif>
            <div class="distribution-tooltip" id="tooltipTransfertContent{{i}}">
              <p *ngIf="usager.options.transfert.dateFin > today">
                <fa-icon
                  aria-hidden="true"
                  [icon]="['fas', 'share']"
                  class="text-primary me-1"
                ></fa-icon>
                Courrier à transférer : {{ usager.options.transfert.nom |
                titlecase }} {{ usager.options.transfert.adresse | titlecase }}
              </p>

              <p *ngIf="usager.options.transfert.dateFin <= today">
                Transfert expiré le {{ usager.options.transfert.dateFin | date:
                "dd/MM/yy" }}
              </p>
            </div>
          </ng-template>
          <span>Transfert</span>
        </div>
        <div *ngIf="usager.options.npai.actif" class="label-info label-danger">
          <span>Pli non distribuable</span>
        </div>
      </td>

      <td
        *ngIf="filters.statut === 'ATTENTE_DECISION' ||  filters.statut ==='INSTRUCTION'"
      >
        <p
          *ngIf="usager.typeDom === 'RENOUVELLEMENT'"
          class="m-0 label-info label-yellow"
        >
          Renouvellement
        </p>
        <p
          *ngIf="usager.typeDom === 'PREMIERE_DOM'"
          class="m-0 label-info label-grey"
        >
          Première demande
        </p>
      </td>

      <td
        *ngIf="filters.statut === 'VALIDE' || filters.statut === 'TOUS' "
        class="clickable"
        tabindex="0"
        (click)="goToProfil(usager)"
      >
        {{ usager.lastInteraction.dateInteraction | date: "dd/MM/yy" }}
      </td>
      <td class="clickable" *ngIf="filters.statut ==='INSTRUCTION'">
        {{ usager.rdvInfos.content }}
      </td>
      <td
        class="statut-date clickable"
        tabindex="0"
        (click)="goToProfil(usager)"
      >
        <ng-container *ngIf="usager.isActif">
          <span [class]="'statut-signal ' +usager.echeanceInfos.color"></span>
          <span
            class="visually-hidden"
            *ngIf="usager.echeanceInfos.color === 'bg-danger'"
            >Moins de 2 mois
          </span>
          <span
            class="visually-hidden"
            *ngIf="usager.echeanceInfos.color !== 'bg-danger'"
          >
            Moins de 2 semaines ou dépassée
          </span>
        </ng-container>
        <span *ngIf="usager.echeanceInfos.dateToDisplay">
          {{ usager.echeanceInfos.dateToDisplay | date: "dd/MM/yy" }}</span
        >
      </td>

      <td class="text-start icones_liste d-print-none">
        <div
          class="interaction-buttons"
          *ngIf="usager.isActif || (usager.decision.statut === 'RADIE' && usager.options.npai.actif !== true)"
        >
          <button
            type="button"
            [disabled]="loadingButtons.indexOf(usager.ref.toString() + '_visite') !== -1"
            aria-label="Ajout d'un passage"
            ngbTooltip="Ajout d'un passage"
            triggers="hover focus"
            class="btn interaction-btn btn-light"
            (click)="setSingleInteraction(usager, 'visite')"
          >
            <fa-icon
              [icon]="['fas', 'circle-notch']"
              [spin]="true"
              class="list-icon-disabled"
            >
            </fa-icon>
            <span class="icon-passage list-icon"></span>
          </button>
          <button
            type="button"
            [disabled]="loadingButtons.indexOf(usager.ref.toString() + '_appel') !== -1"
            aria-label="Ajout d'un appel téléphonique"
            ngbTooltip="Ajout d'un appel téléphonique"
            triggers="hover focus"
            class="btn interaction-btn btn-light"
            (click)="setSingleInteraction(usager, 'appel')"
          >
            <fa-icon
              [icon]="['fas', 'circle-notch']"
              [spin]="true"
              class="list-icon-disabled"
            >
            </fa-icon>
            <span class="icon-appel list-icon"></span>
          </button>
        </div>
      </td>

      <td>
        <div
          class="interaction-buttons"
          *ngIf="usager.isActif || (usager.decision.statut === 'RADIE' && usager.options.npai.actif !== true)"
        >
          <button
            type="button"
            [disabled]="loadingButtons.indexOf(usager.ref.toString() + '_courrierIn') !== -1"
            aria-label="Ajout rapide d'un courrier"
            ngbTooltip="Ajout rapide d'un courrier"
            triggers="hover focus"
            class="btn interaction-btn btn-light"
            (click)="setSingleInteraction(usager, 'courrierIn')"
          >
            <fa-icon
              [icon]="['fas', 'circle-notch']"
              [spin]="true"
              class="list-icon-disabled"
            >
            </fa-icon>
            <span class="icon-courrier list-icon"></span>
          </button>
          <button
            type="button"
            aria-label="Réception de courriers"
            ngbTooltip="Réception de courriers"
            triggers="hover focus"
            class="interaction-btn btn-light btn"
            (click)="openInteractionInModal(usager)"
          >
            <span class="icon-reception list-icon"></span>
          </button>

          <ng-template #distributionBox>
            <div class="distribution-tooltip p-2 text-start">
              <span>Distribuer les courriers</span>
              <p class="m-0" *ngIf="usager.lastInteraction.courrierIn > 0">
                <span class="list-icon icon-courrier"></span>
                <span>
                  <strong class="text-primary"
                    >{{ usager.lastInteraction.courrierIn }}</strong
                  >
                  courriers
                </span>
              </p>

              <p class="m-0" *ngIf="usager.lastInteraction.recommandeIn > 0">
                <span class="list-icon icon-recommande"> </span>
                <span>
                  <strong class="text-primary"
                    >{{ usager.lastInteraction.recommandeIn }}</strong
                  >
                  avis de passage</span
                >
              </p>

              <p class="m-0" *ngIf="usager.lastInteraction.colisIn > 0">
                <span class="list-icon icon-colis"> </span>
                <span>
                  <strong class="text-primary"
                    >{{ usager.lastInteraction.colisIn }}</strong
                  >
                  colis</span
                >
              </p>
            </div>
          </ng-template>

          <button
            *ngIf="usager.lastInteraction.enAttente"
            class="btn interaction-btn btn-light"
            [ngbTooltip]="distributionBox"
            type="button"
            triggers="hover focus"
            [attr.aria-label]="'Distribuer '+ usager.totalInteractionsEnAttente+ ' courriers'"
            (click)="openInteractionOutModal(usager)"
          >
            <span class="icon-distribution list-icon"></span>
            <strong class="notification">
              {{ usager.totalInteractionsEnAttente }}
            </strong>
          </button>
        </div>
      </td>

      <td class="d-print-none">
        <app-manage-download-docs
          [me]="me"
          [usager]="usager"
        ></app-manage-download-docs>
      </td>
    </tr>
  </tbody>
</table>

<ng-template #setInteractionInModal let-modal>
  <app-set-interaction-in-form
    [usager]="selectedUsager"
    (cancelReception)="cancelReception()"
  ></app-set-interaction-in-form>
</ng-template>

<ng-template #setInteractionOutModal let-modal>
  <app-set-interaction-out-form
    [usager]="selectedUsager"
    (cancelReception)="cancelReception()"
  ></app-set-interaction-out-form>
</ng-template>

<ng-template #deleteUsagersModal let-modal>
  <app-delete-usager
    [selectedRefs]="selectedRefs"
    [me]="me"
  ></app-delete-usager>
</ng-template>
