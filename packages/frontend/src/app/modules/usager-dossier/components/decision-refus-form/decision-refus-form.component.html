<form [formGroup]="refusForm" (ngSubmit)="setDecisionRefus()">
  <p>
    Les champs suivis d'un
    <span class="fr-text--bold text-error">*</span> sont obligatoires
  </p>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem">
    <!-- Date du refus -->
    <div
      class="fr-form-group"
      [class.fr-form-group--error]="
        (r.dateFin.dirty || submitted) && r.dateFin.errors
      "
    >
      <label class="fr-label" for="dateFinRefus">
        Date du refus
        <span aria-label="obligatoire">*</span>
      </label>
      <div class="fr-input-group">
        <input
          class="fr-input"
          placeholder="jj/mm/aaaa"
          [minDate]="minDate"
          [maxDate]="maxDateRefus"
          placement="auto"
          ngbDatepicker
          id="dateFinRefus"
          formControlName="dateFin"
          #dFin="ngbDatepicker"
          appDateFr
          [attr.aria-invalid]="
            (r.dateFin.dirty || submitted) && r.dateFin.errors ? true : false
          "
          [attr.aria-describedby]="
            (r.dateFin.dirty || submitted) && r.dateFin.errors
              ? 'date-fin-errors'
              : null
          "
          maxlength="10"
          required
        />
        <button
          type="button"
          aria-label="Sélectionner la date du refus dans le calendrier"
          class="fr-btn fr-btn--tertiary-no-outline fr-icon-calendar-line"
          (click)="dFin.toggle()"
        ></button>
      </div>
      @if ((r.dateFin.dirty || submitted) && r.dateFin.errors) {
      <p id="date-fin-errors" class="fr-error-text">
        La date de refus est incorrecte, exemple: 20/12/2022
      </p>
      }
    </div>

    <!-- Motif du refus -->
    <div
      class="fr-form-group"
      [class.fr-form-group--error]="
        (r.motif.dirty || submitted) && r.motif.errors
      "
    >
      <label class="fr-label" for="motifRefusSelect">
        Pour quel motif ?
        <span aria-label="obligatoire">*</span>
      </label>
      <select
        class="fr-select"
        id="motifRefusSelect"
        formControlName="motif"
        [attr.aria-invalid]="
          (r.motif.dirty || submitted) && r.motif.errors ? true : false
        "
        [attr.aria-describedby]="
          (r.motif.dirty || submitted) && r.motif.errors ? 'motif-errors' : null
        "
        required
      >
        <option value="" disabled selected>Sélectionner un motif</option>
        @for (motif of MOTIFS_REFUS_LABELS | keyvalue; track motif.key) {
        <option [value]="motif.key">{{ motif.value }}</option>
        }
        <option value="AUTRE">Autre raison</option>
      </select>
      @if ((r.motif.dirty || submitted) && r.motif.errors) {
      <p id="motif-errors" class="fr-error-text">
        Veuillez sélectionner un motif
      </p>
      }
    </div>
  </div>

  <!-- Autre motif de refus (si sélectionné) -->
  @if (r.motif.value === 'AUTRE') {
  <div
    class="fr-form-group"
    [class.fr-form-group--error]="
      (r.motifDetails.dirty || submitted) && r.motifDetails.errors
    "
  >
    <label class="fr-label" for="motifRefusAutre">
      Autre motif de refus (10 caractères minimum)
      <span aria-label="obligatoire">*</span>
    </label>
    <input
      type="text"
      class="fr-input"
      id="motifRefusAutre"
      formControlName="motifDetails"
      minlength="10"
      [attr.aria-invalid]="
        (r.motifDetails.dirty || submitted) && r.motifDetails.errors
          ? true
          : false
      "
      [attr.aria-describedby]="
        (r.motifDetails.dirty || submitted) && r.motifDetails.errors
          ? 'motifDetails-errors'
          : null
      "
      required
    />
    @if ((r.motifDetails.dirty || submitted) && r.motifDetails.errors) {
    <p id="motifDetails-errors" class="fr-error-text">
      Veuillez préciser la raison
    </p>
    }
  </div>
  }

  <!-- Orientation proposée -->
  <div
    class="fr-form-group"
    [class.fr-form-group--error]="
      (r.orientation.dirty || submitted) && r.orientation.errors
    "
  >
    <label class="fr-label" for="orientationRefusSelect">
      Orientation proposée
      <span aria-label="obligatoire">*</span>
    </label>
    <select
      class="fr-select"
      id="orientationRefusSelect"
      formControlName="orientation"
      [attr.aria-invalid]="
        (r.orientation.dirty || submitted) && r.orientation.errors
          ? true
          : false
      "
      [attr.aria-describedby]="
        (r.orientation.dirty || submitted) && r.orientation.errors
          ? 'orientation-errors'
          : null
      "
      required
    >
      <option value="" disabled selected>Sélectionner une orientation</option>
      <option value="ccas">CCAS</option>
      <option value="cias">CIAS, Commune</option>
      <option value="asso">Organisme agréé</option>
      <option value="other">Autre</option>
    </select>
    @if (submitted && r.orientation.errors) {
    <p id="orientation-errors" class="fr-error-text">
      Veuillez proposer une orientation
    </p>
    }
  </div>

  <!-- Précision orientation -->
  <div
    class="fr-form-group"
    [class.fr-form-group--error]="
      (r.orientationDetails.dirty || submitted) && r.orientationDetails.errors
    "
  >
    <label class="fr-label" for="orientationRefusDetails">
      Précisez l'orientation choisie
      <span aria-label="obligatoire">*</span>
    </label>
    <input
      type="text"
      class="fr-input"
      id="orientationRefusDetails"
      formControlName="orientationDetails"
      [attr.aria-invalid]="
        (r.orientationDetails.dirty || submitted) && r.orientationDetails.errors
          ? true
          : false
      "
      [attr.aria-describedby]="
        (r.orientationDetails.dirty || submitted) && r.orientationDetails.errors
          ? 'orientationDetails-errors'
          : null
      "
      required
    />
    @if (submitted && r.orientationDetails.errors) {
    <p id="orientationDetails-errors" class="fr-error-text">
      Veuillez indiquer vers quel organisme vous souhaitez orienter le demandeur
    </p>
    }
  </div>

  <div class="text-right">
    <button
      type="button"
      class="fr-btn fr-btn--secondary"
      (click)="closeModals.emit()"
    >
      Annuler
    </button>
    <button
      type="submit"
      class="fr-btn"
      [disabled]="loading"
      [attr.aria-busy]="loading"
    >
      @if (!loading) { Confirmer le refus } @else { Veuillez patienter... }
    </button>
  </div>
</form>
