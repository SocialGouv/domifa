<app-step-header
  *ngIf="usager"
  [usager]="usager"
  [currentStep]="0"
></app-step-header>

<div class="content" *ngIf="currentUserSubject$ | async as me">
  <div class="container py-3">
    <app-display-duplicates-usager
      [duplicates]="duplicates"
    ></app-display-duplicates-usager>
    <section
      aria-label="Formulaire d'édition de l'état-civil du demandeur"
      class="step_form"
      *ngIf="usagerForm"
    >
      <form
        [formGroup]="usagerForm"
        (ngSubmit)="submitInfos()"
        autocomplete="off"
      >
        <h2 class="form-title">État civil du demandeur</h2>

        <p>
          Les champs suivis d'un
          <span class="fw-bold text-danger">*</span> sont obligatoires
        </p>

        <fieldset>
          <legend>Civilité</legend>
          <div class="form-group">
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                formControlName="sexe"
                id="homme"
                value="homme"
              />
              <label class="form-check-label" for="homme"> Monsieur </label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                formControlName="sexe"
                id="femme"
                value="femme"
              />
              <label class="form-check-label" for="femme"> Madame </label>
            </div>
          </div>
          <div class="row">
            <div class="col form-group required">
              <label for="nom">Nom</label>
              <input
                type="text"
                class="form-control"
                id="nom"
                appCleanStr
                formControlName="nom"
                placeholder="Précisez nom de naissance si nécessaire"
                [ngClass]="{ 'is-invalid': submitted && f.nom.errors }"
                (blur)="isDuplicateName()"
                required
              />
              <p *ngIf="submitted && f.nom.errors" class="invalid-feedback">
                Le nom du demandeur est obligatoire
              </p>
            </div>
            <div class="col form-group required">
              <label for="prenom">Prénom(s)</label>
              <input
                type="text"
                class="form-control"
                id="prenom"
                appCleanStr
                formControlName="prenom"
                [ngClass]="{ 'is-invalid': submitted && f.prenom.errors }"
                (blur)="isDuplicateName()"
                required
              />
              <p *ngIf="submitted && f.prenom.errors" class="invalid-feedback">
                Le prénom du demandeur est obligatoire
              </p>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 form-group">
              <label for="surnom">Nom d'usage / Surnom</label>
              <input
                type="text"
                class="form-control"
                id="surnom"
                appCleanStr
                formControlName="surnom"
                [ngClass]="{ 'is-invalid': submitted && f.surnom.errors }"
              />
            </div>
            <div class="col-md-6 form-group">
              <label for="langue">Langue parlée</label>
              <input
                id="langue"
                type="text"
                class="form-control"
                formControlName="langue"
                placeholder="Anglais, arabe, chinois, etc"
                [ngClass]="{
                  'is-invalid': f.langue.touched && f.langue.errors
                }"
                [ngbTypeahead]="languagesAutocompleteSearch"
                [resultFormatter]="languagesAutocomplete.formatter"
                [inputFormatter]="languagesAutocomplete.formatter"
              />

              <p
                *ngIf="f.langue.touched && f.langue.errors"
                class="invalid-feedback"
              >
                La langue saisie est invalide
              </p>
            </div>
          </div>
          <div class="row">
            <div class="col form-group required">
              <label for="dateNaissance">Date de naissance</label>
              <div class="input-group">
                <input
                  class="form-control"
                  placeholder="jj/mm/aaaa"
                  [minDate]="minDateNaissance"
                  [maxDate]="maxDateNaissance"
                  placement="bottom"
                  formControlName="dateNaissance"
                  ngbDatepicker
                  id="dateNaissance"
                  dateFr
                  value
                  [ngClass]="{
                    'is-invalid': submitted && f.dateNaissance.errors
                  }"
                  #d="ngbDatepicker"
                  maxlength="10"
                  required
                />

                <button
                  type="button"
                  aria-label="Sélectionner une date de naissance sur le calendrier"
                  class="input-group-text btn btn-outline-primary"
                  (click)="d.toggle()"
                >
                  <fa-icon [icon]="['fas', 'calendar']"></fa-icon>
                </button>

                <p *ngIf="f.dateNaissance.invalid" class="invalid-feedback">
                  La date de naissance est obligatoire
                </p>
              </div>
            </div>
            <div class="col">
              <div class="form-group required">
                <label for="villeNaissance">Ville de naissance</label>
                <input
                  type="text"
                  class="form-control"
                  id="villeNaissance"
                  formControlName="villeNaissance"
                  placeholder="Préciser le pays si à l'étranger"
                  [ngClass]="{
                    'is-invalid': submitted && f.villeNaissance.errors
                  }"
                  required
                />
                <div *ngIf="f.villeNaissance.errors" class="invalid-feedback">
                  La ville de naissance est obligatoire
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div
                class="form-group"
                [ngClass]="
                  f.contactByPhone.value === true
                    ? 'required form-group'
                    : 'form-group'
                "
              >
                <label for="telephone"
                  >Numéro de téléphone (mobile uniquement)</label
                >
                <ngx-intl-tel-input
                  [cssClass]="
                    submitted && (f.telephone.errors || f.telephone.invalid)
                      ? 'form-control is-invalid'
                      : 'form-control'
                  "
                  [preferredCountries]="PREFERRED_COUNTRIES"
                  [enableAutoCountrySelect]="false"
                  [enablePlaceholder]="true"
                  [searchCountryFlag]="true"
                  [customPlaceholder]="mobilePhonePlaceHolder"
                  searchCountryPlaceholder="Choisissez votre pays"
                  [searchCountryField]="[
                    SearchCountryField.Iso2,
                    SearchCountryField.Name
                  ]"
                  [selectFirstCountry]="false"
                  [maxLength]="15"
                  [phoneValidation]="true"
                  [separateDialCode]="true"
                  [numberFormat]="PhoneNumberFormat.International"
                  inputId="telephone"
                  name="telephone"
                  formControlName="telephone"
                  (countryChange)="updatePlaceHolder($event.iso2)"
                  [selectedCountryISO]="f.telephone.value?.countryCode"
                ></ngx-intl-tel-input>
                <small *ngIf="f.contactByPhone.value === false"
                  >Optionnel</small
                >
                <p
                  *ngIf="submitted && f.telephone.errors"
                  class="invalid-feedback-custom"
                >
                  Le numéro de téléphone est incorrect
                </p>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label for="email">Adresse e-mail (Optionnel)</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  formControlName="email"
                  [ngClass]="{ 'is-invalid': f.email.errors }"
                  placeholder="adresse@mail.com"
                />
                <p *ngIf="submitted && f.email.errors" class="invalid-feedback">
                  Veuillez saisir une adresse e-mail valide. Par exemple :
                  john.doe@domifa.fr
                </p>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-6 form-group">
              <label for="numeroDistribution"
                >Numéro de boite postale ou TSA</label
              >
              <input
                type="text"
                class="form-control"
                id="numeroDistribution"
                formControlName="numeroDistribution"
                placeholder="Exemple : BP 102, TSA 11000"
                [ngClass]="{
                  'is-invalid': submitted && f.numeroDistribution.errors
                }"
                maxlength="20"
              />
              <p *ngIf="f.numeroDistribution.errors" class="invalid-feedback">
                Le numéro de distribution spéciale est incorrect
              </p>
            </div>
          </div>
        </fieldset>

        <div
          class="row my-3"
          *ngIf="
            me.structure.sms.enabledByDomifa &&
            me.structure.sms.enabledByStructure
          "
        >
          <div class="col">
            <fieldset>
              <legend>
                Le demandeur souhaite-t-il recevoir des notifications par SMS
                (arrivée d'un courrier, échéance de domiciliation) ?
              </legend>

              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  formControlName="contactByPhone"
                  id="sms_oui"
                  [value]="true"
                />
                <label class="form-check-label" for="sms_oui"> Oui </label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  formControlName="contactByPhone"
                  id="sms_non"
                  [value]="false"
                />
                <label class="form-check-label" for="sms_non"> Non </label>
              </div>
            </fieldset>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12 my-3">
            <fieldset>
              <legend>Le demandeur a-t-il des ayant-droits ?</legend>

              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  formControlName="ayantsDroitsExist"
                  id="ayantsDroits_oui"
                  [value]="true"
                  (click)="addAyantDroit()"
                />
                <label class="form-check-label" for="ayantsDroits_oui">
                  Oui
                </label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  (click)="resetAyantDroit()"
                  formControlName="ayantsDroitsExist"
                  id="ayantsDroits_non"
                  [value]="false"
                />
                <label class="form-check-label" for="ayantsDroits_non">
                  Non
                </label>
              </div>
            </fieldset>
          </div>
        </div>

        <ng-container *ngIf="f.ayantsDroitsExist.value === true" class="py-2">
          <fieldset
            formArrayName="ayantsDroits"
            *ngFor="let ayantDroit of ayantsDroits.controls; let i = index"
          >
            <legend>Ayant-droit numéro {{ i + 1 }}</legend>
            <div [formGroupName]="i" class="row bottom">
              <div class="col form-group required">
                <label for="ad_nom_{{ i }}">Nom</label>
                <input
                  #adNom
                  id="ad_nom_{{ i }}"
                  type="text"
                  class="form-control"
                  formControlName="nom"
                  [attr.aria-label]="
                    'Nom de naissance de l\'ayant-droit ' + i + 1
                  "
                  [ngClass]="{
                    'is-invalid':
                      submitted && ayantsDroits.controls[i].get('nom')?.errors
                  }"
                  required
                />
                <div
                  *ngIf="
                    submitted && ayantsDroits.controls[i].get('nom')?.errors
                  "
                  class="invalid-feedback"
                >
                  Le nom est obligatoire
                </div>
              </div>
              <div class="col form-group required">
                <label for="ad_prenom_{{ i }}">Prénom</label>
                <input
                  type="text"
                  id="ad_prenom_{{ i }}"
                  class="form-control"
                  [attr.aria-label]="'Prénom de l\'ayant-droit ' + i + 1"
                  formControlName="prenom"
                  [ngClass]="{
                    'is-invalid':
                      submitted &&
                      ayantsDroits.controls[i].get('prenom')?.errors
                  }"
                  required
                />
                <p
                  *ngIf="
                    submitted && ayantsDroits.controls[i].get('prenom')?.errors
                  "
                  class="invalid-feedback"
                >
                  Le prénom est obligatoire
                </p>
              </div>
              <div class="col form-group required">
                <label for="ad_dateNaissance_{{ i }}">Date de naissance</label>
                <div class="input-group">
                  <input
                    id="ad_dateNaissance_{{ i }}"
                    class="form-control"
                    placeholder="jj/mm/aaaa"
                    [attr.aria-label]="
                      'Date de naissance de l\'ayant-droit ' + i + 1
                    "
                    [minDate]="minDateNaissance"
                    [maxDate]="maxDateNaissance"
                    placement="bottom"
                    formControlName="dateNaissance"
                    #dateAyantDroit="ngbDatepicker"
                    ngbDatepicker
                    maxlength="10"
                    required
                    dateFr
                    [ngClass]="{
                      'is-invalid':
                        submitted &&
                        ayantsDroits.controls[i].get('dateNaissance')?.errors
                    }"
                  />

                  <button
                    type="button"
                    [attr.aria-label]="
                      'Sélectionner une date de naissance de l\'ayant-droit ' +
                      i +
                      1
                    "
                    class="input-group-text btn btn-outline-primary"
                    (click)="dateAyantDroit.toggle()"
                  >
                    <fa-icon [icon]="['fas', 'calendar']"></fa-icon>
                  </button>

                  <p
                    *ngIf="
                      submitted &&
                      ayantsDroits.controls[i].get('dateNaissance')?.errors
                    "
                    class="invalid-feedback"
                  >
                    La date de naissance est obligatoire
                  </p>
                </div>
              </div>
              <div class="col form-group required">
                <label for="lien_{{ i }}">Lien </label>
                <select
                  id="lien_{{ i }}"
                  required
                  formControlName="lien"
                  [attr.aria-label]="
                    'Lien de parenté de l\'ayant-droit ' + i + 1
                  "
                  [ngClass]="{
                    'is-invalid':
                      submitted && ayantsDroits.controls[i].get('lien')?.errors
                  }"
                  class="form-select"
                >
                  <option></option>
                  <option
                    *ngFor="let lien of LIEN_PARENTE_LABELS | keyvalue"
                    [ngValue]="lien.key"
                  >
                    {{ lien.value }}
                  </option>
                </select>
                <p
                  *ngIf="
                    submitted && ayantsDroits.controls[i].get('lien')?.errors
                  "
                  class="invalid-feedback"
                >
                  Veuillez sélectionner un lien de parenté
                </p>
              </div>
              <div class="col-md-1">
                <label for="delete-ad-{{ i }}">Action</label>
                <button
                  id="delete-ad-{{ i }}"
                  type="button"
                  (click)="deleteAyantDroit(i)"
                  class="btn btn-danger"
                  title="Supprimer l'ayant-droit {{ i }}"
                >
                  <fa-icon [icon]="['fas', 'trash']"></fa-icon>
                </button>
              </div>
            </div>
          </fieldset>
          <button
            type="button"
            (click)="addAyantDroit()"
            class="btn btn-primary"
          >
            <fa-icon [icon]="['fas', 'plus']"></fa-icon>
            Ajouter des ayants droits
          </button>
          <br />
          <br />
          <br />
        </ng-container>

        <div class="col-md-4 my-4 offset-md-4 text-center">
          <button
            [disabled]="loading"
            type="submit"
            class="btn btn-primary btn-block"
          >
            <span *ngIf="!loading">
              Suivant <fa-icon [icon]="['fas', 'angle-right']"></fa-icon>
            </span>

            <span *ngIf="loading"
              ><fa-icon [icon]="['fas', 'circle-notch']" [spin]="true">
              </fa-icon>
              Veuillez patienter...</span
            >
          </button>
        </div>
      </form>
    </section>
  </div>

  <app-step-footer *ngIf="usager.ref" [(usager)]="usager"></app-step-footer>

  <app-delete-usager-menu
    [me]="me"
    [(usager)]="usager"
    class="my-4"
  ></app-delete-usager-menu>
</div>
