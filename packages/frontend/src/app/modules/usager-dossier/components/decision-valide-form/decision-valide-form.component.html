<form [formGroup]="valideForm" (ngSubmit)="setDecisionValide()">
  <p class="fr-text--sm fr-mb-2w">Les champs suivis d'un sont obligatoires</p>

  <div class="fr-grid-row fr-grid-row--gutter">
    <div class="fr-col-12 fr-col-md-6">
      <div
        class="fr-input-group"
        [ngClass]="{
          'fr-input-group--error':
            (v.dateDebut.dirty || submitted) && v.dateDebut.errors
        }"
      >
        <label class="fr-label" for="dateDebutValide">
          Date de début de la domiciliation
        </label>
        <div class="fr-input-wrap fr-input-wrap--action">
          <input
            class="fr-input"
            placeholder="jj/mm/aaaa"
            [minDate]="minDate"
            [maxDate]="maxDate"
            placement="auto"
            ngbDatepicker
            id="dateDebutValide"
            formControlName="dateDebut"
            name="dateDebut"
            #dDebut="ngbDatepicker"
            appDateFr
            value
            [attr.aria-invalid]="
              (v.dateDebut.dirty || submitted) && v.dateDebut.errors
                ? 'true'
                : 'false'
            "
            [attr.aria-describedby]="
              (v.dateDebut.dirty || submitted) && v.dateDebut.errors
                ? 'date-debut-errors'
                : null
            "
            maxlength="10"
            required
          />
          <button
            type="button"
            aria-label="Ouvrir le calendrier"
            class="fr-btn fr-btn--tertiary fr-btn--icon-right d-print-none"
            (click)="dDebut.toggle()"
          >
            <span class="fr-icon-calendar-line" aria-hidden="true"></span>
          </button>
        </div>
        @if ((v.dateDebut.dirty || submitted) && v.dateDebut.errors) {
        <p role="alert" class="fr-error-text" id="date-debut-errors">
          La date de debut est incorrecte, exemple: 20/12/1996
        </p>
        }
      </div>
    </div>

    <div class="fr-col-12 fr-col-md-6">
      <div
        class="fr-input-group"
        [ngClass]="{
          'fr-input-group--error':
            (v.dateFin.dirty || submitted) && v.dateFin.errors
        }"
      >
        <label class="fr-label" for="dateFinValide">
          Date de fin de la domiciliation
        </label>
        <div class="fr-input-wrap fr-input-wrap--action">
          <input
            class="fr-input"
            placeholder="jj/mm/aaaa"
            [minDate]="minDate"
            [maxDate]="maxEndDate"
            placement="auto"
            ngbDatepicker
            formControlName="dateFin"
            name="dateFin"
            #dFin="ngbDatepicker"
            appDateFr
            id="dateFinValide"
            value
            [attr.aria-invalid]="
              (v.dateFin.dirty || submitted) && v.dateFin.errors
                ? 'true'
                : 'false'
            "
            [attr.aria-describedby]="
              (v.dateFin.dirty || submitted) && v.dateFin.errors
                ? 'date-fin-errors'
                : null
            "
            maxlength="10"
            required
          />
          <button
            type="button"
            aria-label="Ouvrir le calendrier"
            class="fr-btn fr-btn--tertiary fr-btn--icon-right d-print-none"
            (click)="dFin.toggle()"
          >
            <span class="fr-icon-calendar-line" aria-hidden="true"></span>
          </button>
        </div>

        @if ((v.dateFin.dirty || submitted) && v.dateFin.errors ||
        showDurationWarning || v.dateDebut.value > v.dateFin.value) {
        <div id="date-fin-errors" class="fr-error-text">
          @if (showDurationWarning) {
          <p class="fr-mb-1w">
            <span class="fr-icon-warning-fill" aria-hidden="true"></span>
            D'après la réglementation, une attestation de domiciliation doit
            être valable pendant un an.
          </p>
          } @if (v.dateFin.errors) {
          <p class="fr-mb-1w">
            La date de fin est incorrecte, exemple: 20/12/1996
          </p>
          } @if (v.dateDebut.value > v.dateFin.value) {
          <p class="fr-mb-0">
            La date de fin doit être supérieure à la date de début
          </p>
          }
        </div>
        }
      </div>
    </div>
  </div>

  @if (lastDecision && usager.typeDom === 'RENOUVELLEMENT') {
  <div class="fr-alert fr-alert--info fr-mt-2w">
    <p class="fr-alert__description">
      La dernière domiciliation connue de
      {{ usager | fullName }} était valide du
      <strong>
        {{ lastDecision.dateDebut | date : "dd/MM/yyyy" }} au
        {{ lastDecision.dateFin | date : "dd/MM/yyyy" }}
      </strong>
    </p>
  </div>
  }

  <div class="fr-grid-row fr-grid-row--gutter fr-mt-2w">
    <div class="fr-col-12 fr-col-md-6">
      <div class="fr-input-group">
        <label class="fr-label" for="customRef">Identifiant personnalisé</label>
        <input
          type="text"
          class="fr-input"
          id="customRef"
          maxlength="30"
          formControlName="customRef"
          name="customRef"
        />
      </div>
    </div>
  </div>

  @if (duplicates.length > 0) {
  <div class="fr-mt-2w">
    <app-display-duplicates-usager
      [duplicates]="duplicates"
    ></app-display-duplicates-usager>
  </div>
  } @if (lastDomiciled.length > 0) {
  <div class="fr-mt-2w">
    <p class="fr-text--sm">
      Pour votre information, les dernières personnes domiciliées au sein de
      votre structure ont pour identifiant :
    </p>

    <ul class="fr-my-1w">
      @for (duplicateUsager of lastDomiciled; track duplicateUsager.ref) {
      <li>
        <strong>{{ duplicateUsager | fullName }}</strong>
        - {{ duplicateUsager.customRef }}
      </li>
      }
    </ul>
  </div>
  }

  <div class="fr-btns-group fr-btns-group--inline fr-btns-group--right">
    <button
      class="fr-btn fr-btn--secondary d-print-none"
      (click)="closeModals.emit()"
      type="button"
    >
      Annuler
    </button>

    <button
      class="fr-btn"
      [disabled]="v.dateDebut.value > v.dateFin.value || loading"
      type="submit"
      [attr.aria-busy]="loading"
    >
      @if (!loading) {
      <span>Confirmer la domiciliation</span>
      } @else {
      <span class="fr-spinner" role="status" aria-label="Confirmation en cours">
        <span class="fr-sr-only">Veuillez patienter...</span>
      </span>
      }
    </button>
  </div>
</form>
