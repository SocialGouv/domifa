@if (me) {
<div class="head-page">
  <div class="fr-container">
    <div class="fr-grid-row fr-grid-row--middle fr-grid-row--gutters">
      <div class="fr-col">
        <h1 class="title">Gérer les utilisateurs</h1>
      </div>
      <div class="fr-col-auto">
        <a
          class="fr-btn fr-icon-file-text-line fr-btn--icon-left fr-btn--secondary"
          routerLink="/manage/user-rights"
        >
          En savoir plus sur les rôles des utilisateurs
        </a>
      </div>
    </div>
  </div>
</div>

<div class="fr-content-container">
  <div class="fr-container">
    <div class="fr-content">
      <div class="fr-grid-row fr-grid-row--center">
        <h2 class="fr-col fr-h4">
          <span
            class="fr-icon-group-line fr-mr-1w fr-text-action-high--blue-france"
            aria-hidden="true"
          ></span>
          Utilisateurs enregistrés : {{ users.length }} utilisateurs
        </h2>

        @if (me?.role === 'admin') {
        <div class="fr-col-auto">
          <button
            type="button"
            class="fr-btn fr-btn--secondary fr-icon-user-add-line fr-btn--icon-left"
            aria-controls="register-user-modal"
            data-fr-opened="false"
          >
            Ajouter un utilisateur
          </button>
        </div>
        }
      </div>

      <div class="fr-table" id="table-users">
        <div class="fr-table__wrapper">
          <div class="fr-table__container">
            <div class="fr-table__content">
              <table [attr.aria-rowcount]="users.length">
                <caption class="fr-sr-only">
                  Liste des utilisateurs enregistrés
                </caption>
                <thead>
                  <tr>
                    <th scope="col">
                      <app-table-head-sort
                        sortKey="nom"
                        [(sortValue)]="sortValue"
                        [(currentKey)]="currentKey"
                        columnName="Nom prénom"
                      />
                    </th>
                    <th scope="col">
                      <app-table-head-sort
                        sortKey="email"
                        [(sortValue)]="sortValue"
                        [(currentKey)]="currentKey"
                        columnName="Email"
                      />
                    </th>
                    <th scope="col">
                      <app-table-head-sort
                        sortKey="createdAt"
                        [(sortValue)]="sortValue"
                        [(currentKey)]="currentKey"
                        columnName="Date d'inscription"
                      />
                    </th>
                    <th scope="col">
                      <app-table-head-sort
                        sortKey="lastLogin"
                        [(sortValue)]="sortValue"
                        [(currentKey)]="currentKey"
                        columnName="Statut"
                      />
                    </th>
                    <th scope="col">
                      <app-table-head-sort
                        sortKey="role"
                        [(sortValue)]="sortValue"
                        [(currentKey)]="currentKey"
                        columnName="Rôle"
                      />
                    </th>
                    <th scope="col">
                      <app-table-head-sort
                        sortKey="fonction"
                        [(sortValue)]="sortValue"
                        [(currentKey)]="currentKey"
                        columnName="Fonction"
                      />
                    </th>
                    @if (me?.role === 'admin') {
                    <th scope="col">Supprimer</th>
                    }
                  </tr>
                </thead>
                <tbody>
                  @for (user of users | sortArray: currentKey : sortValue; track
                  userIdTrackBy($index, user); let i = $index) {
                  <tr [attr.aria-rowindex]="i + 1">
                    <td class="fr-text--bold">{{ user | fullName }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.createdAt | date : "d MMMM y" }}</td>
                    <td>
                      <app-display-last-login
                        [lastLogin]="user.lastLogin"
                      ></app-display-last-login>
                    </td>
                    <td>
                      @if (me?.role !== 'admin') {
                      {{ USER_STRUCTURE_ROLES_LABELS[user.role] }}
                      } @if (me?.role === 'admin' && me.uuid !== user.uuid) {
                      <div class="fr-select-group">
                        <label
                          class="fr-label fr-sr-only"
                          [for]="'role-' + user.uuid"
                        >
                          Rôle de {{ user | fullName }}
                        </label>
                        <select
                          class="fr-select"
                          [disabled]="loading"
                          [attr.aria-busy]="loading"
                          [id]="'role-' + user.uuid"
                          [(ngModel)]="user.role"
                          (ngModelChange)="onRoleChange(user, user.role)"
                        >
                          <option value="admin">Administrateur</option>
                          <option value="responsable">Gestionnaire</option>
                          <option value="simple">Instructeur</option>
                          <option value="facteur">Facteur</option>
                          <option value="agent">Agent d'accueil</option>
                        </select>
                      </div>
                      }
                    </td>
                    <td>{{ user | fonctionFormat }}</td>
                    @if (me?.role === 'admin') {
                    <td>
                      @if (me.uuid !== user.uuid) {
                      <button
                        type="button"
                        class="fr-btn fr-btn--secondary fr-icon-delete-line"
                        (click)="openDeleteConfirmation(user)"
                        [attr.aria-label]="
                          'Supprimer le compte de ' +
                          user.nom +
                          ' ' +
                          user.prenom
                        "
                      >
                        Supprimer
                      </button>
                      }
                    </td>
                    }
                  </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@if (me?.role === 'admin') {
<app-register-user-admin (getUsers)="getUsers()" />
} }

<dsfr-modal
  #deleteModal
  dialogId="delete-user-modal"
  [size]="'LG'"
  titleModal="Suppression du compte de {{ selectedUser?.nom }} {{
    selectedUser?.prenom
  }}"
>
  <app-delete-user
    [selectedUser]="selectedUser"
    (deleteComplete)="getUsers()"
  />
</dsfr-modal>
