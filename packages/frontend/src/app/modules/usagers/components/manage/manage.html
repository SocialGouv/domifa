<div class="head-page">
  <div class="container">
    <div class="row d-flex align-items-center">
      <div class="col-2">
        <span class="title"> Domiciliés </span>
      </div>
      <div class="col-6">
        <div id="searchbar">
          <span id="search_icon">
            <fa-icon icon="search"></fa-icon>
          </span>
          <input
            type="text"
            [(ngModel)]="searchString"
            #searchInput
            autofocus
            placeholder="Recherche par numéro de domicilié, nom, prénom ou ayant-droit"
            class="form-control"
          />
          <span
            *ngIf="searchInput.value?.trim() !== ''"
            (click)="resetSearchBar()"
            id="times_icon"
          >
            <fa-icon icon="times-circle"></fa-icon>
          </span>
        </div>
      </div>
      <div class="col-4 text-right">
        <a
          *ngIf="me.role !== 'facteur'"
          routerLink="/nouveau"
          class="btn btn-white-primary"
        >
          <fa-icon icon="plus" class="btn-icon"></fa-icon>
          Créer une demande
        </a>
      </div>
    </div>

    <div id="statut-selector" class="mt-4 row">
      <div
        class="col"
        [ngClass]="{'selected-statut' : filters.statut === 'TOUS' }"
        (click)="updateFilters('statut', 'TOUS')"
      >
        <span class="statut-cpt">
          {{ allUsagersByStatus?.TOUS.length || 0 }}
        </span>
        <span class="statut-label"> Tous</span>
      </div>
      <div
        class="col"
        [ngClass]="{'selected-statut' :filters.statut === 'VALIDE' }"
        (click)="updateFilters('statut', 'VALIDE')"
      >
        <span class="statut-cpt"
          >{{ allUsagersByStatus?.VALIDE.length || 0 }}
        </span>
        <span class="statut-label"> Actifs</span>
      </div>
      <div
        class="col"
        [ngClass]="{'selected-statut' : filters.statut === 'INSTRUCTION' }"
        (click)="updateFilters('statut', 'INSTRUCTION')"
      >
        <span class="statut-cpt"
          >{{ allUsagersByStatus?.INSTRUCTION.length || 0 }}
        </span>
        <span class="statut-label"> À compléter</span>
      </div>
      <div
        class="col"
        [ngClass]="{'selected-statut' : filters.statut === 'ATTENTE_DECISION' }"
        (click)="updateFilters('statut', 'ATTENTE_DECISION')"
      >
        <span class="statut-cpt"
          >{{ allUsagersByStatus?.ATTENTE_DECISION.length || 0 }}
        </span>
        <span class="statut-label">Attente de décision</span>
      </div>
      <div
        class="col"
        [ngClass]="{'selected-statut' :filters.statut === 'REFUS' }"
        (click)="updateFilters('statut', 'REFUS')"
      >
        <span class="statut-cpt"
          >{{ allUsagersByStatus?.REFUS.length || 0 }}
        </span>
        <span class="statut-label">Refusés</span>
      </div>
      <div
        class="col"
        [ngClass]="{'selected-statut' :filters.statut === 'RADIE' }"
        (click)="updateFilters('statut', 'RADIE')"
      >
        <span class="statut-cpt">
          {{ allUsagersByStatus?.RADIE.length || 0 }}
        </span>
        <span class="statut-label"> Radiés</span>
      </div>
    </div>
  </div>
</div>

<div id="filters" class="py-4">
  <div class="container">
    <div class="row d-flex align-items-center">
      <div class="col-md-8">
        <div *ngIf="nbResults" class="filter-part">
          Filtrer les <span class="text-primary"> {{nbResults}} </span>résultats
        </div>
        <div *ngIf="!nbResults" class="filter-part">Aucun résultat</div>

        <div
          *ngIf="filters.statut === 'TOUS' || filters.statut === 'VALIDE'"
          class="filter-part"
        >
          <div class="d-inline-block" *ngIf="filters.passage">
            <button
              class="btn selected-btn"
              (click)="updateFilters('passage',null)"
            >
              {{ labelsDernierPassage[filters.passage] }}
              <fa-icon icon="times" class="cross"></fa-icon>
            </button>
          </div>

          <div
            ngbDropdown
            *ngIf="!filters.passage"
            id="dropdownDernierPassage"
            display="dynamic"
            placement="bottom-left"
            class="d-inline-block"
          >
            <button class="btn" id="dropdownManual" ngbDropdownToggle>
              <span>Dernier passage</span>
            </button>
            <div
              ngbDropdownMenu
              aria-labelledby="navbarDropdown2"
              class="dropdown-menu"
            >
              <button
                (click)="updateFilters('passage', 'DEUX_MOIS')"
                ngbDropdownItem
              >
                Plus de 2 mois
              </button>
              <button
                (click)="updateFilters('passage', 'TROIS_MOIS')"
                ngbDropdownItem
              >
                Plus de 3 mois
              </button>
            </div>
          </div>
        </div>

        <div
          *ngIf="filters.statut === 'TOUS' || filters.statut === 'VALIDE'"
          class="filter-part text-left"
        >
          <div class="d-inline-block" *ngIf="filters.echeance">
            <button
              class="btn selected-btn"
              (click)="updateFilters('echeance',null)"
            >
              {{ labelsEcheance[filters.echeance] }}
              <fa-icon icon="times" class="cross"></fa-icon>
            </button>
          </div>
          <div
            *ngIf="!filters.echeance"
            ngbDropdown
            id="dropdownEcheance"
            display="dynamic"
            placement="bottom-right"
            class="d-inline-block"
          >
            <button class="btn" id="dropdownManual" ngbDropdownToggle>
              <span>Échéance de domiciliation</span>
            </button>

            <div
              ngbDropdownMenu
              aria-labelledby="navbarDropdown2"
              class="dropdown-menu dropdown-menu-right"
            >
              <button
                (click)="updateFilters('echeance', 'DEUX_MOIS')"
                ngbDropdownItem
              >
                Moins de 2 mois
              </button>
              <button
                (click)="updateFilters('echeance', 'DEUX_SEMAINES')"
                ngbDropdownItem
              >
                Moins de 2 semaines
              </button>
              <button
                (click)="updateFilters('echeance', 'DEPASSEE')"
                ngbDropdownItem
              >
                Dépassée
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="filters.statut !== 'REFUS'" class="filter-part">
          <div
            ngbDropdown
            id="dropdownDernierPassage"
            display="dynamic"
            placement="bottom-left"
            class="d-inline-block"
          >
            <div class="d-inline-block" *ngIf="filters.interactionType">
              <button
                class="btn selected-btn"
                (click)="updateFilters('interactionType',null)"
              >
                Courrier à récupérer
                <fa-icon icon="times" class="cross"></fa-icon>
              </button>
            </div>
            <button
              *ngIf="!filters.interactionType"
              class="btn"
              id="dropdownManual"
              ngbDropdownToggle
            >
              <span>Courriers à récupérer</span>
            </button>
            <div
              ngbDropdownMenu
              aria-labelledby="navbarDropdown2"
              class="dropdown-menu"
            >
              <button
                (click)="updateFilters('interactionType', 'courrierIn')"
                ngbDropdownItem
              >
                Courrier à récupérer
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4 text-right">
        <div
          ngbDropdown
          id="dropdownSort"
          placement="bottom-right"
          class="d-inline-block"
        >
          <div class="" id="dropdownSortButton" ngbDropdownToggle>
            <span *ngIf="filters.sortKey !== 'PASSAGE'">
              Trier par
              <b class="text-primary">{{ sortLabels[filters.sortKey] }}</b>
            </span>

            <span *ngIf="filters.sortKey === 'PASSAGE'">
              Trier par <b class="text-primary">dernier passage</b>
            </span>

            <fa-icon
              *ngIf="filters.sortValue === 'ascending'"
              icon="sort-amount-up"
            ></fa-icon>
            <fa-icon
              *ngIf="filters.sortValue === 'descending'"
              icon="sort-amount-down"
            ></fa-icon>
          </div>
          <div
            ngbDropdownMenu
            aria-labelledby="navbarDropdown2"
            class="dropdown-menu dropdown-menu-right"
          >
            <button
              (click)="updateFilters('sortKey', 'NAME', 'ascending')"
              ngbDropdownItem
            >
              Trier par nom <fa-icon icon="sort-amount-up"></fa-icon>
            </button>
            <button
              (click)="updateFilters('sortKey', 'NAME', 'descending')"
              ngbDropdownItem
            >
              Trier par nom <fa-icon icon="sort-amount-down"></fa-icon>
            </button>
            <button
              (click)="updateFilters('sortKey', 'ID', 'ascending')"
              ngbDropdownItem
            >
              Trier par ID <fa-icon icon="sort-amount-up"></fa-icon>
            </button>
            <button
              (click)="updateFilters('sortKey', 'ID', 'descending')"
              ngbDropdownItem
            >
              Trier par ID <fa-icon icon="sort-amount-down"></fa-icon>
            </button>

            <ng-container *ngIf="filters.statut !== 'TOUS'">
              <button
                (click)="updateFilters('sortKey', filters.statut, 'ascending')"
                ngbDropdownItem
              >
                Trier par {{ dateLabel | lowercase }}<fa-icon
                  icon="sort-amount-up"
                ></fa-icon>
              </button>
              <button
                (click)="updateFilters('sortKey', filters.statut, 'descending')"
                ngbDropdownItem
              >
                Trier par {{ dateLabel | lowercase }}<fa-icon
                  icon="sort-amount-down"
                ></fa-icon>
              </button>
            </ng-container>
            <ng-container *ngIf="filters.passage !== null">
              <button
                (click)="updateFilters('sortKey', 'PASSAGE', 'ascending')"
                ngbDropdownItem
              >
                Trier par dernier passage<fa-icon
                  icon="sort-amount-up"
                ></fa-icon>
              </button>
              <button
                (click)="updateFilters('sortKey', 'PASSAGE', 'descending')"
                ngbDropdownItem
              >
                Trier par dernier passage<fa-icon
                  icon="sort-amount-down"
                ></fa-icon>
              </button>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="content">
  <div class="container">
    <div
      *ngIf="usagers.length === 0 && !searching"
      class="my-4 alert alert-warning text-center"
    >
      <span class="mr-2">
        <b>Aucun résultat :</b>
        aucun dossier ne correspond à votre recherche
      </span>

      <button (click)="resetFilters()" class="btn btn-outline-white">
        Réinitialiser les filtres
      </button>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div
          *ngIf="searching && filters.page === 0"
          @fadeInOut
          class="text-center content-overlay"
        >
          <div *ngIf="searching" @fadeInOutSlow>
            <fa-icon
              [icon]="['fas', 'spinner']"
              class="spinner"
              [spin]="true"
            ></fa-icon>
            <br />
            <span class="loading_message">Chargement des dossiers...</span>
          </div>
        </div>

        <table class="table" *ngIf="usagers.length !== 0" id="table-usagers">
          <thead>
            <th (click)="updateFilters('sortKey', 'ID')">ID</th>
            <th (click)="updateFilters('sortKey', 'NAME')">Nom prénom</th>
            <th>INFORMATIONS</th>
            <th>DERNIER PASSAGE</th>
            <th>ÉCHÉANCE</th>
            <th class="text-left">ACTIONS RAPIDES</th>
            <th></th>
          </thead>
          <tbody *ngFor="let usager of usagers; let i = index">
            <tr [class]="usager.statutColor">
              <td (click)="goToProfil(usager)" class="text-primary">
                <span *ngIf="usager.customRef">#{{ usager.customRef }}</span>
                <span *ngIf="!usager.customRef ">#{{ usager.ref }}</span>
              </td>

              <td
                (click)="goToProfil(usager)"
                scope="row"
                class="table-name td-name"
              >
                {{ usager.nom | uppercase }} {{ usager.prenom }}
                <span *ngIf="usager.surnom && usager.surnom !== null">
                  ({{ usager.surnom }})
                </span>

                <ng-container *ngIf="filters.searchString && !searching">
                  <span class="badge badge-info" *ngIf="usager.isAyantDroit">
                    Ayant-droit
                  </span>
                </ng-container>
              </td>

              <td>
                <div
                  class="label-info label-green"
                  *ngIf="usager.ayantsDroits.length > 1"
                >
                  <span>{{ usager.ayantsDroits.length }} ayants-droit</span>
                </div>

                <div
                  class="label-info label-yellow"
                  *ngIf="usager.options.transfert.actif"
                  [ngbTooltip]="transfertActif"
                >
                  <ng-template #transfertActif>
                    <span *ngIf=" usager.options.transfert.dateFin > today">
                      <fa-icon icon="share" class="btn-icon"></fa-icon>
                      Courrier à transférer : ADRESSE ICI
                    </span>

                    <span *ngIf=" usager.options.transfert.dateFin <= today">
                      Transfert expiré le {{ usager.options.transfert.dateFin |
                      date: "dd/MM/yyyy" }}
                    </span>
                  </ng-template>

                  <span>Transfert</span>
                </div>

                <div
                  class="label-info label-yellow"
                  *ngIf="usager.options.procuration.actif"
                  [ngbTooltip]="procurationActif"
                >
                  <ng-template #procurationActif>
                    <span *ngIf=" usager.options.procuration.dateFin > today">
                      <fa-icon icon="share" class="btn-icon"></fa-icon>
                      Procuration : {{ usager.options.procuration.nom }}
                      {{ usager.options.procuration.prenom }}
                    </span>

                    <span *ngIf=" usager.options.procuration.dateFin <= today">
                      Procuration expirée : {{usager.options.procuration.dateFin
                      | date: "dd/MM/yyyy" }}
                    </span>
                  </ng-template>

                  <span>Procuration</span>
                </div>

                <div
                  *ngIf="usager.options.npai.actif"
                  class="label-info label-danger"
                >
                  <fa-icon icon="ban" class="btn-icon"></fa-icon>
                  Pli non distribuable
                </div>
              </td>
              <td (click)="goToProfil(usager)">
                {{ usager.lastInteraction.dateInteraction|date: "dd/MM/yyyy" }}
              </td>
              <td>
                <span class="statut-date" *ngIf="usager.isActif">
                  <span class="statut-signal"></span>
                  {{ usager.dateToDisplay | date: "dd/MM/yyyy" }}
                </span>
              </td>

              <td class="text-left icones_liste">
                <div
                  *ngIf="usager.isActif || (usager.decision.statut === 'RADIE' && usager.options.npai.actif !== true)"
                >
                  <div
                    ngbTooltip="Signaler un passage"
                    class="interaction-btn"
                    (click)="setAppelOuPassage(usager, 'visite')"
                  >
                    <span class="icon-passage list-icon"></span>
                  </div>
                  <div
                    ngbTooltip="Signaler un appel"
                    class="interaction-btn"
                    (click)="setAppelOuPassage(usager, 'appel')"
                  >
                    <span class="icon-appel list-icon"></span>
                  </div>
                  <div
                    ngbTooltip="Signaler l'arrivée de courrier"
                    class="interaction-btn"
                    (click)="openInteractionInModal(usager)"
                  >
                    <span class="icon-reception list-icon"></span>
                    <span class="list-icon-label">Réception</span>
                  </div>

                  <ng-template #distributionBox class="p-2 text-left">
                    <div class="distribution-tooltip">
                      <div *ngIf="usager.lastInteraction.courrierIn > 0">
                        <span class="list-icon icon-courrier"></span>
                        <span>
                          <b class="text-primary"
                            >{{ usager.lastInteraction.courrierIn }}</b
                          >
                          courriers
                        </span>
                      </div>

                      <div *ngIf="usager.lastInteraction.recommandeIn > 0">
                        <span class="list-icon icon-recommande"> </span>
                        <span>
                          <b class="text-primary"
                            >{{ usager.lastInteraction.recommandeIn }}</b
                          >
                          avis de passage</span
                        >
                      </div>

                      <div *ngIf="usager.lastInteraction.colisIn > 0">
                        <span class="list-icon icon-colis"> </span>
                        <span>
                          <b class="text-primary"
                            >{{ usager.lastInteraction.colisIn }}</b
                          >
                          colis</span
                        >
                      </div>
                    </div>
                  </ng-template>

                  <div
                    *ngIf="usager.lastInteraction.enAttente"
                    class="interaction-btn"
                    [ngbTooltip]="distributionBox"
                    (click)="openInteractionOutModal(usager)"
                  >
                    <span class="icon-distribution list-icon"></span>
                    <span class="list-icon-label">Distribuer</span>
                    <b class="notification">
                      {{ usager.totalInteractionsEnAttente }}
                    </b>
                  </div>
                </div>
              </td>

              <td (click)="goToProfil(usager)">
                <div class="svg-icon icon-arrow"></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<ng-template #setInteractionInModal let-modal>
  <app-set-interaction-in-form
    [(usager)]="selectedUsager"
    (usagerChange)="updateUsager($event)"
    (cancelReception)="cancelReception()"
  ></app-set-interaction-in-form>
</ng-template>

<ng-template #setInteractionOutModal let-modal>
  <app-set-interaction-out-form
    [(usager)]="selectedUsager"
    (usagerChange)="updateUsager($event)"
    (cancelReception)="cancelReception()"
  ></app-set-interaction-out-form>
</ng-template>
