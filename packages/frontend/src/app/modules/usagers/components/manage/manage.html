<div class="content">
  <div class="container">
    <br />

    <div id="filters" class="row">
      <div
        class="col"
        [ngClass]="filters.statut === 'TOUS' ? 'filter-primary' : 'filter-dark'"
        (click)="updateFilters('statut', 'TOUS')"
      >
        Tous ({{ allUsagersByStatus?.TOUS.length || 0 }})
      </div>
      <div
        class="col"
        [ngClass]="filters.statut === 'VALIDE' ? 'filter-primary' : 'filter-dark'"
        (click)="updateFilters('statut', 'VALIDE')"
      >
        Actifs ({{ allUsagersByStatus?.VALIDE.length || 0 }})
      </div>
      <div
        class="col"
        [ngClass]="filters.statut === 'INSTRUCTION' ? 'filter-warning' : 'filter-dark'"
        (click)="updateFilters('statut', 'INSTRUCTION')"
      >
        À compléter ({{ allUsagersByStatus?.INSTRUCTION.length || 0 }})
      </div>
      <div
        class="col"
        [ngClass]="filters.statut === 'ATTENTE_DECISION' ? 'filter-warning' : 'filter-dark' "
        (click)="updateFilters('statut', 'ATTENTE_DECISION')"
      >
        Attente de décision ({{ allUsagersByStatus?.ATTENTE_DECISION.length || 0
        }})
      </div>
      <div
        class="col"
        [ngClass]="filters.statut === 'REFUS' ? 'filter-danger' : 'filter-dark'  "
        (click)="updateFilters('statut', 'REFUS')"
      >
        Refusés ({{ allUsagersByStatus?.REFUS.length || 0 }})
      </div>
      <div
        class="col"
        [ngClass]="filters.statut === 'RADIE' ? 'filter-danger' : 'filter-dark'"
        (click)="updateFilters('statut', 'RADIE')"
      >
        Radiés ({{ allUsagersByStatus?.RADIE.length || 0 }})
      </div>
    </div>
    <div class="row">
      <div id="searchbar" class="form-group">
        <span id="search_icon">
          <fa-icon icon="search"></fa-icon>
        </span>
        <input
          type="text"
          [(ngModel)]="searchString"
          #searchInput
          autofocus
          placeholder="Recherche par numéro de domicilié, nom, prénom ou ayant-droit"
          class="form-control"
        />
        <span
          *ngIf="searchInput.value?.trim() !== ''"
          (click)="resetSearchBar()"
          id="times_icon"
        >
          <fa-icon icon="times-circle"></fa-icon>
        </span>
      </div>
    </div>
    <div class="row" id="filters-btn">
      <div class="col-4 text-left">
        <span>Dernier passage</span>
        <div
          class="btn-group btn-group-toggle"
          role="group"
          aria-label="Basic example"
        >
          <button
            class="btn"
            [disabled]="filters.statut !== 'TOUS' && filters.statut !== 'VALIDE'"
            (click)="updateFilters('passage', 'DEUX_MOIS')"
            [ngClass]="filters.passage === 'DEUX_MOIS' ? 'btn-dark' : 'btn-outline-dark'"
          >
            Plus de 2 mois
            <fa-icon
              *ngIf="filters.passage === 'DEUX_MOIS'"
              icon="times-circle"
            ></fa-icon>
          </button>
          <button
            class="btn"
            [disabled]="filters.statut !== 'TOUS' && filters.statut !== 'VALIDE'"
            (click)="updateFilters('passage', 'TROIS_MOIS')"
            [ngClass]="filters.passage === 'TROIS_MOIS' ? 'btn-dark' : 'btn-outline-dark'"
          >
            Plus de 3 mois
            <fa-icon
              *ngIf="filters.passage === 'TROIS_MOIS'"
              icon="times-circle"
            ></fa-icon>
          </button>
        </div>
      </div>
      <div class="col-5">
        <span>Échéance de domiciliation</span>

        <div
          class="btn-group btn-group-toggle"
          role="group"
          aria-label="Basic example"
        >
          <button
            aria-label="Moins de 2 mois"
            class="btn"
            [disabled]="filters.statut !== 'TOUS' && filters.statut !== 'VALIDE'"
            (click)="updateFilters('echeance', 'DEUX_MOIS')"
            [ngClass]="filters.echeance === 'DEUX_MOIS' ? 'btn-dark' : 'btn-outline-dark'"
          >
            Moins de 2 mois
            <fa-icon
              *ngIf="filters.echeance === 'DEUX_MOIS'"
              icon="times-circle"
            ></fa-icon>
          </button>
          <button
            aria-label="Moins de 2 semaines"
            class="btn"
            [disabled]="filters.statut !== 'TOUS' && filters.statut !== 'VALIDE'"
            (click)="updateFilters('echeance', 'DEUX_SEMAINES')"
            [ngClass]="filters.echeance === 'DEUX_SEMAINES' ? 'btn-dark' : 'btn-outline-dark'"
          >
            Moins de 2 semaines
            <fa-icon
              *ngIf="filters.echeance === 'DEUX_SEMAINES'"
              icon="times-circle"
            ></fa-icon>
          </button>
          <button
            aria-label="Dépassée"
            class="btn"
            [disabled]="filters.statut !== 'TOUS' && filters.statut !== 'VALIDE'"
            (click)="updateFilters('echeance', 'DEPASSEE')"
            [ngClass]="filters.echeance === 'DEPASSEE' ? 'btn-dark' : 'btn-outline-dark'"
          >
            Dépassée
            <fa-icon
              *ngIf="filters.echeance === 'DEPASSEE'"
              icon="times-circle"
            ></fa-icon>
          </button>
        </div>
      </div>
      <div class="col-3 text-right">
        <span>Courrier à récupérer</span>
        <div class="btn-group btn-group-toggle">
          <button
            class="btn"
            (click)="updateFilters('interactionType', 'courrierIn')"
            [disabled]="filters.statut === 'REFUS'"
            [ngClass]="filters.interactionType === 'courrierIn' ? 'btn-dark' : 'btn-outline-dark'"
          >
            Oui
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="usagers.length === 0 && !searching">
      <br />
      <br />
      <ngb-alert [dismissible]="false" type="warning">
        <div class="text-center">
          <b>Aucun résultat :</b>
          aucun dossier ne correspond à votre recherche &nbsp;&nbsp;&nbsp;
          <button (click)="resetFilters()" class="btn btn-outline-white">
            Réinitialiser les filtres
          </button>
        </div>
      </ngb-alert>
    </div>
    <div class="row">
      <div class="col-12 results-count" *ngIf="nbResults">
        {{nbResults}} résultats
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div
          *ngIf="searching && filters.page === 0"
          @fadeInOut
          class="text-center content-overlay"
        >
          <div *ngIf="searching" @fadeInOutSlow>
            <fa-icon
              [icon]="['fas', 'spinner']"
              class="spinner"
              [spin]="true"
            ></fa-icon>
            <br />
            <span class="loading_message">Chargement des dossiers...</span>
          </div>
        </div>

        <table class="table" *ngIf="usagers.length !== 0" id="table-usagers">
          <thead>
            <th class="sortable" (click)="updateFilters('sortKey', 'ID')">
              <span>ID</span>
            </th>
            <th class="sortable" (click)="updateFilters('sortKey', 'NAME')">
              <span>Nom prénom</span>
            </th>
            <th>INFORMATIONS</th>
            <th
              class="sortable"
              (click)="updateFilters('sortKey', 'PASSAGE')"
              *ngIf="filters.passage !== null"
            >
              Dernier passage
            </th>

            <th
              class="sortable"
              [ngClass]="{ 'sortable' : filters.statut !== 'TOUS' }"
              (click)="updateFilters('sortKey', filters.statut)"
            >
              {{ dateLabel }}
            </th>
            <th colspan="2" class="text-right"></th>
            <th colspan="1" class="text-right">
              <div
                ngbDropdown
                id="dropdownBasic1"
                display="dynamic"
                placement="bottom-right"
                class="d-inline-block"
              >
                <button
                  class="btn btn-outline-dark"
                  id="dropdownManual"
                  ngbDropdownToggle
                >
                  <span *ngIf="filters.sortKey !== 'PASSAGE'">
                    Trier par {{ sortLabels[filters.sortKey] }}
                  </span>

                  <span *ngIf="filters.sortKey === 'PASSAGE'">
                    Trier par dernier passage
                  </span>

                  <fa-icon
                    *ngIf="filters.sortValue === 'ascending'"
                    icon="sort-amount-up"
                  ></fa-icon>
                  <fa-icon
                    *ngIf="filters.sortValue === 'descending'"
                    icon="sort-amount-down"
                  ></fa-icon>
                </button>
                <div
                  ngbDropdownMenu
                  aria-labelledby="navbarDropdown2"
                  class="dropdown-menu dropdown-menu-right"
                >
                  <button
                    (click)="updateFilters('sortKey', 'NAME', 'ascending')"
                    ngbDropdownItem
                  >
                    Trier par nom <fa-icon icon="sort-amount-up"></fa-icon>
                  </button>
                  <button
                    (click)="updateFilters('sortKey', 'NAME', 'descending')"
                    ngbDropdownItem
                  >
                    Trier par nom <fa-icon icon="sort-amount-down"></fa-icon>
                  </button>
                  <button
                    (click)="updateFilters('sortKey', 'ID', 'ascending')"
                    ngbDropdownItem
                  >
                    Trier par ID <fa-icon icon="sort-amount-up"></fa-icon>
                  </button>
                  <button
                    (click)="updateFilters('sortKey', 'ID', 'descending')"
                    ngbDropdownItem
                  >
                    Trier par ID <fa-icon icon="sort-amount-down"></fa-icon>
                  </button>

                  <ng-container *ngIf="filters.statut !== 'TOUS'">
                    <button
                      (click)="updateFilters('sortKey', filters.statut, 'ascending')"
                      ngbDropdownItem
                    >
                      Trier par {{ dateLabel | lowercase }}<fa-icon
                        icon="sort-amount-up"
                      ></fa-icon>
                    </button>
                    <button
                      (click)="updateFilters('sortKey', filters.statut, 'descending')"
                      ngbDropdownItem
                    >
                      Trier par {{ dateLabel | lowercase }}<fa-icon
                        icon="sort-amount-down"
                      ></fa-icon>
                    </button>
                  </ng-container>
                  <ng-container *ngIf="filters.passage !== null">
                    <button
                      (click)="updateFilters('sortKey', 'PASSAGE', 'ascending')"
                      ngbDropdownItem
                    >
                      Trier par dernier passage<fa-icon
                        icon="sort-amount-up"
                      ></fa-icon>
                    </button>
                    <button
                      (click)="updateFilters('sortKey', 'PASSAGE', 'descending')"
                      ngbDropdownItem
                    >
                      Trier par dernier passage<fa-icon
                        icon="sort-amount-down"
                      ></fa-icon>
                    </button>
                  </ng-container>
                </div>
              </div>
            </th>
          </thead>
          <tbody *ngFor="let usager of usagers; let i = index">
            <tr>
              <td (click)="goToProfil(usager)" class="text-primary text-center">
                <span *ngIf="usager.customRef">#{{ usager.customRef }}</span>
                <span *ngIf="!usager.customRef ">#{{ usager.ref }}</span>
              </td>

              <td
                (click)="goToProfil(usager)"
                scope="row"
                class="table-name td-name"
              >
                <b>{{ usager.nom | uppercase }}</b>
                {{ usager.prenom }}
                <span *ngIf="usager.surnom && usager.surnom !== null">
                  ({{ usager.surnom }})
                </span>

                <ng-container *ngIf="filters.searchString && !searching">
                  <span class="badge badge-info" *ngIf="usager.isAyantDroit">
                    Ayant-droit
                  </span>
                </ng-container>
              </td>

              <td>INFOS</td>
              <td
                class="text-center"
                (click)="goToProfil(usager)"
                *ngIf="filters.passage !== null"
              >
                {{ usager.lastInteraction.dateInteraction | date: "dd/MM/yyyy"
                }}
              </td>
              <td
                class="text-center"
                (click)="goToProfil(usager)"
                *ngIf="filters.passage !== null"
              >
                {{ usager.decision.dateDebut | date: "dd/MM/yyyy" }}
              </td>

              <td (click)="goToProfil(usager)" *ngIf="filters.passage === null">
                <span
                  *ngIf="usager.decision.statut === 'REFUS' || usager.decision.statut === 'RADIE'"
                  class="text-danger font-weight-bold"
                >
                  {{ usager.decision.dateFin | date: "dd/MM/yyyy" }}
                </span>
                <span
                  *ngIf="usager.decision.statut === 'VALIDE'"
                  [ngClass]="{
                'font-weight-bold':  usager.dayBeforeEnd < 60,
                'text-danger': usager.dayBeforeEnd < 15,
                'text-warning': usager.dayBeforeEnd > 15 && usager.dayBeforeEnd < 60
              }"
                >
                  {{ usager.decision.dateFin | date: "dd/MM/yyyy" }}
                </span>
                <span
                  *ngIf="usager.decision.statut === 'INSTRUCTION' || usager.decision.statut === 'ATTENTE_DECISION'"
                >
                  {{ usager.decision.dateDecision | date: "dd/MM/yyyy" }}
                </span>
              </td>
              <td class="text-right icones_liste">
                <div
                  *ngIf="
              usager.decision.statut === 'VALIDE' ||
              (usager.decision.statut === 'INSTRUCTION' && usager.typeDom === 'RENOUVELLEMENT') ||
              (usager.decision.statut === 'ATTENTE_DECISION' && usager.typeDom === 'RENOUVELLEMENT') ||
              (usager.decision.statut === 'RADIE' && usager.options.npai.actif !== true)
            "
                >
                  <ng-template #colisAttente>
                    {{ usager.lastInteraction.colisIn }} colis et {{
                    usager.lastInteraction.recommandeIn }} avis de passage en
                    attente
                  </ng-template>
                  <span
                    (click)="goToProfil(usager)"
                    *ngIf="usager.lastInteraction.recommandeIn > 0 || usager.lastInteraction.colisIn > 0"
                    [ngbTooltip]="colisAttente"
                  >
                    <b class="notification"
                      >{{ usager.lastInteraction.colisIn +
                      usager.lastInteraction.recommandeIn }}</b
                    >
                    <fa-icon class="courrier" icon="mail-bulk"></fa-icon>
                  </span>

                  <span
                    (click)="setInteraction(usager, 'courrierOut')"
                    *ngIf="usager.lastInteraction.courrierIn > 0"
                    ngbTooltip="Signaler un retrait de courrier"
                  >
                    <fa-icon
                      class="courrier"
                      icon="envelope-open-text"
                    ></fa-icon>
                    <b class="notification"
                      >{{ usager.lastInteraction.courrierIn }}</b
                    >
                  </span>

                  <span
                    (click)="setInteraction(usager, 'courrierIn')"
                    ngbTooltip="Ajouter un nouveau courrier"
                  >
                    <fa-icon class="courrier" icon="envelope"></fa-icon>
                  </span>
                  <span
                    ngbTooltip="Signaler un passage"
                    (click)="setInteraction(usager, 'visite')"
                  >
                    <fa-icon class="visite" icon="walking"></fa-icon>
                  </span>
                  <span
                    ngbTooltip="Signaler un appel"
                    (click)="setInteraction(usager, 'appel')"
                  >
                    <fa-icon class="appel" icon="phone"></fa-icon>
                  </span>
                </div>
              </td>

              <td
                (click)="goToProfil(usager)"
                class="text-center usager_informations"
              >
                <span
                  class="text-danger font-weight-bold"
                  *ngIf="usager.options.npai.actif"
                >
                  <fa-icon icon="ban" class="btn-icon"></fa-icon>
                  Pli non distribuable
                </span>
                <span
                  class="text-warning"
                  *ngIf="usager.options.transfert.actif && usager.options.transfert.dateFin > today"
                >
                  <fa-icon icon="share" class="btn-icon"></fa-icon>
                  Courrier à transférer
                </span>
                <span
                  class="text-danger"
                  *ngIf="usager.options.transfert.actif && usager.options.transfert.dateFin <= today"
                >
                  Transfert expiré le {{ usager.options.transfert.dateFin |
                  date: "dd/MM/yyyy" }}
                </span>
                <span
                  class="text-warning"
                  *ngIf="usager.options.procuration.actif && usager.options.procuration.dateFin > today"
                >
                  <fa-icon
                    icon="exclamation-triangle"
                    class="btn-icon"
                  ></fa-icon>
                  Procuration : {{ usager.options.procuration.nom }}
                  {{ usager.options.procuration.prenom }}
                </span>
                <span
                  class="text-danger"
                  *ngIf="usager.options.procuration.actif && usager.options.procuration.dateFin <= today"
                >
                  <fa-icon
                    icon="exclamation-triangle"
                    class="btn-icon"
                  ></fa-icon>
                  Procuration expirée : {{ usager.options.procuration.dateFin |
                  date: "dd/MM/yyyy" }}
                </span>

                <span
                  *ngIf="filters.statut === 'ATTENTE_DECISION' || filters.statut === 'INSTRUCTION' "
                >
                  <span
                    class="text-secondary"
                    *ngIf="usager.typeDom === 'RENOUVELLEMENT'"
                  >
                    Renouvellement en cours
                  </span>
                  <span *ngIf="usager.typeDom !== 'RENOUVELLEMENT'">
                    Première demande
                  </span>
                </span>

                <span
                  *ngIf="filters.statut === 'TOUS'"
                  class="font-weight-bold"
                >
                  <span
                    *ngIf="usager.decision.statut === 'INSTRUCTION'"
                    class="text-warning2"
                  >
                    <fa-icon [icon]="['far', 'clock']"></fa-icon>
                    Dossier à compléter
                  </span>
                  <span
                    *ngIf="usager.decision.statut === 'ATTENTE_DECISION'"
                    class="text-dark"
                  >
                    Demande en cours
                  </span>
                  <span
                    *ngIf="usager.decision.statut === 'REFUS'"
                    class="text-danger"
                  >
                    Demande refusée
                  </span>
                  <span
                    *ngIf="usager.decision.statut === 'RADIE'"
                    class="text-danger"
                  >
                    Radié
                  </span>
                </span>
              </td>

              <td (click)="goToProfil(usager)">></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<ng-template #distributionConfirm let-modal>
  <div class="modal-header">
    <h4 class="modal-title">
      <fa-icon icon="exclamation-triangle"></fa-icon>
      Attention, procuration active !
    </h4>
    <button
      type="button"
      class="close"
      aria-label="Fermer la fenêtre"
      (click)="closeModals()"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body text-center">
    Qui est venu récupérer le courrier ?
    <br />
    <br />
    <button
      (click)="setInteraction(selectedUsager, 'courrierOut', true)"
      class="btn btn-outline-primary"
    >
      <b>LE MANDATAIRE</b>
      <br />
      {{ selectedUsager.options.procuration.nom | uppercase }} {{
      selectedUsager.options.procuration.prenom }}
    </button>
    &nbsp;&nbsp;
    <button
      (click)="setInteraction(selectedUsager, 'courrierOut', false)"
      class="btn btn-outline-primary"
    >
      <b>LE DOMICILIÉ</b>
      <br />
      {{ selectedUsager.nom }} {{ selectedUsager.prenom }}
    </button>
  </div>
  <div class="modal-footer">
    <button class="btn btn-outline-dark" (click)="closeModals()">
      Revenir à la liste
    </button>
  </div>
</ng-template>
