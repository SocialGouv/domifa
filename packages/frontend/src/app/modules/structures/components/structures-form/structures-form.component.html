<div class="head-page py-4">
  <div class="container">
    <h1
      class="title"
      *ngIf="structureRegisterInfos.etapeInscription === 0 && structureForm"
    >
      Inscription de votre structure sur DomiFa : étape 1 sur 2, informations de
      la structure
    </h1>
    <h1 class="title" *ngIf="structureRegisterInfos.etapeInscription === 1">
      Inscription de votre structure sur DomiFa : étape 2 sur 2, création du
      compte administrateur
    </h1>
  </div>
</div>
<div class="content py-3">
  <div class="container py-3">
    <div
      class="step-form"
      *ngIf="structureRegisterInfos.etapeInscription === 0 && structureForm"
    >
      <form [formGroup]="structureForm" (ngSubmit)="submitStrucutre()">
        <fieldset class="text-center">
          <legend>Vous appartenez à quel type de structure</legend>
          <div class="btn-group btn-group-toggle required">
            <label
              for="cias"
              class="btn py-3 px-4"
              [ngClass]="{
                'btn-primary': f.structureType.value === 'cias',
                'btn-outline-primary': f.structureType.value !== 'cias',
                'btn-outline-danger':
                  submitted && f.structureType.value === null
              }"
            >
              <input
                id="cias"
                formControlName="structureType"
                type="radio"
                value="cias"
              />
              CIAS / COMMUNE
            </label>
            <label
              for="ccas"
              class="btn py-3 px-4"
              [ngClass]="{
                'btn-primary': f.structureType.value === 'ccas',
                'btn-outline-primary': f.structureType.value !== 'ccas',
                'btn-outline-danger':
                  submitted && f.structureType.value === null
              }"
            >
              <input
                formControlName="structureType"
                type="radio"
                id="ccas"
                value="ccas"
              />
              CCAS
            </label>
            <label
              for="asso"
              class="btn py-3 px-4"
              [ngClass]="{
                'btn-primary': f.structureType.value === 'asso',
                'btn-outline-primary': f.structureType.value !== 'asso',
                'btn-outline-danger':
                  submitted && f.structureType.value === null
              }"
            >
              <input
                formControlName="structureType"
                type="radio"
                value="asso"
                id="asso"
              />
              Organisme agréé
            </label>
          </div>
          <p
            *ngIf="submitted && f.structureType.value === null"
            class="py-2 text-danger text-center"
          >
            Veuillez sélectionner un des types d'organismes suivants :
            CIAS/Commune, CCAS ou organisme agréé
          </p>
        </fieldset>

        <p class="text-left my-3">
          Les champs suivis d'un
          <span class="fw-bold text-danger">*</span> sont obligatoires
        </p>
        <p class="text-left my-3">
          Veuillez saisir les coordonnées de votre structure, celles-ci
          apparaitront sur le Cerfa d’attestation :
        </p>

        <div class="row">
          <div class="col-md-12 form-group required">
            <label for="nom">Raison sociale (nom de la structure)</label>
            <input
              type="text"
              class="form-control"
              id="nom"
              autocomplete="organization"
              formControlName="nom"
              [ngClass]="{
                'is-invalid': (f.nom.dirty || submitted) && f.nom.errors
              }"
              [attr.aria-invalid]="
                (f.adresse.dirty || submitted) && f.nom.errors ? true : false
              "
              [attr.aria-describedby]="
                (f.nom.dirty || submitted) && f.nom.errors
                  ? 'nom-errors'
                  : 'nom-structure-description'
              "
              required
            />
            <p
              *ngIf="(f.nom.dirty || submitted) && f.nom.errors"
              id="nom-errors"
              class="invalid-feedback"
            >
              Le nom de la structure est requis
            </p>
            <p
              id="nom-structure-description"
              class="font-italic small mt-1"
              [ngClass]="{
                'text-danger': isInvalidStructureName(f.nom.value)
              }"
            >
              <b
                >Préciser le nom de votre ville / de votre unité locale en cas
                de réseau / de votre association.</b
              >
              <br />
              Ex : CCAS du Havre / Croix Rouge de Paris / Association Aurore
            </p>
          </div>
        </div>

        <fieldset>
          <legend class="visually-hidden">
            Adresse complète de la structure
          </legend>
          <div class="row">
            <div class="col-12 col-md-12 form-group required">
              <label for="adresse">Adresse de l'organisme domiciliataire</label>
              <input
                id="adresse"
                type="text"
                class="form-control"
                formControlName="adresse"
                autcomplete="street-address"
                [ngClass]="{
                  'is-invalid':
                    (f.adresse.dirty || submitted) && f.adresse.errors
                }"
                [attr.aria-invalid]="
                  (f.adresse.dirty || submitted) && f.adresse.errors
                    ? true
                    : false
                "
                [attr.aria-describedby]="
                  (f.adresse.dirty || submitted) && f.adresse.errors
                    ? 'address-errors'
                    : 'address-description'
                "
                required
              />
              <small id="address-description"
                >Cette adresse apparaîtra sur le Cerfa</small
              >
              <p
                *ngIf="submitted && f.adresse.errors"
                class="invalid-feedback"
                id="address-errors"
              >
                L'adresse est obligatoire
              </p>
            </div>

            <div class="col-md-12 form-group">
              <label for="complementAdresse">Complément d'adresse</label>
              <input
                type="text"
                class="form-control"
                id="complementAdresse"
                formControlName="complementAdresse"
                [ngClass]="{
                  'is-invalid':
                    (f.complementAdresse.dirty || submitted) &&
                    f.complementAdresse.errors
                      ? true
                      : false
                }"
                [attr.aria-describedby]="
                  (f.complementAdresse.dirty || submitted) &&
                  f.complementAdresse.errors
                    ? 'complement-errors'
                    : 'complement-description'
                "
                [attr.aria-invalid]="
                  (f.complementAdresse.dirty || submitted) &&
                  f.complementAdresse.errors
                    ? true
                    : false
                "
              />
              <small id="complement-description"
                >Lieu-dit, Bâtiment, étage, etc..</small
              >
              <p
                *ngIf="submitted && f.complementAdresse.errors"
                class="invalid-feedback"
                id="complement-errors"
              >
                Veuillez vérifier le complément d'adresse
              </p>
            </div>
            <div class="col-12 col-md-6 form-group required">
              <label for="codePostal">Code postal</label>
              <input
                type="text"
                class="form-control"
                id="codePostal"
                maxlength="5"
                formControlName="codePostal"
                [ngClass]="{
                  'is-invalid':
                    (f.codePostal.dirty || submitted) && f.codePostal.errors
                }"
                [attr.aria-describedby]="
                  (f.codePostal.dirty || submitted) && f.codePostal.errors
                    ? 'code-postal-errors'
                    : null
                "
                [attr.aria-invalid]="
                  (f.codePostal.dirty || submitted) && f.codePostal.errors
                    ? true
                    : false
                "
                required
              />
              <p
                *ngIf="f.codePostal.errors"
                id="code-postal-errors"
                class="invalid-feedback"
              >
                Le code postal est obligatoire (Exemple: 75001)
              </p>
            </div>
            <div class="col-12 col-md-6 form-group required">
              <label for="ville">Ville</label>
              <input
                type="text"
                class="form-control"
                id="ville"
                formControlName="ville"
                required
                [ngClass]="{
                  'is-invalid': (f.ville.dirty || submitted) && f.ville.errors
                }"
                [attr.aria-describedby]="
                  (f.ville.dirty || submitted) && f.ville.errors
                    ? 'ville-errors'
                    : null
                "
                [attr.aria-invalid]="
                  (f.ville.dirty || submitted) && f.ville.errors ? true : false
                "
              />
              <p
                *ngIf="(f.ville.dirty || submitted) && f.ville.errors"
                id="ville-errors"
                class="invalid-feedback"
              >
                La ville est obligatoire
              </p>
            </div>
          </div>
        </fieldset>

        <div formGroupName="adresseCourrier">
          <div class="row">
            <div class="col-md-12">
              <div class="form-check form-group">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="actif"
                  value="true"
                  id="adresseCourrier"
                />
                <label class="form-check-label" for="adresseCourrier">
                  L'adresse de réception du courrier est différente de celle de
                  l'organisme domiciliataire ?
                </label>
              </div>
            </div>
          </div>

          <fieldset
            *ngIf="f.adresseCourrier.get('actif')?.value === true"
            class="my-2"
          >
            <legend class="visually-hidden">
              Informations sur l'adresse de réception du courrier
            </legend>
            <div class="row">
              <div class="col-12 col-md-12 form-group required">
                <label for="adresse2">Adresse de réception du courrier</label>
                <input
                  type="text"
                  class="form-control"
                  id="adresse2"
                  formControlName="adresse"
                  autcomplete="street-address"
                  [ngClass]="{
                    'is-invalid':
                      (submitted || f.adresseCourrier.get('adresse')?.dirty) &&
                      f.adresseCourrier.get('adresse')?.errors
                  }"
                  [attr.aria-describedby]="
                    (submitted || f.adresseCourrier.get('adresse')?.dirty) &&
                    f.adresseCourrier.get('adresse')?.errors
                      ? 'adresse-reception-errors'
                      : null
                  "
                  [attr.aria-invalid]="
                    (submitted || f.adresseCourrier.get('adresse')?.dirty) &&
                    f.adresseCourrier.get('adresse')?.errors
                      ? true
                      : false
                  "
                  required
                />
                <p
                  *ngIf="
                    (submitted || f.adresseCourrier.get('adresse')?.dirty) &&
                    f.adresseCourrier.get('adresse')?.errors
                  "
                  id="adresse-reception-errors"
                  class="invalid-feedback"
                >
                  L'adresse de réception est obligatoire
                </p>
              </div>
              <div class="col-12 col-md-6 form-group required">
                <label for="codePostal2">Code postal</label>
                <input
                  type="text"
                  class="form-control"
                  id="codePostal2"
                  maxlength="5"
                  formControlName="codePostal"
                  [ngClass]="{
                    'is-invalid':
                      (submitted ||
                        f.adresseCourrier.get('codePostal')?.dirty) &&
                      f.adresseCourrier.get('codePostal')?.errors
                  }"
                  [attr.aria-describedby]="
                    (submitted || f.adresseCourrier.get('codePostal')?.dirty) &&
                    f.adresseCourrier.get('codePostal')?.errors
                      ? 'code-postal-reception-errors'
                      : null
                  "
                  [attr.aria-invalid]="
                    (submitted || f.adresseCourrier.get('codePostal')?.dirty) &&
                    f.adresseCourrier.get('codePostal')?.errors
                      ? true
                      : false
                  "
                  required
                />
                <p
                  *ngIf="
                    (submitted || f.adresseCourrier.get('codePostal')?.dirty) &&
                    f.adresseCourrier.get('codePostal')?.errors
                  "
                  class="invalid-feedback"
                  id="code-postal-reception-errors"
                >
                  Le code postal est obligatoire (Exemple: 75001)
                </p>
              </div>
              <div class="col-12 col-md-6 form-group required">
                <label for="ville2">Ville</label>
                <input
                  type="text"
                  class="form-control"
                  id="ville2"
                  formControlName="ville"
                  [ngClass]="{
                    'is-invalid':
                      (submitted || f.adresseCourrier.get('ville')?.dirty) &&
                      f.adresseCourrier.get('ville')?.errors
                  }"
                  [attr.aria-describedby]="
                    (submitted || f.adresseCourrier.get('ville')?.dirty) &&
                    f.adresseCourrier.get('ville')?.errors
                      ? 'ville-reception-errors'
                      : null
                  "
                  [attr.aria-invalid]="
                    (submitted || f.adresseCourrier.get('ville')?.dirty) &&
                    f.adresseCourrier.get('ville')?.errors
                      ? true
                      : false
                  "
                  required
                />
                <p
                  *ngIf="
                    (submitted || f.adresseCourrier.get('ville')?.dirty) &&
                    f.adresseCourrier.get('ville')?.errors
                  "
                  class="invalid-feedback"
                  id="ville-reception-errors"
                >
                  La ville est obligatoire
                </p>
              </div>
            </div>
          </fieldset>
        </div>

        <fieldset class="my-2">
          <legend class="visually-hidden">
            Informations de contact de la structure
          </legend>

          <div class="row">
            <div class="col-md-6 col-12 form-group required">
              <label for="phone">Numéro de téléphone</label>
              <ngx-intl-tel-input
                [cssClass]="
                  submitted && (f.telephone.errors || f.telephone.invalid)
                    ? 'form-control is-invalid'
                    : 'form-control'
                "
                [preferredCountries]="PREFERRED_COUNTRIES"
                [enableAutoCountrySelect]="false"
                [enablePlaceholder]="true"
                [searchCountryFlag]="true"
                searchCountryPlaceholder="Choisissez votre pays"
                [searchCountryField]="[
                  SearchCountryField.Iso2,
                  SearchCountryField.Name
                ]"
                [selectedCountryISO]="CountryISO.France"
                [selectFirstCountry]="true"
                [maxLength]="15"
                [phoneValidation]="true"
                [separateDialCode]="true"
                [inputId]="'phone'"
                [numberFormat]="PhoneNumberFormat.International"
                formControlName="telephone"
              ></ngx-intl-tel-input>
              <p
                *ngIf="submitted && (f.telephone.errors || f.telephone.invalid)"
                class="invalid-feedback-custom"
              >
                Veuillez vérifier le numéro de téléphone. Ex: 0101010101
              </p>
            </div>
            <div class="col-md-6 col-12 form-group required">
              <label for="email">Adresse e-mail indiquée sur le Cerfa</label>
              <input
                type="email"
                id="email"
                formControlName="email"
                autocomplete="email"
                class="form-control"
                [ngClass]="{
                  'is-invalid': (submitted || f.email.dirty) && f.email.errors
                }"
                [attr.aria-invalid]="
                  (submitted || f.email.dirty) && f.email.errors ? true : false
                "
                [attr.aria-describedby]="
                  (submitted || f.email.dirty) && f.email.errors
                    ? 'email-errors'
                    : null
                "
                required
              />
              <div
                *ngIf="(submitted || f.email.dirty) && f.email.errors"
                id="email-errors"
                class="invalid-feedback"
              >
                <p *ngIf="f.email.errors.emailTaken">
                  <fa-icon
                    aria-hidden="true"
                    [icon]="['fas', 'exclamation-triangle']"
                  ></fa-icon>
                  L'adresse email est déjà utilisée
                </p>
                <p *ngIf="!f.email.errors.emailTaken">
                  Veuillez vérifier l'adresse email, format attendu:
                  nom@domaine.fr
                </p>
              </div>
            </div>
          </div>
        </fieldset>

        <fieldset class="my-2" *ngIf="f.structureType.value === 'asso'">
          <legend class="visually-hidden">
            Informations sur l'agrément de votre organisme
          </legend>
          <div class="row">
            <div class="col-md-12 text-center">
              <h2 class="subtitle">
                Quelles sont ses informations d’agrément ?
              </h2>
              <br />
            </div>

            <div class="col-12 col-md-6 form-group required">
              <label for="departement"
                >Préfecture ayant délivré l’agrément</label
              >
              <select
                id="departement"
                formControlName="departement"
                [ngClass]="{
                  'is-invalid':
                    (submitted || f.departement.dirty) && f.departement.errors
                }"
                [attr.aria-describedby]="
                  (submitted || f.departement.dirty) && f.departement.errors
                    ? 'departement-errors'
                    : null
                "
                [attr.aria-invalid]="
                  (submitted || f.departement.dirty) && f.departement.errors
                    ? true
                    : false
                "
                class="form-select"
                required
              >
                <option [value]="null"></option>
                <option
                  *ngFor="let departement of DEPARTEMENTS_LISTE | keyvalue"
                  [ngValue]="departement.key"
                >
                  {{ departement.key }} - {{ departement.value }}
                </option>
              </select>
              <p
                *ngIf="
                  (submitted || f.departement.dirty) && f.departement.errors
                "
                id="departement-errors"
                class="invalid-feedback"
              >
                Veuillez sélectionner un département
              </p>
            </div>

            <div class="col-12 col-md-6 form-group required">
              <label for="agrement">Numéro d'agrément</label>
              <input
                formControlName="agrement"
                class="form-control"
                required
                id="agrement"
                type="text"
                [ngClass]="{
                  'is-invalid':
                    (submitted || f.agrement.dirty) && f.agrement.errors
                }"
                [attr.aria-invalid]="
                  (submitted || f.agrement.dirty) && f.agrement.errors
                    ? true
                    : false
                "
                [attr.aria-describedby]="
                  (submitted || f.agrement.dirty) && f.agrement.errors
                    ? 'agrement-errors'
                    : 'agrement-description'
                "
              />
              <small id="agrement-description"
                >Numéro donné par la préfecture</small
              >
              <p
                *ngIf="(submitted || f.agrement.dirty) && f.agrement.errors"
                id="agrement-errors"
                class="invalid-feedback"
              >
                Veuillez insérer un numéro d'agrément
              </p>
            </div>

            <div class="col-12 col-md-6 form-group">
              <label for="capacite">Capacité d'accueil</label>
              <input
                formControlName="capacite"
                class="form-control"
                id="capacite"
                min="0"
                type="number"
                [attr.aria-describedby]="
                  (submitted || f.capacite.dirty) && f.capacite.errors
                    ? 'capacite-errors'
                    : null
                "
                [attr.aria-invalid]="
                  (submitted || f.capacite.dirty) && f.capacite.errors
                    ? true
                    : false
                "
                [ngClass]="{
                  'is-invalid':
                    (submitted || f.capacite.dirty) && f.capacite.errors
                }"
              />

              <p
                *ngIf="(submitted || f.capacite.dirty) && f.capacite.errors"
                id="capacite-errors"
                class="invalid-feedback"
              >
                La capacité doit être supérieure à 0
              </p>
            </div>
          </div>
        </fieldset>

        <fieldset class="my-2">
          <div class="text-center">
            <h2 class="form-title">Qui est son responsable légal ?</h2>
            <p>Il s’agit du nom qui apparaîtra sur le Cerfa.</p>
          </div>
          <legend class="visually-hidden">
            Informations sur le / la responsable de la structure
          </legend>

          <div class="row" formGroupName="responsable">
            <div class="col-12 col-md-6 form-group required">
              <label for="responsable-nom">Nom</label>
              <input
                type="text"
                class="form-control"
                id="responsable-nom"
                formControlName="nom"
                autocomplete="family-name"
                [attr.aria-describedby]="
                  (submitted || f.responsable.get('nom')?.dirty) &&
                  f.responsable.get('nom')?.errors
                    ? 'responsable-nom-errors'
                    : null
                "
                [ngClass]="{
                  'is-invalid':
                    (submitted || f.responsable.get('nom')?.dirty) &&
                    f.responsable.get('nom')?.errors
                }"
                [attr.aria-invalid]="
                  (submitted || f.responsable.get('nom')?.dirty) &&
                  f.responsable.get('nom')?.errors
                    ? true
                    : false
                "
                required
              />
              <p
                *ngIf="
                  (submitted || f.responsable.get('nom')?.dirty) &&
                  f.responsable.get('nom')?.errors
                "
                class="invalid-feedback"
                id="responsable-nom-errors"
              >
                Le nom du responsable est obligatoire
              </p>
            </div>
            <div class="col-12 col-md-6 form-group required">
              <label for="responsable-prenom">Prénom(s)</label>
              <input
                type="text"
                class="form-control"
                id="responsable-prenom"
                formControlName="prenom"
                autocomplete="given-name"
                [ngClass]="{
                  'is-invalid':
                    (submitted || f.responsable.get('prenom')?.dirty) &&
                    f.responsable.get('prenom')?.errors
                }"
                [attr.aria-invalid]="
                  (submitted || f.responsable.get('prenom')?.dirty) &&
                  f.responsable.get('prenom')?.errors
                    ? true
                    : false
                "
                [attr.aria-describedby]="
                  (submitted || f.responsable.get('prenom')?.dirty) &&
                  f.responsable.get('prenom')?.errors
                    ? 'responsable-prenom-errors'
                    : null
                "
                required
              />
              <p
                *ngIf="
                  (submitted || f.responsable.get('prenom')?.dirty) &&
                  f.responsable.get('prenom')?.errors
                "
                class="invalid-feedback"
                id="responsable-prenom-errors"
              >
                Le prénom du responsable est obligatoire
              </p>
            </div>
            <div class="col-12 col-md-12 form-group required">
              <label for="fonction">Fonction</label>
              <input
                type="text"
                class="form-control"
                id="fonction"
                formControlName="fonction"
                autocomplete="organization-title"
                [ngClass]="{
                  'is-invalid':
                    (submitted || f.responsable.get('fonction')?.dirty) &&
                    f.responsable.get('fonction')?.errors
                }"
                [attr.aria-invalid]="
                  (submitted || f.responsable.get('fonction')?.dirty) &&
                  f.responsable.get('fonction')?.errors
                    ? true
                    : false
                "
                [attr.aria-describedby]="
                  (submitted || f.responsable.get('fonction')?.dirty) &&
                  f.responsable.get('fonction')?.errors
                    ? 'responsable-fonction-errors'
                    : 'responsable-fonction-description'
                "
                required
              />
              <small id="responsable-fonction-description"
                >Président.e, Directrice, etc.</small
              >
              <p
                *ngIf="
                  (submitted || f.responsable.get('fonction')?.dirty) &&
                  f.responsable.get('fonction')?.errors
                "
                class="invalid-feedback"
                id="responsable-fonction-errors"
              >
                La fonction du responsable est obligatoire
              </p>
            </div>
          </div>
        </fieldset>

        <fieldset class="my-2">
          <legend>Conditions générales d'utilisation de DomiFa</legend>

          <div class="row">
            <div class="col-md-12 required">
              <input
                type="checkbox"
                formControlName="readCgu"
                class="form-check-input me-2"
                [ngClass]="{
                  'is-invalid': submitted && f.readCgu?.errors
                }"
                [attr.aria-describedby]="
                  submitted && f.readCgu.errors ? 'invalid-cgu-read' : null
                "
                id="readCgu"
                required
              />
              <label class="form-check-label" for="readCgu"
                >Je confirme que le responsable de la structure a lu les
                <a routerLink="/cgu-responsable" target="_blank"
                  >CGU du responsable de structure</a
                ></label
              >
              <p
                *ngIf="submitted && f.readCgu?.errors"
                class="invalid-feedback"
                id="invalid-cgu-read"
              >
                La lecture des CGU est obligatoire
              </p>
            </div>
            <div class="col-md-12 required">
              <input
                type="checkbox"
                formControlName="acceptCgu"
                class="form-check-input me-2"
                [ngClass]="{
                  'is-invalid': submitted && f.acceptCgu?.errors
                }"
                [attr.aria-describedby]="
                  submitted && f.acceptCgu.errors ? 'invalid-cgu-choice' : null
                "
                id="acceptCgu"
                required
              />
              <label class="form-check-label" for="acceptCgu"
                >Le responsable de la structure accepte les
                <a routerLink="/cgu-responsable" target="_blank"
                  >CGU du responsable de structure</a
                ></label
              >
              <p
                *ngIf="submitted && f.acceptCgu?.errors"
                class="invalid-feedback"
                id="invalid-cgu-choice"
              >
                Vous devez accepter les CGU afin de poursuivre l'inscription
              </p>
            </div>
          </div>
        </fieldset>

        <div class="my-3 text-center">
          <button type="submit" [disabled]="loading" class="btn btn-primary">
            <span *ngIf="loading">
              <fa-icon
                aria-hidden="true"
                [icon]="['fas', 'circle-notch']"
                [spin]="true"
              >
              </fa-icon>
              Veuillez patienter...
            </span>
            <span *ngIf="!loading"> Enregistrer et continuer</span>
          </button>
        </div>
      </form>
    </div>

    <div *ngIf="structureRegisterInfos.etapeInscription === 1">
      <app-register-user
        [structureRegisterInfos]="structureRegisterInfos"
      ></app-register-user>
    </div>
  </div>
</div>
