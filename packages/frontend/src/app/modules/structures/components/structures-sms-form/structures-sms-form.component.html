<div class="head-page py-4">
  <div class="container">
    <div class="row">
      <div class="col-md-7 col-12">
        <h1 class="title">Paramètres d'envoi de SMS pour votre structure</h1>
      </div>
      <div class="text-start text-md-end col-12 col-md-5">
        <button
          (click)="openTutoModal()"
          class="btn btn-white-primary me-1"
          type="button"
        >
          <fa-icon [icon]="['fas', 'info-circle']" aria-hidden="true"></fa-icon>
          Vidéo explicative
        </button>
        <a
          href="/assets/files/guide_sms.pdf"
          target="_blank"
          class="btn btn-white-primary"
          rel="noopener noreferrer"
          download
        >
          <fa-icon aria-hidden="true" [icon]="['fas', 'info-circle']"></fa-icon>
          Télécharger le guide SMS
        </a>
      </div>
    </div>
  </div>
</div>

<div class="content py-3" *ngIf="structureSmsForm">
  <div class="container py-3">
    <div class="page-content p-4">
      <div>
        <p>
          <strong>Information importante : </strong> afin que vos domiciliés
          recoivent des SMS, veuillez compléter les 3 étapes ci-dessous:
        </p>
        <ul>
          <li>1. Activez les SMS via le formulaire ci-dessous</li>
          <li>
            2. Complétez le nom de l'expéditeur et la signature des SMS.
            <b
              >Seul des lettres peuvent être utilisés pour l'expéditeur, aucun
              numéro ne doit figurer dans l'expéditeur !</b
            >
          </li>
          <li>
            3. Dans la section <strong>dossier</strong> des fiches domiciliés,
            ajoutez un numéro de portable à chaque domicilié
          </li>
        </ul>
        <p>
          <br />
          Vous pouvez télécharger un document explicatif sur la mise en place
          des notifications SMS
          <a
            href="/assets/files/guide_sms.pdf"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Vous pouvez télécharger un document explicatif sur la mise en place
            des notifications SMS en cliquant ici "
            download
          >
            en cliquant ici.
          </a>
        </p>
      </div>
      <div class="row my-4">
        <div class="col-md-8">
          <div class="card p-4">
            <form
              *ngIf="structure"
              [formGroup]="structureSmsForm"
              (ngSubmit)="submitStructureSmsForm()"
            >
              <p>
                Les champs suivis d'un
                <span class="fw-bold text-danger">*</span> sont obligatoires
              </p>

              <fieldset
                class="d-flex justify-content-between align-items-center"
              >
                <legend class="required label">
                  Activer l'envoi de SMS pour vos domiciliés
                </legend>

                <div
                  class="btn-group"
                  role="group"
                  aria-label="Activer l'envoi de SMS pour vos domiciliés"
                >
                  <input
                    type="radio"
                    formControlName="enabledByStructure"
                    [value]="true"
                    class="btn-check"
                    id="btnradio1"
                  />
                  <label class="btn btn-outline-primary" for="btnradio1"
                    >Oui</label
                  >

                  <input
                    type="radio"
                    formControlName="enabledByStructure"
                    [value]="false"
                    class="btn-check"
                    id="btnradio2"
                  />
                  <label
                    [ngClass]="
                      form.enabledByStructure.value === false
                        ? 'btn btn-danger'
                        : 'btn btn-outline-danger'
                    "
                    for="btnradio2"
                    >Non</label
                  >
                </div>
              </fieldset>
              <div class="row">
                <div class="col-md-6 form-group required">
                  <label for="senderName">Expéditeur</label>
                  <input
                    type="text"
                    class="form-control"
                    id="senderName"
                    formControlName="senderName"
                    maxLength="11"
                    [ngClass]="{
                      'is-invalid': submitted && form.senderName.errors
                    }"
                    [attr.aria-invalid]="submitted && form.senderName.errors"
                    [attr.aria-describedby]="
                      submitted && form.senderDetails.errors
                        ? 'sender-name-errors'
                        : 'sender-name-help'
                    "
                    required
                    autocapitalize="true"
                  />
                  <small id="sender-name-help"
                    >Veuillez n'utiliser que des lettres (11 maximum)</small
                  >
                  <p
                    id="sender-name-errors"
                    *ngIf="submitted && form.senderName.errors"
                    class="invalid-feedback"
                  >
                    Le champs expéditeur est incorrect
                  </p>
                </div>

                <div class="col-md-6 form-group required">
                  <label for="senderDetails">Signature du message</label>
                  <input
                    id="senderDetails"
                    type="text"
                    class="form-control"
                    maxLength="30"
                    appCleanStr
                    formControlName="senderDetails"
                    [attr.aria-invalid]="submitted && form.senderDetails.errors"
                    [ngClass]="{
                      'is-invalid': submitted && form.senderDetails.errors
                    }"
                    [attr.aria-describedby]="
                      submitted && form.senderDetails.errors
                        ? 'sender-details-errors'
                        : 'sender-details-help'
                    "
                  />
                  <small id="sender-details-help">30 caractères maximum</small>
                  <p
                    *ngIf="submitted && form.senderDetails.errors"
                    class="invalid-feedback"
                    id="sender-details-errors"
                  >
                    La signature du message est obligatoire (maximum 30
                    caractères)
                  </p>
                </div>

                <div class="col-md-12 my-2 text-center">
                  <button
                    class="btn btn-primary"
                    type="submit"
                    [disabled]="loading"
                  >
                    <span *ngIf="!loading">
                      Enregistrer les modifications
                    </span>

                    <span *ngIf="loading"
                      ><fa-icon
                        [icon]="['fas', 'circle-notch']"
                        [spin]="true"
                        aria-hidden="true"
                      >
                      </fa-icon>
                      Veuillez patienter...</span
                    >
                  </button>
                </div>
                <br />
              </div>
            </form>
          </div>
        </div>
        <div class="col-md-4">
          <div id="sms-preview">
            <div class="sms-header">
              <span class="left">Messages</span>
              <div id="sms-contact">{{ form.senderName.value }}</div>
            </div>
            <div class="messages-wrapper">
              <div class="message from">
                Bonjour,
                <br />
                <br />
                Vous avez reçu 5 nouveaux courriers
                <br />
                <br />
                <strong>{{ form.senderDetails.value }}</strong>
              </div>

              <div class="message from">
                Bonjour,
                <br />
                <br />
                Votre domiciliation expire dans 2 mois, nous vous invitons à
                vous rendre dans votre structure.
                <br />
                <br />
                <strong>{{ form.senderDetails.value }}</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #tutoModal let-modal>
  <div class="modal-header">
    <span id="modal-title"> Comment activer et utiliser les SMS </span>
  </div>

  <div class="modal-body text-center py-4">
    <video
      width="560"
      preload="metadata"
      poster="../../../../../assets/images/faq/faq-sms.jpg"
      controls
      (click)="trackVideo('fiche_domicilie')"
    >
      <source
        src="https://domifaprod2.blob.core.windows.net/public/activation-sms.mp4"
        type="video/mp4"
      />
    </video>
  </div>
  <div class="modal-footer">
    <a
      href="https://domifaprod2.blob.core.windows.net/public/activation-sms.mp4"
      download
      rel="noopener noreferrer"
      target="_blank"
      class="btn-primary btn me-1"
      >Télécharger la vidéo</a
    >
    <button
      type="button"
      class="btn btn-outline-primary"
      (click)="closeTutoModal()"
    >
      Fermer la fenêtre
    </button>
  </div>
</ng-template>
