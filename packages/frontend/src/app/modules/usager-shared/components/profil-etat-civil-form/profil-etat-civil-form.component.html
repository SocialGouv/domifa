<form
  [formGroup]="usagerForm"
  (ngSubmit)="updateInfos()"
  *ngIf="currentUserSubject$ | async as me"
>
  <fieldset>
    <p>
      Les champs suivis d'un
      <span class="fr-text--bold text-error">*</span> sont obligatoires
    </p>
    <legend class="visually-hidden">État civil du domicilié</legend>
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-md-4">
        <div
          class="fr-input-group"
          [class.fr-input-group--error]="
            (f.nom.dirty || submitted) && f.nom.errors
          "
        >
          <label class="fr-label" for="nom">
            Nom
            <span aria-label="obligatoire">*</span>
          </label>
          <input
            #firstInput
            type="text"
            class="fr-input"
            id="nom"
            appCleanStr
            maxlength="200"
            formControlName="nom"
            [attr.aria-describedby]="
              (f.nom.dirty || submitted) && f.nom.errors
                ? 'nom-errors'
                : 'nom-description'
            "
            [attr.aria-invalid]="
              (f.nom.dirty || submitted) && f.nom.errors ? true : false
            "
            required
          />
          <p id="nom-description" class="fr-hint-text">
            Précisez nom de naissance si nécessaire
          </p>
          @if ((f.nom.dirty || submitted) && f.nom.errors) {
          <p id="nom-errors" class="fr-error-text">
            Le nom du demandeur est obligatoire
          </p>
          }
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-4">
        <div
          class="fr-input-group"
          [class.fr-input-group--error]="
            (f.prenom.dirty || submitted) && f.prenom.errors
          "
        >
          <label class="fr-label" for="prenom">
            Prénom(s)
            <span aria-label="obligatoire">*</span>
          </label>
          <input
            type="text"
            class="fr-input"
            id="prenom"
            appCleanStr
            maxlength="200"
            formControlName="prenom"
            [attr.aria-describedby]="
              (f.prenom.dirty || submitted) && f.prenom.errors
                ? 'prenom-errors'
                : null
            "
            [attr.aria-invalid]="
              (f.prenom.dirty || submitted) && f.prenom.errors ? true : false
            "
            required
          />
          @if ((f.prenom.dirty || submitted) && f.prenom.errors) {
          <p id="prenom-errors" class="fr-error-text">
            Le prénom est obligatoire
          </p>
          }
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-4">
        <div class="fr-input-group">
          <label class="fr-label" for="surnom">Nom d'usage / Surnom</label>
          <input
            type="text"
            class="fr-input"
            id="surnom"
            appCleanStr
            maxlength="100"
            formControlName="surnom"
          />
        </div>
      </div>
    </div>

    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-md-4">
        <div class="fr-input-group">
          <label class="fr-label" for="sexe">
            Sexe
            <span aria-label="obligatoire">*</span>
          </label>
          <select formControlName="sexe" id="sexe" class="fr-select" required>
            <option value="homme">Homme</option>
            <option value="femme">Femme</option>
          </select>
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-4">
        <div
          class="fr-input-group"
          [class.fr-input-group--error]="
            (f.dateNaissance.dirty || submitted) && f.dateNaissance.errors
          "
        >
          <label class="fr-label" for="dateNaissance">
            Date de naissance
            <span aria-label="obligatoire">*</span>
          </label>
          <div class="input-group">
            <input
              class="form-control"
              placeholder="jj/mm/aaaa"
              [minDate]="minDateNaissance"
              [maxDate]="maxDateNaissance"
              placement="auto"
              formControlName="dateNaissance"
              id="dateNaissance"
              ngbDatepicker
              appDateFr
              [ngClass]="{
                'is-invalid':
                  (f.dateNaissance.dirty || submitted) && f.dateNaissance.errors
              }"
              [attr.aria-describedby]="
                (f.dateNaissance.dirty || submitted) && f.dateNaissance.errors
                  ? 'date-naissance-errors'
                  : null
              "
              [attr.aria-invalid]="
                (f.dateNaissance.dirty || submitted) && f.dateNaissance.errors
                  ? true
                  : false
              "
              #d="ngbDatepicker"
              maxlength="10"
              required
            />
            <button
              type="button"
              aria-label="Sélectionner une date de naissance dans le calendrier"
              class="input-group-text btn btn-outline-primary"
              (click)="d.toggle()"
            >
              <i class="ri-calendar-line" aria-hidden="true"></i>
            </button>
          </div>
          @if ((f.dateNaissance.dirty || submitted) && f.dateNaissance.errors) {
          <p id="date-naissance-errors" class="fr-error-text">
            La date de naissance est obligatoire, exemple : 20/12/1996
          </p>
          }
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-4">
        <div
          class="fr-input-group"
          [class.fr-input-group--error]="
            (submitted || f.villeNaissance.dirty) && f.villeNaissance.errors
          "
        >
          <label class="fr-label" for="villeNaissance">
            Ville de naissance
            <span aria-label="obligatoire">*</span>
          </label>
          <input
            type="text"
            class="fr-input"
            id="villeNaissance"
            formControlName="villeNaissance"
            maxlength="100"
            [attr.aria-describedby]="
              (submitted || f.villeNaissance.dirty) && f.villeNaissance.errors
                ? 'ville-errors'
                : 'ville-description'
            "
            [attr.aria-invalid]="
              (submitted || f.villeNaissance.dirty) && f.villeNaissance.errors
                ? true
                : false
            "
            required
          />
          <p id="ville-description" class="fr-hint-text">
            Préciser le pays si à l'étranger
          </p>
          @if ((submitted || f.villeNaissance.dirty) && f.villeNaissance.errors)
          {
          <p id="ville-errors" class="fr-error-text">
            La ville de naissance est obligatoire
          </p>
          }
        </div>
      </div>
    </div>
  </fieldset>

  <div class="fr-grid-row fr-grid-row--gutters fr-mt-4w">
    <div class="fr-col-12 fr-col-md-4">
      <div class="fr-input-group">
        <label class="fr-label" for="langue">Langue parlée</label>
        <input
          id="langue"
          type="text"
          class="fr-input"
          formControlName="langue"
          [attr.aria-describedby]="
            (f.langue.dirty || submitted) && f.langue.errors
              ? 'langue-errors'
              : 'langue-description'
          "
          [attr.aria-invalid]="
            (f.langue.dirty || submitted) && f.langue.errors ? true : false
          "
          [ngbTypeahead]="languagesAutocompleteSearch"
          [resultFormatter]="languagesAutocomplete.formatter"
          [inputFormatter]="languagesAutocomplete.formatter"
        />
        <p id="langue-description" class="fr-hint-text">
          Saisissez la langue, puis choisissez un élément dans la liste.
        </p>
        @if (f.langue.touched && f.langue.errors) {
        <p id="langue-errors" class="fr-error-text">
          La langue saisie est invalide. Veuillez sélectionner une langue dans
          la liste des propositions
        </p>
        }
      </div>
    </div>

    <div class="fr-col-12 fr-col-md-4">
      <app-input-nationality
        [parentFormGroup]="usagerForm"
        [usager]="usager"
        [submitted]="submitted"
      ></app-input-nationality>
    </div>

    <div class="fr-col-12 fr-col-md-4">
      <div
        class="fr-input-group"
        [class.fr-input-group--error]="
          (f.customRef.dirty || submitted) && f.customRef.errors
        "
      >
        <label class="fr-label" for="customRef">Identifiant personnalisé</label>
        <input
          type="text"
          class="fr-input"
          id="customRef"
          maxlength="50"
          [attr.aria-describedby]="
            (f.customRef.dirty || submitted) && f.customRef.errors
              ? 'customRef-errors'
              : null
          "
          [attr.aria-invalid]="
            (f.customRef.dirty || submitted) && f.customRef.errors
              ? true
              : false
          "
          formControlName="customRef"
        />
        @if ((submitted || f.customRef.dirty) && f.customRef.errors) {
        <p id="customRef-errors" class="fr-error-text">30 caractères maximum</p>
        }
      </div>
    </div>

    <div class="fr-col-12 fr-col-md-4">
      <div class="fr-input-group">
        <label class="fr-label" for="numeroDistribution">
          Numéro de distribution spéciale (BP, TSA, etc)
        </label>
        <input
          type="text"
          class="fr-input"
          id="numeroDistribution"
          formControlName="numeroDistribution"
          maxlength="50"
        />
        <p id="numero-description" class="fr-hint-text">
          Exemple : BP 102, TSA 11000
        </p>
      </div>
    </div>

    <div class="fr-col-12 fr-col-md-4">
      <app-input-referrer
        [submitted]="submitted"
        [parentFormGroup]="usagerForm"
        [referrerId]="f.referrerId.value"
        [required]="false"
      ></app-input-referrer>
    </div>
  </div>

  <div class="fr-grid-row fr-grid-row--gutters fr-mt-5w">
    <div class="fr-col-12">
      <h2>Ayants droit</h2>
    </div>
  </div>

  <div class="fr-grid-row fr-grid-row--gutters fr-mb-2w">
    <div class="fr-col-12">
      <button
        type="button"
        (click)="addAyantDroit()"
        class="fr-btn fr-btn--secondary"
      >
        <i class="ri-add-line" aria-hidden="true"></i>
        Ajouter des ayants droit
      </button>
    </div>
  </div>

  <div class="fr-callout" *ngIf="ayantsDroits.length === 0">
    <p class="fr-callout__text">Aucun ayant droit enregistré</p>
  </div>

  @for (ayantDroit of ayantsDroits.controls; track $index; let i = $index) {
  <fieldset class="fr-fieldset fr-mb-3w">
    <legend class="fr-fieldset__legend">Ayant droit numéro {{ i + 1 }}</legend>
    <div [formGroupName]="i" class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-md-3">
        <div
          class="fr-input-group"
          [class.fr-input-group--error]="
            (ayantsDroits.controls[i].get('nom')?.dirty || submitted) &&
            ayantsDroits.controls[i].get('nom')?.errors
          "
        >
          <label class="fr-label" for="nom_{{ i }}">
            Nom
            <span aria-label="obligatoire">*</span>
          </label>
          <input
            id="nom_{{ i }}"
            type="text"
            appCleanStr
            class="fr-input"
            formControlName="nom"
            [attr.aria-invalid]="
              (ayantsDroits.controls[i].get('nom')?.dirty || submitted) &&
              ayantsDroits.controls[i].get('nom')?.errors
                ? true
                : false
            "
            [attr.aria-describedby]="
              (ayantsDroits.controls[i].get('nom')?.dirty || submitted) &&
              ayantsDroits.controls[i].get('nom')?.errors
                ? 'nom-ad-errors-' + i
                : null
            "
            required
          />
          @if ((ayantsDroits.controls[i].get('nom')?.dirty || submitted) &&
          ayantsDroits.controls[i].get('nom')?.errors) {
          <p [id]="'nom-ad-errors-' + i" class="fr-error-text">
            Le nom est obligatoire
          </p>
          }
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-3">
        <div
          class="fr-input-group"
          [class.fr-input-group--error]="
            (ayantsDroits.controls[i].get('prenom')?.dirty || submitted) &&
            ayantsDroits.controls[i].get('prenom')?.errors
          "
        >
          <label class="fr-label" for="ad_prenom_{{ i }}">
            Prénom
            <span aria-label="obligatoire">*</span>
          </label>
          <input
            type="text"
            id="ad_prenom_{{ i }}"
            class="fr-input"
            appCleanStr
            formControlName="prenom"
            [attr.aria-invalid]="
              (ayantsDroits.controls[i].get('prenom')?.dirty || submitted) &&
              ayantsDroits.controls[i].get('prenom')?.errors
                ? true
                : false
            "
            [attr.aria-describedby]="
              (ayantsDroits.controls[i].get('prenom')?.dirty || submitted) &&
              ayantsDroits.controls[i].get('prenom')?.errors
                ? 'prenom-ad-errors-' + i
                : null
            "
            required
          />
          @if ((ayantsDroits.controls[i].get('prenom')?.dirty || submitted) &&
          ayantsDroits.controls[i].get('prenom')?.errors) {
          <p [id]="'prenom-ad-errors-' + i" class="fr-error-text">
            Le prénom est obligatoire
          </p>
          }
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-3">
        <div
          class="fr-input-group"
          [class.fr-input-group--error]="
            (ayantsDroits.controls[i].get('dateNaissance')?.dirty ||
              submitted) &&
            ayantsDroits.controls[i].get('dateNaissance')?.errors
          "
        >
          <label class="fr-label" for="dateNaissance_{{ i }}">
            Date de naissance
            <span aria-label="obligatoire">*</span>
          </label>
          <div class="input-group">
            <input
              id="dateNaissance_{{ i }}"
              class="form-control"
              placeholder="jj/mm/aaaa"
              [minDate]="minDateNaissance"
              [maxDate]="maxDateNaissance"
              placement="auto"
              formControlName="dateNaissance"
              ngbDatepicker
              appDateFr
              [ngClass]="{
                'is-invalid':
                  (ayantsDroits.controls[i].get('dateNaissance')?.dirty ||
                    submitted) &&
                  ayantsDroits.controls[i].get('dateNaissance')?.errors
              }"
              [attr.aria-invalid]="
                (ayantsDroits.controls[i].get('dateNaissance')?.dirty ||
                  submitted) &&
                ayantsDroits.controls[i].get('dateNaissance')?.errors
                  ? true
                  : false
              "
              [attr.aria-describedby]="
                (ayantsDroits.controls[i].get('dateNaissance')?.dirty ||
                  submitted) &&
                ayantsDroits.controls[i].get('dateNaissance')?.errors
                  ? 'dateNaissance-ad-errors-' + i
                  : null
              "
              #d="ngbDatepicker"
              maxlength="10"
              required
            />
            <button
              type="button"
              aria-label="Sélectionner une date de naissance dans le calendrier"
              class="btn btn-outline-primary input-group-text"
              (click)="d.toggle()"
            >
              <i class="ri-calendar-line" aria-hidden="true"></i>
            </button>
          </div>
          @if ((ayantsDroits.controls[i].get('dateNaissance')?.dirty ||
          submitted) && ayantsDroits.controls[i].get('dateNaissance')?.errors) {
          <p [id]="'dateNaissance-ad-errors-' + i" class="fr-error-text">
            La date de naissance est obligatoire. Exemple : 20/12/1996
          </p>
          }
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-2">
        <div
          class="fr-input-group"
          [class.fr-input-group--error]="
            (ayantsDroits.controls[i].get('lien')?.dirty || submitted) &&
            ayantsDroits.controls[i].get('lien')?.errors
          "
        >
          <label class="fr-label" for="lien_{{ i }}">
            Lien
            <span aria-label="obligatoire">*</span>
          </label>
          <select
            formControlName="lien"
            id="lien_{{ i }}"
            class="fr-select"
            [attr.aria-invalid]="
              (ayantsDroits.controls[i].get('lien')?.dirty || submitted) &&
              ayantsDroits.controls[i].get('lien')?.errors
                ? true
                : false
            "
            [attr.aria-describedby]="
              (ayantsDroits.controls[i].get('lien')?.dirty || submitted) &&
              ayantsDroits.controls[i].get('lien')?.errors
                ? 'lien-parente-errors-' + i
                : null
            "
            required
          >
            <option [ngValue]="null">Non renseigné</option>
            @for (lien of LIEN_PARENTE_LABELS | keyvalue; track lien.key) {
            <option [ngValue]="lien.key">
              {{ lien.value }}
            </option>
            }
          </select>
          @if ((ayantsDroits.controls[i].get('lien')?.dirty || submitted) &&
          ayantsDroits.controls[i].get('lien')?.errors) {
          <p [id]="'lien-parente-errors-' + i" class="fr-error-text">
            Le lien de parenté est obligatoire
          </p>
          }
        </div>
      </div>

      <div class="fr-col-12 fr-col-md-1">
        <div class="fr-input-group">
          <label class="fr-label" for="delete_ad_{{ i }}">Supprimer</label>
          <button
            type="button"
            id="delete_ad_{{ i }}"
            (click)="deleteAyantDroit(i)"
            class="fr-btn fr-btn--danger w-100"
          >
            <i class="ri-delete-bin-line" aria-hidden="true"></i>
            <span class="d-none d-md-inline">Supprimer</span>
          </button>
        </div>
      </div>
    </div>
  </fieldset>
  }

  <div class="fr-text-center">
    <button
      type="submit"
      class="fr-btn"
      [disabled]="loading"
      [attr.aria-busy]="loading"
    >
      @if (!loading) { Enregistrer les modifications } @else { Veuillez
      patienter... }
    </button>
  </div>
</form>
