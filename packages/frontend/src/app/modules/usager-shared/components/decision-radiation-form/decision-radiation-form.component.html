@if (context === 'PROFIL') {
<button
  type="button"
  (click)="openRadiationModal()"
  class="ms-2 fr-btn fr-btn--secondary my-md-0 my-1"
>
  Radier le domicilié
</button>
} @if (context === 'MANAGE') {
<button
  type="button"
  (click)="openRadiationModal()"
  class="btn btn-sm btn-outline-dark me-2"
>
  Radier {{ selectedRefs.size === 1 ? "le domicilié" : "les domiciliés" }}
</button>
}
<dsfr-modal
  #decisionRadiationFormModal
  titleModal="Motivez votre radiation"
  [isScrollable]="true"
  [size]="'LG'"
>
  <form [formGroup]="radiationForm" (ngSubmit)="setDecisionRadiation()">
    <div class="p-4 text-start">
      @if (usager && context === 'PROFIL') {
      <p>
        Vous souhaitez mettre fin à la domiciliation de
        <strong>
          {{ usager | fullName }} né{{ usager.sexe === "homme" ? "" : "e" }} le
          {{ usager.dateNaissance | date : "dd MMMM yyyy" }}.
        </strong>
        <br />
        <br />
        La radiation peut avoir de lourdes conséquences et laisser une personne
        sans adresse.
        <br />
        Elle doit être notifiée par écrit à l'intéressé et motivée, avec mention
        des voies et délais de recours.
        <br />
      </p>
      } @if (context === 'MANAGE') {
      <p>
        Vous souhaitez mettre fin à la domiciliation de
        <strong
          >{{ selectedRefs.size }}
          {{ selectedRefs.size > 1 ? "domiciliés" : "domicilié" }}</strong
        >
        <br />
        La radiation peut avoir de lourdes conséquences et laisser toutes les
        personnes sélectionnées sans adresse.
        <br />
        Elle doit être notifiée par écrit à l'intéressé et motivée, avec mention
        des voies et délais de recours.
        <br />
      </p>
      }

      <div class="row">
        <div class="col-md-12">
          <p>
            Les champs suivis d'un
            <span class="fw-bold text-danger">*</span> sont obligatoires
          </p>
        </div>
        <div class="col-md-6 form-group required">
          <label for="dateFin">Date de la radiation</label>
          <div class="input-group">
            <input
              class="form-control"
              placeholder="jj/mm/aaaa"
              [minDate]="minDate"
              [maxDate]="maxDate"
              placement="auto"
              ngbDatepicker
              id="dateFin"
              formControlName="dateFin"
              name="dateFin"
              #dFin="ngbDatepicker"
              [ngClass]="{
                'is-invalid': (r.dateFin.dirty || submitted) && r.dateFin.errors
              }"
              [attr.aria-invalid]="
                (r.dateFin.dirty || submitted) && r.dateFin.errors
                  ? true
                  : false
              "
              [attr.aria-describedby]="
                (r.dateFin.dirty || submitted) && r.dateFin.errors
                  ? 'date-fin-errors'
                  : null
              "
              appDateFr
              value
              maxlength="10"
              required
            />

            <button
              type="button"
              class="btn btn-outline-primary d-print-none input-group-text"
              (click)="dFin.toggle()"
              aria-label="Ouvrir le calendrier"
            >
              <span class="fr-icon-calendar-line" aria-hidden="true"></span>
            </button>

            @if ((r.dateFin.dirty || submitted) && r.dateFin.errors) {
            <p id="date-fin-errors" class="invalid-feedback">
              La date de fin est incorrecte. Format attendu: jj/mm/aaaa
            </p>
            }
          </div>
        </div>

        <div class="col-md-6">
          <div class="fr-select-group">
            <label class="fr-label" for="motif">
              Merci d'indiquer le motif (obligatoire)
              <span class="fr-hint-text"
                >Sélectionnez le motif de radiation</span
              >
            </label>
            <select
              class="fr-select"
              [ngClass]="{
                'fr-select--error':
                  (r.motif.dirty || submitted) && r.motif.errors
              }"
              id="motif"
              formControlName="motif"
              name="motif"
              [attr.aria-invalid]="
                (r.motif.dirty || submitted) && r.motif.errors ? true : false
              "
              [attr.aria-describedby]="
                (r.motif.dirty || submitted) && r.motif.errors
                  ? 'motif-errors'
                  : null
              "
              required
            >
              <option value="" disabled selected>Sélectionnez un motif</option>
              @for (motif of MOTIFS_RADIATION_LABELS | keyvalue; track
              motif.key) {
              <option [value]="motif.key">{{ motif.value }}</option>
              }
              <option value="AUTRE">Autre motif</option>
            </select>
            @if ((r.motif.dirty || submitted) && r.motif.errors) {
            <p id="motif-errors" class="fr-error-text">
              Veuillez choisir un motif de radiation
            </p>
            }
          </div>
        </div>

        @if (r.motif.value === 'AUTRE') {
        <div class="col-md-6">
          <div class="fr-input-group">
            <label class="fr-label" for="motifAutre">
              Autre motif de radiation (10 caractères minimum)
            </label>
            <input
              type="text"
              class="fr-input"
              [ngClass]="{
                'fr-input--error':
                  (r.motifDetails.dirty || submitted) && r.motifDetails.errors
              }"
              [attr.aria-invalid]="
                (r.motifDetails.dirty || submitted) && r.motifDetails.errors
                  ? true
                  : false
              "
              [attr.aria-describedby]="
                (r.motifDetails.dirty || submitted) && r.motifDetails.errors
                  ? 'motifDetails-errors'
                  : null
              "
              id="motifAutre"
              formControlName="motifDetails"
              name="motifDetails"
              required
            />
            @if ((r.motifDetails.dirty || submitted) && r.motifDetails.errors) {
            <p class="fr-error-text" id="motifDetails-errors">
              Veuillez préciser le motif
            </p>
            }
          </div>
        </div>
        }
      </div>
    </div>

    <ng-container dsfrModalActions>
      <button
        class="fr-btn fr-btn--primary"
        [disabled]="loading"
        [attr.aria-busy]="loading"
        type="submit"
      >
        @if (!loading) {
        <span>Confirmer la radiation</span>
        } @if (loading) {
        <span>
          <span
            class="fr-icon-loader-4-line fr-animate-spin"
            aria-hidden="true"
          ></span>
          Veuillez patienter...
        </span>
        }
      </button>
      <button
        class="fr-btn fr-btn--secondary"
        type="button"
        (click)="closeModals()"
      >
        Annuler
      </button>
    </ng-container>
  </form>
</dsfr-modal>
