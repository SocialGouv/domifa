<form
  *ngIf="entretienForm"
  [formGroup]="entretienForm"
  (ngSubmit)="submitEntretien()"
>
  <h2 class="fr-h2" *ngIf="!editEntretien">Entretien avec le demandeur</h2>

  <app-rgpd-warning></app-rgpd-warning>

  <br />
  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">Avez-vous été orienté ?</legend>
    <div class="fr-fieldset__element fr-fieldset__element--inline">
      <div class="fr-radio-group">
        <input
          type="radio"
          id="orientation_oui"
          formControlName="orientation"
          [value]="true"
        />
        <label class="fr-label" for="orientation_oui">Oui</label>
      </div>
    </div>
    <div class="fr-fieldset__element fr-fieldset__element--inline">
      <div class="fr-radio-group">
        <input
          type="radio"
          id="orientation_non"
          formControlName="orientation"
          [value]="false"
        />
        <label class="fr-label" for="orientation_non">Non</label>
      </div>
    </div>
    <div class="fr-col-12" *ngIf="e.orientation.value === true">
      <div class="fr-input-group">
        <label class="fr-label" for="orientationDetail"
          >Par quelle structure ou personne ?</label
        >
        <input
          type="text"
          id="orientationDetail"
          formControlName="orientationDetail"
          class="fr-input"
          maxlength="1000"
        />
      </div>
    </div>
  </fieldset>

  <hr />

  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">
      Avez-vous déjà une domiciliation ?
    </legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="domiciliation_oui"
              formControlName="domiciliation"
              [value]="true"
            />
            <label class="fr-label" for="domiciliation_oui">Oui</label>
          </div>
        </div>
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="domiciliation_non"
              formControlName="domiciliation"
              [value]="false"
            />
            <label class="fr-label" for="domiciliation_non">Non</label>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
  <p class="fr-text--sm">
    Une domiciliation existante n'est pas un motif de refus. Néanmoins, il faut
    rechercher pourquoi la personne formule une nouvelle demande et l'inviter à
    choisir quelle domiciliation elle souhaite conserver.
  </p>

  <hr />

  <!-- Situation professionnelle -->
  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">
      Quelle est votre situation professionnelle ?
    </legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <ng-container *ngFor="let item of ENTRETIEN_SITUATION_PRO | keyvalue">
          <div class="fr-col-12 fr-col-md-6" *ngIf="item.key !== 'AUTRE'">
            <div class="fr-radio-group">
              <input
                type="radio"
                [id]="item.key"
                formControlName="situationPro"
                value="{{ item.key }}"
              />
              <label class="fr-label" for="{{ item.key }}">{{
                item.value
              }}</label>
            </div>
          </div>
        </ng-container>
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="situationProAutre"
              formControlName="situationPro"
              value="AUTRE"
            />
            <label class="fr-label" for="situationProAutre"
              >Autre situation</label
            >
          </div>
        </div>
      </div>
    </div>
  </fieldset>
  <div *ngIf="e.situationPro.value === 'AUTRE'" class="fr-grid-row">
    <div class="fr-col-12">
      <div class="fr-input-group">
        <label class="fr-label" for="situationProDetail"
          >Précisez la nature de la situation</label
        >
        <input
          type="text"
          id="situationProDetail"
          formControlName="situationProDetail"
          class="fr-input"
        />
      </div>
    </div>
  </div>

  <hr />

  <!-- Revenus -->
  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">Avez-vous des revenus ?</legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="revenus_oui"
              formControlName="revenus"
              [value]="true"
            />
            <label class="fr-label" for="revenus_oui">Oui</label>
          </div>
        </div>
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="revenus_non"
              formControlName="revenus"
              [value]="false"
            />
            <label class="fr-label" for="revenus_non">Non</label>
          </div>
        </div>
      </div>
    </div>
    <div
      *ngIf="e.revenus.value === true"
      class="fr-grid-row fr-grid-row--gutters"
    >
      <div class="fr-col-12">
        <div class="fr-input-group">
          <label class="fr-label" for="revenusDetail">De quelle nature ?</label>
          <textarea
            id="revenusDetail"
            formControlName="revenusDetail"
            class="fr-input"
            maxlength="1000"
          ></textarea>
        </div>
      </div>
    </div>
  </fieldset>

  <hr />

  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">
      Quel est votre lien avec la commune ? (Uniquement pour les communes, CCAS,
      CIAS)
    </legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <ng-container *ngFor="let item of ENTRETIEN_LIEN_COMMUNE | keyvalue">
          <div class="fr-col-12 fr-col-md-6" *ngIf="item.key !== 'AUTRE'">
            <div class="fr-radio-group">
              <input
                type="radio"
                [id]="item.key"
                formControlName="liencommune"
                value="{{ item.key }}"
              />
              <label class="fr-label" for="{{ item.key }}">{{
                item.value
              }}</label>
            </div>
          </div>
        </ng-container>
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="liencommune_autre"
              formControlName="liencommune"
              value="AUTRE"
            />
            <label class="fr-label" for="liencommune_autre">Autre lien</label>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
  <div
    *ngIf="e.liencommune.value === 'AUTRE'"
    class="fr-grid-row fr-grid-row--gutters"
  >
    <div class="fr-col-12">
      <div class="fr-input-group">
        <label class="fr-label" for="liencommuneDetail"
          >Précisez lien avec la commune</label
        >
        <input
          type="text"
          id="liencommuneDetail"
          formControlName="liencommuneDetail"
          class="fr-input"
          maxlength="1000"
        />
      </div>
    </div>
  </div>

  <hr />

  <!-- Composition du ménage -->
  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">
      Quelle est la composition de votre ménage ?
    </legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <div
          class="fr-col-12 fr-col-md-6"
          *ngFor="let item of ENTRETIEN_TYPE_MENAGE | keyvalue"
        >
          <div class="fr-radio-group">
            <input
              type="radio"
              [id]="item.key"
              formControlName="typeMenage"
              value="{{ item.key }}"
            />
            <label class="fr-label" for="{{ item.key }}">{{
              item.value
            }}</label>
          </div>
        </div>
      </div>
    </div>
  </fieldset>

  <hr />

  <!-- Situation résidentielle -->
  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">
      Quelle est votre situation résidentielle ?
    </legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <ng-container *ngFor="let item of ENTRETIEN_RESIDENCE | keyvalue">
          <div class="fr-col-12 fr-col-md-6" *ngIf="item.key !== 'AUTRE'">
            <div class="fr-radio-group">
              <input
                type="radio"
                [id]="item.key"
                formControlName="residence"
                value="{{ item.key }}"
              />
              <label class="fr-label" for="{{ item.key }}">{{
                item.value
              }}</label>
            </div>
          </div>
        </ng-container>
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="residenceAutre"
              formControlName="residence"
              value="AUTRE"
            />
            <label class="fr-label" for="residenceAutre">Autre situation</label>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
  <div
    *ngIf="e.residence.value === 'AUTRE'"
    class="fr-grid-row fr-grid-row--gutters"
  >
    <div class="fr-col-12">
      <div class="fr-input-group">
        <label class="fr-label" for="residenceDetail"
          >Précisez la nature de la situation résidentielle</label
        >
        <input
          type="text"
          id="residenceDetail"
          formControlName="residenceDetail"
          class="fr-input"
          maxlength="1000"
        />
      </div>
    </div>
  </div>

  <hr />

  <!-- Cause instabilité -->
  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">
      Quelle est la cause de l'instabilité de logement ?
    </legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <ng-container
          *ngFor="let item of ENTRETIEN_CAUSE_INSTABILITE | keyvalue"
        >
          <div class="fr-col-12 fr-col-md-6" *ngIf="item.key !== 'AUTRE'">
            <div class="fr-radio-group">
              <input
                type="radio"
                [id]="item.key"
                formControlName="cause"
                value="{{ item.key }}"
              />
              <label class="fr-label" for="{{ item.key }}">{{
                item.value
              }}</label>
            </div>
          </div>
        </ng-container>
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="causeAutre"
              formControlName="cause"
              value="AUTRE"
            />
            <label class="fr-label" for="causeAutre">Autre cause</label>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
  <div
    *ngIf="e.cause.value === 'AUTRE'"
    class="fr-grid-row fr-grid-row--gutters"
  >
    <div class="fr-col-12">
      <div class="fr-input-group">
        <label class="fr-label" for="causeDetail"
          >Précisez la cause de l'instabilité</label
        >
        <input
          type="text"
          id="causeDetail"
          formControlName="causeDetail"
          class="fr-input"
          maxlength="1000"
        />
      </div>
    </div>
  </div>

  <hr />

  <!-- Raison demande -->
  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">
      Quel est le motif principal de demande de domiciliation ?
    </legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <ng-container *ngFor="let item of ENTRETIEN_RAISON_DEMANDE | keyvalue">
          <div class="fr-col-12 fr-col-md-6" *ngIf="item.key !== 'AUTRE'">
            <div class="fr-radio-group">
              <input
                type="radio"
                [id]="item.key"
                formControlName="raison"
                value="{{ item.key }}"
              />
              <label class="fr-label" for="{{ item.key }}">{{
                item.value
              }}</label>
            </div>
          </div>
        </ng-container>
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="raisonAutre"
              formControlName="raison"
              value="AUTRE"
            />
            <label class="fr-label" for="raisonAutre">Autre motif</label>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
  <div
    *ngIf="e.raison.value === 'AUTRE'"
    class="fr-grid-row fr-grid-row--gutters"
  >
    <div class="fr-col-12">
      <div class="fr-input-group">
        <label class="fr-label" for="raisonDetail">Précisez le motif</label>
        <input
          type="text"
          id="raisonDetail"
          formControlName="raisonDetail"
          class="fr-input"
          maxlength="1000"
        />
      </div>
    </div>
  </div>

  <hr />

  <!-- Accompagnement -->
  <fieldset class="fr-fieldset">
    <legend class="fr-fieldset__legend">
      Faites-vous l'objet d'un accompagnement social ?
    </legend>
    <div class="fr-fieldset__element">
      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="accompagnement_oui"
              formControlName="accompagnement"
              [value]="true"
            />
            <label class="fr-label" for="accompagnement_oui">Oui</label>
          </div>
        </div>
        <div class="fr-col-12 fr-col-md-6">
          <div class="fr-radio-group">
            <input
              type="radio"
              id="accompagnement_non"
              formControlName="accompagnement"
              [value]="false"
            />
            <label class="fr-label" for="accompagnement_non">Non</label>
          </div>
        </div>
      </div>
    </div>
  </fieldset>
  <div
    *ngIf="e.accompagnement.value === true"
    class="fr-grid-row fr-grid-row--gutters"
  >
    <div class="fr-col-12">
      <div class="fr-input-group">
        <label class="fr-label" for="accompagnementDetail"
          >Par quelle structure ?</label
        >
        <input
          type="text"
          id="accompagnementDetail"
          formControlName="accompagnementDetail"
          class="fr-input"
        />
      </div>
    </div>
  </div>

  <hr />

  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12">
      <div class="fr-input-group">
        <label class="fr-label" for="rattachement"
          >Cette domiciliation est-elle réalisée au titre d'une autre commune ou
          d'un autre arrondissement ?</label
        >
        <input
          type="text"
          id="rattachement"
          formControlName="rattachement"
          class="fr-input"
        />
      </div>
    </div>
  </div>

  <hr />

  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12">
      <div class="fr-input-group">
        <label class="fr-label" for="commentaires">Commentaires</label>
        <textarea
          id="commentaires"
          formControlName="commentaires"
          class="fr-input"
          rows="6"
          aria-describedby="commentairesHelp"
          maxlength="2000"
        ></textarea>
        <small id="commentairesHelp" class="fr-hint-text"
          >2000 caractères maximum</small
        >
      </div>
    </div>
  </div>

  <div class="fr-mt-6w fr-mb-6w" style="text-align: center">
    <button
      *ngIf="editEntretien"
      type="submit"
      class="fr-btn fr-btn--primary"
      [disabled]="loading"
      [attr.aria-busy]="loading"
    >
      <span *ngIf="!loading">Enregistrer les modifications</span>
      <span *ngIf="loading">Veuillez patienter...</span>
    </button>

    <ng-container
      *ngIf="usager.decision.statut === 'INSTRUCTION' && !editEntretien"
    >
      <button
        type="submit"
        class="fr-btn fr-btn--primary fr-mr-2w"
        [disabled]="loading"
        [attr.aria-busy]="loading"
      >
        <span *ngIf="!loading"
          >Suivant <i class="fr-icon-arrow-right-line" aria-hidden="true"></i
        ></span>
        <span *ngIf="loading">Veuillez patienter...</span>
      </button>
      <a routerLink="/manage" class="fr-btn fr-btn--secondary">
        Continuer plus tard
        <i class="fr-icon-arrow-right-line" aria-hidden="true"></i>
      </a>
    </ng-container>
  </div>
</form>

<dsfr-modal
  #entretienConfirmationModal
  dialogId="entretienConfirmationModal"
  titleModal="Confirmer votre saisie"
  (closeEvent)="closeModal()"
>
  <ng-container dsfrModalBody>
    <p>
      L’entretien préalable
      <strong>est obligatoire,</strong>
      il est l’occasion d’inscrire la domiciliation dans une démarche
      d’accompagnement social visant à favoriser l’insertion des personnes
      domiciliées et constitue une porte d’entrée pour intégrer la personne dans
      une logique de parcours.
      <br />
      <br />
      Cette étape ne peut être passée que si votre structure met déjà en place
      un accompagnement social pour cette personne, en parallèle de sa
      domiciliation.
    </p>
  </ng-container>
  <ng-template #modalFooterTemplate>
    <div class="fr-btns-group fr-btns-group--inline fr-btns-group--right">
      <button
        type="button"
        class="fr-btn fr-btn--secondary"
        (click)="closeModal()"
      >
        Annuler
      </button>
      <button
        type="button"
        class="fr-btn fr-btn--primary"
        (click)="submitEntretien()"
      >
        <span *ngIf="!loading">Continuer sans entretien</span>
        <span *ngIf="loading"
          ><fa-icon
            [icon]="['fas', 'circle-notch']"
            animation="spin"
            aria-hidden="true"
          ></fa-icon>
          Veuillez patienter...</span
        >
      </button>
    </div>
  </ng-template>
</dsfr-modal>
