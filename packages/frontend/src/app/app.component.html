<app-custom-toastr></app-custom-toastr>
<app-loading></app-loading>
<app-idle-manager></app-idle-manager>

<nav id="skip-links" role="navigation" aria-label="Accès rapide">
  <ul>
    <li>
      <a
        [routerLink]="currentUrl"
        fragment="header-navigation"
        ariaCurrentWhenActive="page"
      >
        Aller à la navigation
      </a>
    </li>
    <li>
      <a [routerLink]="currentUrl" fragment="page" ariaCurrentWhenActive="page">
        Aller au contenu
      </a>
    </li>
    @if (currentUrl === '/manage') {
    <li>
      <a
        [routerLink]="currentUrl"
        fragment="search-bar"
        ariaCurrentWhenActive="page"
      >
        Aller à la recherche
      </a>
    </li>
    }
    <li>
      <a
        [routerLink]="currentUrl"
        fragment="footer"
        ariaCurrentWhenActive="page"
      >
        Aller au pied de page
      </a>
    </li>
  </ul>
</nav>

<app-navbar [me]="me"></app-navbar>

<main role="main" id="page">
  <router-outlet></router-outlet>
</main>

<dsfr-footer
  artworkDirPath="/assets"
  [logo]="{
    tooltipMessage: 'République Française',
    label: 'République<br>Française',
    imageAlt: '',
    navigation: { route: '/' }
  }"
  [display]="true"
  [mandatoryLinks]="[
    { label: 'Accessibilité : partiellement conforme', link: '/accessibilite' },
    { label: 'Mentions légales', link: '/mentions-legales' },
    { label: 'Conditions générales d\u2019utilisation', link: '/cgu' },
    { label: 'Politique de confidentialité', link: '/confidentialite' },
    { label: 'Plan du site', link: '/plan-site' },
    { label: 'FAQ', link: '/faq' },
    { label: 'Contact', link: '/contact' },
    { label: 'Nos partenaires', link: '/partenaires' },
    { label: 'Nouveautés', link: '/news' }
  ]"
  license="Sauf mention explicite de propriété intellectuelle détenue par des tiers, les contenus de ce site sont proposés sous <a href='https://github.com/etalab/licence-ouverte/blob/master/LO.md' _target='_blank' title='licence etalab-2.0 - nouvelle fenêtre'>licence etalab-2.0</a>"
></dsfr-footer>

<!-- Modale CGU — non fermable au clic sur le fond (équivalent keyboard:false) -->
<dsfr-modal
  #acceptTermsModal
  dialogId="accept-terms-modal"
  titleModal="Veuillez lire et accepter les CGU"
  icon="fr-icon-file-text-line"
  [concealingBackdrop]="false"
  [autoCloseOnAction]="false"
  (conceal)="onAcceptTermsModalClosed()"
>
  <form [formGroup]="acceptTermsForm">
    <p>
      Les conditions générales d'utilisation de DomiFa évoluent.<br />
      Afin de pouvoir continuer à l'utiliser, merci de lire et accepter les
      nouvelles CGU.
    </p>

    @if (me) {
    <div id="cgu-modal">
      <app-cgu></app-cgu>
    </div>
    }

    <div class="fr-fieldset__element">
      <div
        class="fr-checkbox-group"
        [class.fr-checkbox-group--error]="submitted && f['acceptCgu'].errors"
      >
        <input
          type="checkbox"
          formControlName="acceptCgu"
          name="acceptCgu"
          id="acceptCgu"
          [attr.aria-describedby]="
            submitted && f['acceptCgu'].errors ? 'invalid-cgu-choice' : null
          "
          required
        />
        <label class="fr-label" for="acceptCgu">
          J'ai lu et j'accepte les conditions générales d'utilisation
        </label>
        @if (submitted && f['acceptCgu'].errors) {
        <div
          class="fr-messages-group"
          id="invalid-cgu-choice"
          aria-live="assertive"
        >
          <p class="fr-message fr-message--error">
            Vous devez accepter les CGU afin de poursuivre l'inscription
          </p>
        </div>
        }
      </div>
    </div>
  </form>

  <!-- Footer via ng-template pour avoir accès au loader sur le bouton -->
  <ng-template #modalFooterTemplate>
    <ul
      class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left"
    >
      <li>
        <dsfr-button
          label="Enregistrer"
          type="button"
          [loader]="loading"
          [disabled]="loading"
          (click)="submitAcceptTerms()"
        ></dsfr-button>
      </li>
      <li>
        <dsfr-button
          label="Se déconnecter"
          variant="secondary"
          type="button"
          (click)="logout()"
        ></dsfr-button>
      </li>
    </ul>
  </ng-template>
</dsfr-modal>

<dsfr-modal
  #versionModal
  dialogId="version-modal"
  titleModal="Une nouvelle version de DomiFa est disponible"
  icon="fr-icon-information-line"
  [actions]="versionModalActions"
>
  <p>
    Afin de profiter des nouveautés de DomiFa, vous devez actualiser la page.<br />
    La page sera automatiquement actualisée dans 10 secondes.
  </p>
</dsfr-modal>
