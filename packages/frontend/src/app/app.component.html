<app-custom-toastr></app-custom-toastr>
<app-loading></app-loading>

<nav class="fr-container" role="navigation" aria-label="Accès rapide">
  <ul id="skip-links">
    <li>
      <a
        class="m-1 btn btn-sm btn-primary"
        [routerLink]="currentUrl"
        fragment="navigation"
        >Aller à la navigation</a
      >
    </li>
    <li>
      <a
        class="m-1 btn btn-sm btn-primary"
        [routerLink]="currentUrl"
        fragment="page"
        >Aller au contenu</a
      >
    </li>
    <li>
      <a
        class="m-1 btn btn-sm btn-primary"
        [routerLink]="currentUrl"
        fragment="footer"
        >Aller au pied de page</a
      >
    </li>
  </ul>
</nav>
<app-navbar
  id="navigation"
  [pendingNews]="pendingNews"
  [me]="me"
  [tabIndex]="currentFragment === 'navigation' ? 1 : -1"
></app-navbar>

<div class="d-print-none" id="help-button-wrapper" *ngIf="me">
  <button type="button" class="btn" id="help-button" (click)="openHelpModal()">
    <span class="sr-only">Besoin d'aide ?</span>
    <fa-icon [icon]="['fas', 'question']"></fa-icon>
  </button>
</div>

<main id="page" [tabIndex]="currentFragment === 'page' ? 1 : -1">
  <router-outlet></router-outlet>
</main>

<footer
  [tabIndex]="currentFragment === 'footer' ? 1 : -1"
  role="contentinfo"
  id="footer"
  class="d-print-none page-footer py-4"
  #footer
>
  <div class="container my-2">
    <div class="my-3">Nos partenaires:</div>
    <div class="d-flex flex-wrap justify-content-center align-items-center">
      <a
        class="m-3"
        href="https://www.fabrique.social.gouv.fr"
        target="_blank"
        rel="noopener noreferrer"
        (click)="matomo.trackEvent('FOOTER', 'Footer_Logo_Fabrique', 'null', 1)"
      >
        <img
          class="ministere-logo"
          src="../assets/images/footer/partenaire-fabrique-numerique.png"
          alt="La Fabrique Numérique"
        />
      </a>
      <a
        class="m-3"
        href="https://beta.gouv.fr"
        target="_blank"
        rel="noopener noreferrer"
        (click)="matomo.trackEvent('FOOTER', 'Footer_Logo_Beta', 'null', 1)"
      >
        <img
          class="ministere-logo"
          src="../assets/images/footer/partenaire-beta-gouv.png"
          alt="Beta Gouv"
        />
      </a>
      <a
        class="m-3"
        href="https://www.gouvernement.fr/france-relance"
        target="_blank"
        rel="noopener noreferrer"
        (click)="
          matomo.trackEvent('FOOTER', 'Footer_Logo_FranceRelance', 'null', 1)
        "
      >
        <img
          class="ministere-logo"
          src="../assets/images/footer/logo_francerelance.webp"
          alt="France Relance soutien DomiFa"
        />
      </a>
      <a
        class="m-3"
        href="https://agence-cohesion-territoires.gouv.fr/"
        target="_blank"
        rel="noopener noreferrer"
        (click)="matomo.trackEvent('FOOTER', 'ANCT', 'null', 1)"
      >
        <img
          class="ministere-logo"
          src="../assets/images/footer/logo_anct.webp"
          alt="Agence nationale de la cohésion des territoires"
        />
      </a>
      <a
        class="m-1"
        (click)="matomo.trackEvent('FOOTER', 'Footer_Logo_DGCS', 'null', 1)"
        href="https://www.gouvernement.fr/le-ministere-des-solidarites-et-de-la-sante"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img
          class="ministere-logo"
          src="../assets/images/footer/logo-dgcs.png"
          alt="DGCS"
        />
      </a>
      <a
        class="m-3"
        href="https://www.gouvernement.fr/delegation-interministerielle-a-l-hebergement-et-a-l-acces-au-logement"
        target="_blank"
        rel="noopener noreferrer"
        (click)="matomo.trackEvent('FOOTER', 'Footer_Logo_DIHAL', 'null', 1)"
      >
        <img
          class="ministere-logo"
          src="../assets/images/footer/partenaire-dihal.png"
          alt="DIHAL"
        />
      </a>

      <a
        class="m-3"
        href="https://www.unccas.org"
        target="_blank"
        rel="noopener noreferrer"
        (click)="matomo.trackEvent('FOOTER', 'Footer_Logo_UNCCAS', 'null', 1)"
      >
        <img
          class="ministere-logo"
          src="../assets/images/footer/partenaire-unccas.png"
          alt="UNCCAS"
        />
      </a>
    </div>

    <div class="py-3 my-4 text-gray border-top">
      <div class="d-flex flex-wrap justify-content-center align-items-center">
        <a
          href="/assets/files/domifa_declaration-d-accessibilite.pdf"
          target="_blank"
          rel="noopener noreferrer"
          download
          >Accessibilité: non conforme
        </a>
        <span class="menu-breadcrumb">|</span>
        <a
          [routerLink]="['/mentions-legales']"
          routerLinkActive="router-link-active"
          (click)="
            matomo.trackEvent('FOOTER', 'Footer_Mentions_Légales', 'null', 1)
          "
        >
          Mentions légales
        </a>
        <span class="menu-breadcrumb">|</span>
        <a
          [routerLink]="['/cgu']"
          routerLinkActive="router-link-active"
          (click)="matomo.trackEvent('FOOTER', 'Footer_CGU', 'null', 1)"
        >
          CGU
        </a>
        <span class="menu-breadcrumb">|</span>
        <a routerLink="/confidentialite" routerLinkActive="router-link-active">
          Politique de confidentialité
        </a>
        <span class="menu-breadcrumb">|</span>
        <a
          [routerLink]="['/news']"
          routerLinkActive="router-link-active"
          (click)="matomo.trackEvent('FOOTER', 'Footer_Nouveautés', 'null', 1)"
        >
          Nouveautés
        </a>
        <span class="menu-breadcrumb">|</span>
        <a
          [routerLink]="['/stats']"
          routerLinkActive="router-link-active"
          (click)="matomo.trackEvent('FOOTER', 'Footer_Stats', 'null', 1)"
        >
          Statistiques
        </a>
        <span class="menu-breadcrumb">|</span>
        <a
          [routerLink]="['/stats/impact']"
          routerLinkActive="router-link-active"
          (click)="matomo.trackEvent('FOOTER', 'Footer_Impact', 'null', 1)"
        >
          Notre impact
        </a>
        <span class="menu-breadcrumb">|</span>
        <a
          [routerLink]="['/faq']"
          routerLinkActive="router-link-active"
          (click)="matomo.trackEvent('FOOTER', 'Footer_Faq', 'null', 1)"
        >
          Foire aux questions
        </a>
        <span class="menu-breadcrumb">|</span>
        <a
          [routerLink]="['/contact']"
          routerLinkActive="router-link-active"
          (click)="matomo.trackEvent('FOOTER', 'Footer_Contact', 'null', 1)"
        >
          Contactez-nous
        </a>
        <span class="menu-breadcrumb">|</span>
        <a
          routerLink="/plan-site"
          routerLinkActive="router-link-active"
          (click)="matomo.trackEvent('FOOTER', 'Footer_Contact', 'null', 1)"
        >
          Plan du site
        </a>
      </div>
      <div class="my-4 text-gray">
        Sauf mention contraire, tous les textes de ce site sont sous
        <a
          href="https://github.com/etalab/licence-ouverte/blob/master/LO.md"
          target="_blank"
          rel="noopener noreferrer"
          >licence etalab-2.0
          <fa-icon
            class="ms-2"
            [icon]="['fas', 'arrow-up-right-from-square']"
            aria-hidden="true"
          ></fa-icon
        ></a>
      </div>
    </div>
  </div>
</footer>

<ng-template #acceptTermsModal let-modal>
  <div class="modal-header">
    <span class="modal-title" id="modal-title">
      Veuillez lire et accepter les CGU
    </span>
  </div>
  <form [formGroup]="acceptTermsForm">
    <div class="modal-body py-4">
      <p>
        Les conditions générales d'utilisation de DomiFa évoluent. <br />Afin de
        pouvoir continuer à l'utiliser, merci de lire et accepter les nouvelles
        CGU
      </p>
      <div id="cgu-modal" *ngIf="me">
        <app-cgu-responsable
          *ngIf="
            me.role === 'admin' && !me.structure.acceptTerms;
            else elseBlock
          "
        ></app-cgu-responsable>
        <ng-template #elseBlock> <app-cgu></app-cgu></ng-template>
      </div>
      <div class="row">
        <div class="col-md-12 required">
          <input
            type="checkbox"
            formControlName="readCgu"
            class="form-check-input me-2"
            [ngClass]="{
              'is-invalid': submitted && f.readCgu?.errors
            }"
            id="readCgu"
            required
          />
          <label class="form-check-label" for="readCgu"
            >Je confirme avoir lu les conditions générales d’utilisation
          </label>
          <p *ngIf="submitted && f.readCgu?.errors" class="invalid-feedback">
            La lecture des CGU est obligatoire
          </p>
        </div>
        <div class="col-md-12 required">
          <input
            type="checkbox"
            formControlName="acceptCgu"
            class="form-check-input me-2"
            [ngClass]="{
              'is-invalid': submitted && f.acceptCgu?.errors
            }"
            id="acceptCgu"
            required
          />
          <label class="form-check-label" for="acceptCgu"
            >J'accepte les conditions générales d’utilisation
          </label>
          <p *ngIf="submitted && f.acceptCgu?.errors" class="invalid-feedback">
            Vous devez accepter les CGU afin de poursuivre l'inscription
          </p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button
        class="btn btn-lg btn-outline-primary"
        type="button"
        (click)="logout()"
      >
        Se déconnecter
      </button>
      <button
        class="btn btn-lg btn-primary"
        type="submit"
        (click)="submitAcceptTerms()"
      >
        <span *ngIf="!loading"> Enregistrer </span>
        <span *ngIf="loading"
          ><fa-icon [icon]="['fas', 'circle-notch']" [spin]="true"> </fa-icon>
          Enregistrement en cours...</span
        >
      </button>
    </div>
  </form>
</ng-template>

<ng-template #versionModal let-modal>
  <div class="modal-header">
    <span class="modal-title" id="modal-title">
      ℹ️ Une nouvelle version de DomiFa est disponible
    </span>
  </div>

  <div class="modal-body text-center py-2">
    <p>
      Afin de profiter des nouveautés de DomiFa, vous devez actualiser la
      page.<br />
      La page sera automatiquement actualisée dans 10 secondes.
    </p>
  </div>
  <div class="modal-footer">
    <button class="btn btn-lg btn-primary" type="submit" (click)="refresh()">
      <fa-icon aria-hidden="true" [icon]="['fas', 'sync']"></fa-icon> Actualiser
      la page
    </button>
  </div>
</ng-template>

<ng-template #helpCenter let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-title">Centre d'aide DomiFa</h4>
    <button
      class="btn-close"
      type="button"
      aria-label="Fermer la fenêtre"
      (click)="closeModals()"
    ></button>
  </div>
  <div class="modal-body text-center">
    <h4>Notre guide d'utilisateur peut vous accompagner</h4>
    <p>
      <a
        href="/assets/files/guide_utilisateur_domifa.pdf"
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-primary"
        download
      >
        <fa-icon [icon]="['fas', 'download']"></fa-icon>
        Télécharger notre guide utilisateur
      </a>
    </p>
    <h4>Vous vous posez une question ?</h4>
    <p>
      <a
        [routerLink]="['/faq']"
        (click)="closeModals()"
        class="btn btn-primary"
        routerLinkActive="router-link-active"
      >
        Consultez notre FAQ
      </a>
      <br />
      <br />
      <a
        [routerLink]="['/contact']"
        (click)="closeModals()"
        class="btn btn-primary"
        routerLinkActive="router-link-active"
      >
        Contactez-nous via notre formulaire de contact</a
      >
    </p>
  </div>
</ng-template>

<ng-template #newsModal let-modal>
  <div class="modal-header">
    <span class="modal-title" id="modal-title">
      🎉 Des nouveautés sont disponibles sur la plateforme
    </span>
    <button
      title="Fermer la fenêtre"
      class="btn-close"
      type="button"
      aria-label="Fermer la fenêtre"
      (click)="hideNews()"
    ></button>
  </div>
  <div class="modal-body">
    <div class="py-1 px-3">
      <p>
        <strong class="text-primary">
          Mise à jour du {{ news.date | date : "dd/MM/yyyy" }}</strong
        >
        <span *ngIf="news.description">- {{ news.description }}</span>
      </p>
      <ng-container *ngIf="news?.content">
        <div *ngFor="let content of news.content" class="text-start news">
          <span
            class="badge badge-pill"
            [ngClass]="{
              'bg-primary': content.type === 'new',
              'bg-warning': content.type === 'bug'
            }"
          >
            {{ content?.type === "bug" ? "Améliorations" : "Nouveauté" }}
          </span>
          &nbsp;
          <strong>{{ content.categorie }}</strong>
          <ul class="my-2">
            <li
              *ngFor="let message of content.message"
              [innerHTML]="message | nl2br"
            ></li>
          </ul>
        </div>
      </ng-container>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-primary btn-lg" (click)="hideNews()" type="submit">
      Continuer sur DomiFa
    </button>
  </div>
</ng-template>
