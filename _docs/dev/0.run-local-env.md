# Installation Backend + PostgreSQL

## ðŸŽ¯ Objectif

DÃ©marrer un environnement de dÃ©veloppement avec PostgreSQL en Docker et le backend DomiFa.

## ðŸ³ Modes de dÃ©veloppement

### Mode hybride (recommandÃ©)

PostgreSQL en Docker + Backend en local avec yarn workspaces - permet un meilleur contrÃ´le du dÃ©veloppement.

### Mode Docker complet

Tous les services dans Docker - utile pour la reproductibilitÃ© mais moins flexible pour le dÃ©veloppement.

## âš™ï¸ Configuration des variables d'environnement

### Fichiers requis (obligatoires)

```bash
# 1. Configuration racine
cp .env.dev.example.env .env

# 2. Configuration backend
cp packages/backend/.env.backend.dev.example.env packages/backend/.env

# 3. Configuration tests (optionnel)
cp packages/backend/.env.backend.test.local.example.env packages/backend/.env.backend.test.local.env
```

### Configuration de la connexion PostgreSQL

**Mode Docker complet** (Backend aussi en Docker) :

```env
# Dans packages/backend/.env
POSTGRES_HOST=postgres
# OU utiliser le preset
DOMIFA_ENV_PRESET=local-dev-docker.preset.env
```

**Mode hybride** (Backend en local, PostgreSQL en Docker) :

```env
# Dans packages/backend/.env
POSTGRES_HOST=localhost
# OU utiliser le preset
DOMIFA_ENV_PRESET=local-dev.preset.env
```

## ðŸ—ï¸ Build des dÃ©pendances communes

**âš ï¸ Ã‰TAPE OBLIGATOIRE** - Le package `@domifa/common` doit Ãªtre compilÃ© avant de dÃ©marrer les autres projets :

```bash
# Ã€ la racine du projet
yarn workspace @domifa/common build

# OU avec l'alias (voir section Alias)
domcom build
```

## ðŸ³ Lancement de l'environnement Docker

### DÃ©marrage des services

```bash
# PostgreSQL uniquement (recommandÃ© avec yarn workspaces)
./docker-compose.local.run.sh

# PostgreSQL + Backend en Docker (mode conteneurisÃ©)
./docker-compose.local.run.sh --with-dev-containers
```

### Gestion des containers

```bash
# ArrÃªter les services
./docker-compose.local.run.sh --stop

# Supprimer les containers
./docker-compose.local.run.sh --stop --remove

# Reset complet (âš ï¸ SUPPRIME TOUTES LES DONNÃ‰ES DOMIFA)
./docker-compose.local.run.sh --stop --remove --drop-domifa-volumes
```

## ðŸ—„ï¸ Base de donnÃ©es PostgreSQL

### Initialisation automatique

Les bases de donnÃ©es sont crÃ©Ã©es automatiquement au premier dÃ©marrage avec des donnÃ©es de test.

> ðŸ“– Voir [./2.databases-dumps.md](./2.databases-dumps.md) pour plus de dÃ©tails

### VÃ©rification

```bash
# VÃ©rifier que PostgreSQL fonctionne
docker ps | grep postgres
docker logs domifa-postgres
```

## ðŸš€ DÃ©marrage du Backend

### Mode hybride avec yarn workspaces (recommandÃ©)

```bash
# Ã€ la racine du projet - dÃ©marre le backend via workspace
yarn workspace @domifa/backend start:dev

# OU directement dans le dossier backend
cd packages/backend
yarn start:dev

# OU avec l'alias (voir section Alias)
back start:dev
```

### Mode Docker complet

````bash
# Entrer dans le container backend
docker exec -it domifa-backend bash

# Dans le container
yarn start:dev


## ðŸŽ¯ Pourquoi des hooks Git ?

- **lint-staged** : Formatage et linting automatique des fichiers modifiÃ©s
- **node-talisman** : DÃ©tection de secrets/credentials avant commit
- **lerna** : Gestion du monorepo et des workspaces

### ðŸ”§ Installation

```bash
# Lerna
npx lerna --version || yarn add lerna --dev

# Husky
npx husky install
````

### âœ… VÃ©rification de l'installation

```bash
ls -la .husky/
# Doit afficher : pre-commit, commit-msg
npx lerna --version
# Doit afficher la version installÃ©e
```

## ðŸ”§ Alias Zsh pour un dÃ©veloppement plus rapide

Ajoutez ces alias dans votre `~/.zshrc` pour accÃ©lÃ©rer vos commandes :

```bash
# Alias pour les workspaces DomiFa

alias front='yarn workspace @domifa/frontend'
alias back='yarn workspace @domifa/backend'
alias portail='yarn workspace @domifa/portail-usagers'
alias admin='yarn workspace @domifa/portail-admins'
alias domcom='yarn workspace @domifa/common'

```

**Exemples d'utilisation :**

```bash
# Build le package common
domcom build

# DÃ©marrer le backend
back start:dev

# DÃ©marrer le frontend
front start

# Lancer les tests backend
back test
```

## ðŸ”§ Commandes utiles

```bash
# Voir les logs PostgreSQL
docker logs domifa-postgres -f

# Voir les logs Backend (si en Docker)
docker logs domifa-backend -f

# Reset uniquement la base de donnÃ©es
docker volume rm domifa_postgres_data

# Migrations manuelles
yarn workspace @domifa/backend db:dev:migrate-up
yarn workspace @domifa/backend db:dev:create -- NomDeLaMigration
```

## ðŸš¨ DÃ©pannage

### PostgreSQL ne dÃ©marre pas

```bash
# VÃ©rifier les logs
docker logs domifa-postgres

# VÃ©rifier l'espace disque
df -h

# Nettoyer les volumes orphelins
docker volume prune
```

### Backend ne se connecte pas Ã  PostgreSQL

```bash
# VÃ©rifier la configuration
cat packages/backend/.env | grep POSTGRES

# VÃ©rifier que PostgreSQL accepte les connexions
telnet localhost 5432
```

### Port 3000 dÃ©jÃ  utilisÃ©

```bash
# Identifier le processus
lsof -i :3000
kill -9 <PID>
```

### Modules manquants

```bash
# RÃ©installer les dÃ©pendances backend
cd packages/backend
yarn install
```

### Erreur de build du package common

```bash
# Nettoyer et rebuilder
yarn workspace @domifa/common clean
yarn workspace @domifa/common build
```

## ðŸŽ¯ RÃ©sultat attendu

Ã€ la fin de cette installation, vous devez avoir :

- âœ… Package `@domifa/common` compilÃ©
- âœ… PostgreSQL accessible sur `localhost:5432`
- âœ… Backend API accessible sur `http://localhost:3000`
