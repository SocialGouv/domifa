# Tests

## Tests backend en local avec docker

### Tests unitaires backend

Exécution des tests unitaires du backend en local avec docker

__Pré-requis__: mise en  place de l'environnement de dev local: [./00.run-local-env.md](./00.run-local-env.md)

Lancer l'environnement de dev:

```bash
./docker-compose.local.run.sh
```

Restaurer les dumps de test:

```bash
# sur les bases 'domifa_test'
_scripts/db/restore-databases-docker.sh --db=test
```

Préparer l'environnement:

```bash
# exécuter la dernière migration dans le container docker du backend
docker exec domifa-backend bash -c "yarn db:dev:migrate-up"
```

Exécuter les tests unitaires:

```bash
# tous les tests
docker exec domifa-backend bash -c "yarn test"

# ou bien exécuter un fichier de test spécifique en mode watch:
docker exec domifa-backend bash -c "NODE_ENV=tests-local npx jest --watch -- cron-mails-repository.service.spec.ts"
```

### Tests e2e backend

Restaurer les bases de test:

```bash
_scripts/db/restore-databases-docker.sh --db=test
```

Démarrer le backend de test (les éventuelles migrations vont être appliquées au démarrage du serveur):

```bash
# entrer dans le container docker du backend
docker exec -it domifa-backend bash
# démarrer le backend (branché sur les bases de test)
yarn start:tests-local
```

Démarrer le frontend:

```bash
# entrer dans le container docker du frontend
docker exec -it domifa-frontend bash
# démarrer le frontend
yarn start
```

Exécuter les tests e2e:

```bash
cd optional/e2e/runners/puppeteer
yarn test:debug
```

## Mettre à jour la base de données de test suite à une migration

Avant tout, rebaser sa branche sur la dernière version de master et être sûr que personne d'autre ne met à jour le dump sur sa branche:

```bash
git fetch origin && git rebase origin/master
```

Installer la dernière version des dumps:

```bash
# _scripts/db
_scripts/db/restore-databases-docker.sh --db=test
```

Appliquer les migrations:

```bash
# packages/backend
docker exec domifa-backend bash -c 'yarn db:test:migrate-up'
```

Exporter les nouveaux dumps:

```bash
# _scripts/db
_scripts/db/make-dump-databases-docker.sh --db=test
```

Relancer les tests pour vérifier.
