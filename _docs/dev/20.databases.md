# MongoDB Database dump & restore

## Restaurer les bases de données (mongo + postgres)

Pour restaurer les dumps de test:

```bash
# sur les bases 'domifa_test'
_scripts/db/restore-databases-docker.sh --db=test # implicite: --dump=test
# sur les bases 'domifa_dev'
_scripts/db/restore-databases-docker.sh --db=dev --dump=test
```

Pour restaurer les dumps de dev (issus de la preprod), d'abord copier les dumps depuis la préprod:

```bash
MONGO_DUMP_FROM=/mnt/database/backup-2020-11/backup-2020-11-24-11-24/mongo_mongodump-2020-11-24-11-24.gzip
MONGO_DUMP_TARGET=./_scripts/db/dumps/domifa_dev.mongo.gz
# remplacer domifa-PROD par l'ip du serveur
scp domifa-preprod:${MONGO_DUMP_FROM} ${MONGO_DUMP_TARGET}

POSTGRES_DUMP_FROM=mnt/database/backup-2020-11/backup-2020-11-24-11-24/postgres.pg_dump-2020-11-24-11-24.tar
POSTGRES_DUMP_TARGET=./_scripts/db/dumps/domifa_dev.postgres.dump
# remplacer domifa-PROD par l'ip du serveur
scp domifa-preprod:${POSTGRES_DUMP_FROM} ${POSTGRES_DUMP_TARGET}
```

```bash
# restauration sur les bases 'domifa_dev'
_scripts/db/restore-databases-docker.sh --db=dev --dump=dev
```

Ensuite, lancer le script d'anonymisation de la base (voir ci-dessous).

## Anonymisation

Pour anonymiser la base de données de dev:

```bash
# packages/backend
docker exec domifa-backend bash -c 'yarn db:dev:data-anonymize'
```

## Création de dumps (mongo + postgres)

Pour créer les dumps:

```bash
# sur les bases 'domifa_test'
_scripts/db/make-dump-databases-docker.sh --db=test # implicite: --dump=test
# sur les bases 'domifa_dev'
_scripts/db/make-dump-databases-docker.sh --db=dev # implicite: --dump=dev
```
