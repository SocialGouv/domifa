# ğŸ§ª Tests

## Tests backend en local avec docker

### Tests unitaires backend ğŸ³

ExÃ©cution des tests unitaires du backend en local avec docker

**PrÃ©-requis**: mise en place de l'environnement de dev local: [./0.run-local-env.md](./0.run-local-env.md)

#### ğŸš€ Lancer l'environnement

```bash
./docker-compose.local.run.sh
```

#### ğŸ—„ï¸ Restaurer les dumps de test

```bash
# Sur les bases 'domifa_test'
_scripts/db/restore-database-docker.sh --db=test
```

#### âš™ï¸ PrÃ©parer l'environnement

```bash
# /app/packages/backend
yarn db:test:migrate-up # exÃ©cuter les migrations en attente sur la bdd de test
```

#### â–¶ï¸ ExÃ©cuter les tests unitaires

```bash
# /app/packages/backend

yarn test # tous les tests

# ou bien exÃ©cuter un fichier de test spÃ©cifique en mode watch:
ENV_FILE=tests-local npx jest --watch -- cron-mails-repository.service.spec.ts
```

#### ğŸ”’ Tests de sÃ©curitÃ©

Des tests spÃ©ciaux de sÃ©curitÃ© sont exÃ©cutÃ©s via les fichiers `app-controllers.*.spec.ts`.
Pour n'exÃ©cuter que certains tests de sÃ©curitÃ©, renseigner la variable d'environnement DOMIFA_FILTER_SEC_TEST, exemple:

```bash
# seulement le test contenant "AgendaController.getAll", pour tous les profils
DOMIFA_FILTER_SEC_TEST="AgendaController.getAll" ENV_FILE=tests-local npx jest -- app-controllers.*.spec.ts

# seulement les tests contenant "AgendaController", juste pour le profil super-admin
DOMIFA_FILTER_SEC_TEST=Agenda ENV_FILE=tests-local npx jest -- app-controllers.super-admin-domifa.spec.ts
```

Note: il est aussi possible de filtrer par tags: <https://codecept.io/advanced/#tags>

## ğŸ” Comptes de test

### ğŸ‘¥ Utilisateurs "structure"

**Structure 1**

- ğŸ”‘ login: `preprod.domifa@fabrique.social.gouv.fr`
- ğŸ—ï¸ password: `Azerty012345!`

- ğŸ”‘ login: `s1-instructeur@yopmail.com`
- ğŸ—ï¸ password: `Azerty012345!`

- ğŸ”‘ login: `s1-gestionnaire@yopmail.com`
- ğŸ—ï¸ password: `Azerty012345!`

- ğŸ”‘ login: `s1-facteur@yopmail.com`
- ğŸ—ï¸ password: `Azerty012345!`

**Structure 3**

- ğŸ”‘ login: `s3-admin@yopmail.com`
- ğŸ—ï¸ password: `Azerty012345!`

- ğŸ”‘ login: `s3-instructeur@yopmail.com`
- ğŸ—ï¸ password: `Azerty012345!`

- ğŸ”‘ login: `s3-gestionnaire@yopmail.com`
- ğŸ—ï¸ password: `Azerty012345!`

- ğŸ”‘ login: `s3-facteur@yopmail.com`
- ğŸ—ï¸ password: `Azerty012345!`

**Structure 4**

- ğŸ”‘ login: `s4-admin@yopmail.com`
- ğŸ—ï¸ password: `Azerty012345`

Voir dÃ©finition complÃ¨te dans le fichier [TESTS_USERS_STRUCTURE.type.ts](../../packages/backend/src/_tests/_core/constants/TESTS_USERS_STRUCTURE.mock.ts)

### ğŸ‘¤ Utilisateurs "usager"

- ğŸ†” login: `WKYJBDXS`
- ğŸ—ï¸ password: `63635285`

Voir dÃ©finition complÃ¨te dans le fichier [TESTS_USERS_USAGER.type.ts](../../packages/backend/src/_tests/_core/TESTS_USERS_USAGER.type.ts)

### ğŸ›¡ï¸ Utilisateur "admin"

**Administrateur**

- ğŸ”‘ login: `preprod.domifa@fabrique.social.gouv.fr`
- ğŸ—ï¸ password: `Azerty012345`

## ğŸ”„ Mettre Ã  jour les donnÃ©es de test

#### ğŸ“¥ Installer la derniÃ¨re version des dumps

```bash
# sur les bases 'domifa_test'
_scripts/db/restore-database-docker.sh --db=test
```

#### ğŸŒ DÃ©marrer l'application sur la base de test

```bash
yarn start:tests-local
```

Utiliser l'application normalement via le navigateur, et faire les modifications souhaitÃ©es.

#### ğŸ’¾ Mettre Ã  jour les dumps avec des modifications

```bash
_scripts/db/make-dump-database-docker.sh --db=test
_scripts/db/update_test_dumps.sh
```

#### âœ… Relancer les tests pour vÃ©rifier

```bash
yarn test
```
