# Synchro des données prod => preprod

Cette synchronisation ne synchronise que la base, pas les fichiers uploadés.

Sur la prod, effectuer un backup, ou bien restaurer un ancien backup.

```bash
# /home/factory/domifa
./backup.sh
```

Récupérer les fichiers en local:

```bash
MONGO_DUMP_FROM=/mnt/database/backup-2021-01/backup-2021-01-18-14-43/mongo_mongodump-2021-01-18-14-43.gzip
MONGO_DUMP_TO=/var/tmp/domifa_PROD.mongo.gz

# remplacer domifa-PROD par l'ip du serveur

scp domifa-PROD:${MONGO_DUMP_FROM} ${MONGO_DUMP_TO}

POSTGRES_DUMP_FROM=/mnt/database/backup-2021-01/backup-2021-01-18-14-43/postgres.pg_dump-2021-01-18-14-43.custom.gz
POSTGRES_DUMP_TO=/var/tmp/domifa_PROD.postgres.custom.gz

# remplacer domifa-PROD par l'ip du serveur

scp domifa-PROD:${POSTGRES_DUMP_FROM} ${POSTGRES_DUMP_TO}
```

Puis les envoyer sur la préprod:

```bash
REMOTE=domifa-preprod # remplacer par l'alias ou l'ip du serveur

MONGO_DUMP_FROM=/var/tmp/domifa_PROD.mongo.gz
scp ${MONGO_DUMP_FROM} ${REMOTE}:/mnt/database/transfer

POSTGRES_DUMP_FROM=/var/tmp/domifa_PROD.postgres.custom.gz
scp ${POSTGRES_DUMP_FROM} ${REMOTE}:/mnt/database/transfer
```

Entrer dans le dossier du projet:

```bash
# entrer dans le dossier formation
cd ~/domifa/formation

# ou bien entrer dans le dossier preprod
cd ~/domifa/preprod
```

Exécuter le script de restauration des dumps sur le serveur `formation` ou `preprod`

```bash
# restore databases
./_dist_restore-dist-dump-from-prod-transfer.sh
```

**IMPORTANT**: désactiver l'envoi de mail avant de redémarrer le backend

Redémarrer pour appliquer les migrations

```bash
# DOCKER_COMPOSE_PROJECT_NAME=preprod
# DOCKER_COMPOSE_PROJECT_NAME=formation
sudo docker start ${DOCKER_COMPOSE_PROJECT_NAME}_backend_1
# attendre que le backend soit démarré:
sudo docker logs --tail 200 -f ${DOCKER_COMPOSE_PROJECT_NAME}_backend_1
```

Enfin, anonymiser la base de données de dev:

```bash
# packages/backend
# DOCKER_COMPOSE_PROJECT_NAME=preprod
# DOCKER_COMPOSE_PROJECT_NAME=formation
docker exec ${DOCKER_COMPOSE_PROJECT_NAME}_backend_1 bash -c 'yarn db:prod:data-anonymize'
```

**IMPORTANT**: réactiver l'envoi de mail avant de redémarrer le backend

Enfin, redémarrer le serveur ou redéployer:

```bash
# DOCKER_COMPOSE_PROJECT_NAME=preprod
# DOCKER_COMPOSE_PROJECT_NAME=formation
docker start ${DOCKER_COMPOSE_PROJECT_NAME}_backend_1 ${DOCKER_COMPOSE_PROJECT_NAME}_frontend_1
```
