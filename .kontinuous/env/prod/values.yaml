global:
  pgSecretName: pg-app

jobs:
  runs:
    build-backend:
      with:
        buildArgs:
          DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
          DOMIFA_PORTAIL_ADMINS_URL: "https://admin-{{ .Values.global.host }}/"
          DOMIFA_PORTAIL_USAGERS_URL: "https://mon-{{ .Values.global.host }}/"

    build-frontend:
      with:
        buildArgs:
          DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
          DOMIFA_FRONTEND_META_ROBOTS: index,follow

    build-portail-admins:
      with:
        buildArgs:
          DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
          PRODUCTION: "true"

    build-portail-usagers:
      with:
        buildArgs:
          DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
          PRODUCTION: "true"
          DOMIFA_FRONTEND_META_ROBOTS: index,follow

pg:
  cnpg-cluster:
    persistence:
      size: "30Gi"
    resources:
      requests:
        memory: 3Gi
      limits:
        memory: 3Gi

backend-cron:
  replicas: 1
  addVolumes:
    - files
  resources:
    requests:
      cpu: 0.2
      memory: 256Mi
    limits:
      cpu: 1
      memory: 1Gi
  envFrom:
    - secretRef:
        name: "{{ .Values.global.pgSecretName }}"
    - secretRef:
        name: backend-sealed-secret
    - configMapRef:
        name: backend-configmap
    - secretRef:
        name: azure-domifa-volume
    - secretRef:
        name: domifa-encryption-key
  env:
    - name: TZ
      value: Europe/Paris
    - name: DOMIFA_ENV_ID
      value: "prod"
    - name: POSTGRES_HOST
      value: "$(PGHOST)"
    - name: POSTGRES_USERNAME
      value: "$(PGUSER)"
    - name: POSTGRES_PASSWORD
      value: "$(PGPASSWORD)"
    - name: POSTGRES_DATABASE
      value: "$(PGDATABASE)"
    - name: DOMIFA_BACKEND_URL
      value: "https://domifa-api.{{ .Values.global.domain }}/"
    - name: DOMIFA_FRONTEND_URL
      value: "https://{{ .Values.global.host }}/"
    - name: DOMIFA_PORTAIL_USAGERS_URL
      value: "https://mon-{{ .Values.global.host }}/"
    - name: DOMIFA_PORTAIL_ADMINS_URL
      value: "https://admin-{{ .Values.global.host }}/"
    - name: DOMIFA_CRON_ENABLED
      value: "true"

backend:
  host: "domifa-api.{{ .Values.global.domain }}"
  autoscale:
    minReplicas: 3
    maxReplicas: 8
    enabled: true
  resources:
    requests:
      cpu: 1
      memory: 1Gi
    limits: # exports need a lot of CPU/RAM ATM
      cpu: 3
      memory: 3Gi
  certSecretName: backend-crt
  addVolumes:
    - files
  envFrom:
    - secretRef:
        name: "{{ .Values.global.pgSecretName }}"
    - secretRef:
        name: backend-sealed-secret
    - configMapRef:
        name: backend-configmap
    - secretRef:
        name: azure-domifa-volume
    - secretRef:
        name: domifa-encryption-key
  env:
    - name: TZ
      value: Europe/Paris
    - name: DOMIFA_ENV_ID
      value: "prod"
    - name: POSTGRES_HOST
      value: "$(PGHOST)"
    - name: POSTGRES_USERNAME
      value: "$(PGUSER)"
    - name: POSTGRES_PASSWORD
      value: "$(PGPASSWORD)"
    - name: POSTGRES_DATABASE
      value: "$(PGDATABASE)"
    - name: DOMIFA_BACKEND_URL
      value: "https://domifa-api.{{ .Values.global.domain }}/"
    - name: DOMIFA_FRONTEND_URL
      value: "https://{{ .Values.global.host }}/"
    - name: DOMIFA_PORTAIL_USAGERS_URL
      value: "https://mon-{{ .Values.global.host }}/"
    - name: DOMIFA_PORTAIL_ADMINS_URL
      value: "https://admin-{{ .Values.global.host }}/"
    - name: DOMIFA_CRON_ENABLED
      value: "false"
    - name: NODE_OPTIONS
      value: "--max-old-space-size=2048"

frontend:
  replicas: 1
  host: "{{ .Values.global.host }}"
  certSecretName: frontend-crt

portail-admins:
  replicas: 1
  host: "admin-{{ .Values.global.host }}"
  certSecretName: portail-admins-crt

portail-usagers:
  replicas: 1
  host: "mon-{{ .Values.global.host }}"
  certSecretName: portail-usagers-crt
