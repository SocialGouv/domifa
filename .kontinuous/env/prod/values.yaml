jobs:
  runs:
    build-backend:
      with:
        buildArgs:
          DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
          DOMIFA_PORTAIL_ADMINS_URL: "https://admin-{{ .Values.global.host }}/"
          DOMIFA_PORTAIL_USAGERS_URL: "https://mon-{{ .Values.global.host }}/"

    build-frontend:
      with:
        buildArgs:
          DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
          DOMIFA_FRONTEND_META_ROBOTS: index,follow

    build-portail-admins:
      with:
        buildArgs:
          DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
          PRODUCTION: "true"

    build-portail-usagers:
      with:
        buildArgs:
          DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
          PRODUCTION: "true"
          DOMIFA_FRONTEND_META_ROBOTS: index,follow

backend-cron:
  ~needs: [build-backend]
  replicas: 1
  resources:
    requests:
      cpu: 1
      memory: 1Gi
    limits: # exports need a lot of CPU/RAM ATM
      cpu: 3
      memory: 3Gi
  envFrom:
    - secretRef:
        name: "{{ .Values.global.pgSecretName }}"
    - secretRef:
        name: backend-sealed-secret
    - configMapRef:
        name: backend-configmap
    - secretRef:
        name: domifa-encryption-key
  vars: &backendVars
    DOMIFA_ENV_ID: "prod"
    DOMIFA_BACKEND_URL: "https://domifa-api.{{ .Values.global.domain }}/"
    DOMIFA_FRONTEND_URL: "https://{{ .Values.global.host }}/"
    DOMIFA_PORTAIL_USAGERS_URL: "https://mon-{{ .Values.global.host }}/"
    DOMIFA_PORTAIL_ADMINS_URL: "https://admin-{{ .Values.global.host }}/"
  env: &backendEnv
    - name: S3_BUCKET_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: domifa-prod-app-access-key
          key: bucket_endpoint
    - name: S3_BUCKET_NAME
      valueFrom:
        secretKeyRef:
          name: domifa-prod-app-access-key
          key: bucket_name
    - name: S3_BUCKET_REGION
      valueFrom:
        secretKeyRef:
          name: domifa-prod-app-access-key
          key: bucket_region
    - name: S3_BUCKET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: domifa-prod-app-access-key
          key: bucket_access_key
    - name: S3_BUCKET_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: domifa-prod-app-access-key
          key: bucket_secret_key
    - name: S3_BUCKET_ROOT_DIR
      value: backup/files

backend: &backendProd
  ~needs: [build-backend]
  host: "domifa-api.{{ .Values.global.domain }}"
  resources:
    requests:
      cpu: 1
      memory: 1.5Gi
    limits: # exports need a lot of CPU/RAM ATM
      cpu: 1.5
      memory: 2Gi
  autoscale:
    enabled: true
  certSecretName: backend-crt
  envFrom:
    - secretRef:
        name: "{{ .Values.global.pgSecretName }}"
    - secretRef:
        name: backend-sealed-secret
    - configMapRef:
        name: backend-configmap
    - secretRef:
        name: domifa-encryption-key
  vars:
    <<: *backendVars
  env: *backendEnv

backend-export:
  ~needs: [build-backend]
  host: "domifa-api.{{ .Values.global.domain }}"
  resources:
    requests:
      cpu: 1
      memory: 768i
    limits: # exports need a lot of CPU/RAM ATM
      cpu: 1
      memory: 1Gi
    autoscale:
    enabled: true
  certSecretName: backend-crt
  envFrom:
    - secretRef:
        name: "{{ .Values.global.pgSecretName }}"
    - secretRef:
        name: backend-sealed-secret
    - configMapRef:
        name: backend-configmap
    - secretRef:
        name: domifa-encryption-key
  vars:
    <<: *backendVars
  env: *backendEnv
  ingress:
    paths:
      - /export
      - /admin/structures/export
      - /stats
      - /stats/home

frontend:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 256Mi
  autoscale:
    enabled: true
  host: "{{ .Values.global.host }}"
  certSecretName: frontend-crt

portail-admins:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  autoscale:
    enabled: true
  host: "admin-{{ .Values.global.host }}"
  certSecretName: portail-admins-crt

portail-usagers:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  autoscale:
    enabled: true
  host: "mon-{{ .Values.global.host }}"
  certSecretName: portail-usagers-crt
