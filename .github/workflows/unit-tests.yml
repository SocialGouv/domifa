name: Unit Tests

on: [pull_request]

jobs:

  backend:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Set up Node.js v14
      uses: actions/setup-node@v2
      with:
        node-version: '14'
    - name: Set up Yarn cache
      uses: c-hive/gha-yarn-cache@v1
    - name: Create backend .env file
      run: cp ./packages/backend/.env.backend.test.local.example.env ./packages/backend/.env
    - name: Install backend dependencies
      run: yarn workspace @domifa/backend install --frozen-lockfile --prefer-offline
    - name: Create Postgres service
      run: docker-compose -f ./docker-compose.tests.yml up --build --detach
    - name: Run backend tests
      run: yarn workspace @domifa/backend jest --coverage --detectOpenHandles --forceExit --runInBand

  front-end:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Set up Node.js v14
      uses: actions/setup-node@v2
      with:
        node-version: '14'
    - name: Set up Yarn cache
      uses: c-hive/gha-yarn-cache@v1
    - name: Install front-end dependencies
      run: yarn workspace @domifa/frontend install --frozen-lockfile --prefer-offline
    - name: Run front-end tests
      run: yarn workspace @domifa/frontend test --coverage --detectOpenHandles --forceExit
